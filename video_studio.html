<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎬 Video Studio - Emotion Visualizer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23667eea'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-family='Arial' font-size='16' fill='white'%3E🎬%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 6rem; /* Space for floating button */
        }
        
        .panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(0);
            font-size: 1.1rem;
            padding: 1.2rem 2rem;
            width: 100%;
            margin-top: 1.5rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            filter: brightness(110%);
        }
        
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #e0e0e0;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Floating Action Button - Always Visible */
        .floating-action-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        .floating-action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        .floating-action-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            animation: none;
        }

        /* Pulse animation for floating button */
        @keyframes pulse {
            0% {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.7);
            }
            100% {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }
        }

        /* Quick Action Bar - Sticky at bottom on mobile */
        .quick-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            border-top: 1px solid #e0e0e0;
            z-index: 999;
            display: none; /* Hidden by default, shown on mobile */
        }

        .quick-action-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .selection-summary {
            flex: 1;
            font-size: 0.9rem;
            color: #666;
        }

        .quick-generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .quick-generate-btn:hover {
            filter: brightness(110%);
            transform: translateY(-1px);
        }

        .quick-generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Better mobile CTA */
        .mobile-cta-container {
            position: sticky;
            bottom: 1rem;
            margin-top: 2rem;
            background: white;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 2px solid #667eea;
        }

        .mobile-cta-text {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f2f5;
        }
        
        .panel-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .conversations-panel {
            display: flex;
            flex-direction: column;
        }
        
        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 1rem;
        }
        
        .conversation-item {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .conversation-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
            border-color: #667eea;
        }
        
        .conversation-item.selected {
            background: #e8f0fe;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .conversation-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }
        
        .conversation-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }
        
        .conversation-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .conversation-preview {
            width: 100%;
            height: 120px;
            background: #f0f2f5;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        /* Video preview styles */
        .preview-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .preview-video:hover {
            transform: scale(1.02);
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
            backdrop-filter: blur(2px);
            border-radius: 8px;
        }

        .video-overlay.playing {
            background: rgba(0, 0, 0, 0.1);
        }

        .video-overlay.generate-prompt {
            background: rgba(102, 126, 234, 0.8);
        }

        .video-overlay.error {
            background: rgba(244, 67, 54, 0.8);
        }

        .play-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            transition: transform 0.2s ease;
        }

        .generate-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            animation: bounce 2s infinite;
        }

        .error-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .video-status {
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            padding: 0 1rem;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .video-fallback {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .video-fallback iframe {
            width: 100%;
            height: 100%;
            border: none;
            transform: scale(0.3);
            transform-origin: 0 0;
        }

        /* Bounce animation for generate prompt */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Improved hover effects */
        .conversation-item:hover .preview-video {
            transform: scale(1.05);
        }

        .conversation-item:hover .video-overlay:not(.playing) {
            background: rgba(0, 0, 0, 0.3);
        }

        .conversation-item:hover .play-icon {
            transform: scale(1.1);
        }
        
        .preview-panel {
            display: flex;
            flex-direction: column;
        }
        
        .preview-container {
            flex: 1;
            background: #f0f2f5;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }
        
        .preview-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .preview-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 1.2rem;
        }
        
        .preview-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .control-group label {
            font-weight: 600;
            color: #555;
        }
        
        .control-group input,
        .control-group select {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }
        
        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .quality-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .quality-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quality-option input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        /* Capture Mode Options */
        .capture-mode-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .capture-mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .capture-mode-option input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        .capture-mode-option label {
            margin: 0;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }
        
        .capture-mode-description {
            color: #666;
            font-style: italic;
            margin-top: 4px;
        }
        
        /* Crop Mode Options */
        .crop-mode-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .crop-mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .crop-mode-option input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .crop-mode-option label {
            margin: 0;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }
        
        .crop-mode-description {
            color: #666;
            font-style: italic;
            margin-top: 4px;
        }
        
        .generation-progress {
            margin-top: 1rem;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }
        
        .select-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .select-controls button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .video-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .video-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .video-item a {
            color: #667eea;
            text-decoration: none;
        }
        
        .video-item a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 300px 400px auto;
                margin-bottom: 8rem; /* More space for mobile actions */
            }

            .floating-action-button {
                display: none; /* Hide floating button on mobile */
            }

            .quick-action-bar {
                display: block; /* Show bottom action bar on mobile */
            }

            .controls-panel {
                position: relative;
            }

            .mobile-cta-container {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                margin-bottom: 0;
            }
            
            .main-content {
                gap: 1rem;
                margin-bottom: 6rem; /* Space for quick action bar */
            }
            
            .panel {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header p {
                font-size: 1rem;
            }

            .quick-action-content {
                padding: 0 1rem;
            }

            .floating-action-button {
                width: 60px;
                height: 60px;
                font-size: 1.2rem;
                bottom: 6rem; /* Above quick action bar */
            }
        }

        /* Desktop improvements */
        @media (min-width: 1201px) {
            .quick-action-bar {
                display: none;
            }

            .mobile-cta-container {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 Video Studio</h1>
            <p>Create beautiful MP4 videos from your emotion visualizations</p>
            <div style="margin-top: 1rem; text-align: center;">
                <a href="/video_visualization.html" target="_blank" class="btn btn-secondary"
                   style="padding: 0.5rem 1rem; font-size: 0.9rem; margin-right: 1rem;"
                   title="View All Conversations in Interactive Visualizer">
                    🎭 All Conversations Visualizer
                </a>
                <a href="/admin_panel.html" target="_blank" class="btn btn-secondary"
                   style="padding: 0.5rem 1rem; font-size: 0.9rem;"
                   title="Manage Videos and Settings">
                    ⚙️ Admin Panel
                </a>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Conversations Panel -->
            <div class="panel conversations-panel">
                <div class="panel-header">
                    <span class="panel-title">📁 Conversations</span>
                </div>
                
                <div class="select-controls">
                    <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                    <button class="btn btn-secondary" onclick="selectNone()">Select None</button>
                </div>
                
                <div class="conversation-list" id="conversationList">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="panel preview-panel">
                <div class="panel-header">
                    <span class="panel-title">👁️ Preview</span>
                    <a href="/video_visualization.html" target="_blank" class="btn btn-secondary" 
                       style="margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem;"
                       title="Open All Conversations Visualizer">
                        🎭 All Conversations
                    </a>
                </div>
                
                <div class="preview-container">
                    <div class="preview-placeholder" id="previewPlaceholder">
                        Select a conversation to preview
                    </div>
                    <iframe id="previewFrame" style="display: none;"></iframe>
                </div>
                
                <div class="preview-controls">
                    <button class="btn btn-secondary" onclick="refreshPreview()">🔄 Refresh</button>
                    <button class="btn btn-secondary" onclick="togglePreview()">▶️ Toggle Animation</button>
                </div>
            </div>
            
            <!-- Controls Panel -->
            <div class="panel controls-panel">
                <div class="panel-header">
                    <span class="panel-title">⚙️ Video Settings</span>
                </div>
                
                <div class="control-group">
                    <label>🎥 Quality</label>
                    <div class="quality-options">
                        <div class="quality-option">
                            <input type="radio" id="quality480" name="quality" value="480">
                            <label for="quality480">480p</label>
                        </div>
                        <div class="quality-option">
                            <input type="radio" id="quality720" name="quality" value="720" checked>
                            <label for="quality720">720p (Recommended)</label>
                        </div>
                        <div class="quality-option">
                            <input type="radio" id="quality1080" name="quality" value="1080">
                            <label for="quality1080">1080p</label>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label for="duration">⏱️ Duration (seconds)</label>
                    <input type="range" id="duration" min="5" max="60" value="15" oninput="updateDurationDisplay()">
                    <div class="progress-text" id="durationDisplay">15 seconds</div>
                </div>
                
                <div class="control-group">
                    <label for="fps">🎞️ Frame Rate (FPS)</label>
                    <input type="range" id="fps" min="10" max="30" value="15" oninput="updateFpsDisplay()">
                    <div class="progress-text" id="fpsDisplay">15 FPS</div>
                </div>
                
                <div class="control-group">
                    <label for="format">📼 Format</label>
                    <select id="format">
                        <option value="mp4">MP4 (Recommended)</option>
                        <option value="webm">WebM</option>
                        <option value="avi">AVI</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>🎨 Capture Mode</label>
                    <div class="capture-mode-options">
                        <div class="capture-mode-option">
                            <input type="radio" id="captureStandard" name="captureMode" value="standard" checked>
                            <label for="captureStandard">Standard (with UI)</label>
                        </div>
                        <div class="capture-mode-option">
                            <input type="radio" id="captureClean" name="captureMode" value="clean">
                            <label for="captureClean">Clean (visualization only)</label>
                        </div>
                    </div>
                    <div class="capture-mode-description">
                        <small>Clean mode captures only the visualization without any UI elements</small>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>✂️ Smart Cropping</label>
                    <div class="crop-mode-options">
                        <div class="crop-mode-option">
                            <input type="checkbox" id="smartCrop" checked>
                            <label for="smartCrop">Auto-crop to visualization content</label>
                        </div>
                    </div>
                    <div class="crop-mode-description">
                        <small>Automatically removes empty background space around the visualization</small>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="generateBtn" onclick="generateVideos()">
                    🎬 Generate Videos
                </button>
                
                <div class="generation-progress" id="generationProgress">
                    <div class="progress-text" id="progressText">Initializing...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                
                <div class="status-message" id="statusMessage"></div>
                
                <div class="video-list" id="videoList">
                    <!-- Generated videos will appear here -->
                </div>

                <!-- Mobile CTA Container - shown only on smaller screens -->
                <div class="mobile-cta-container">
                    <div class="mobile-cta-text" id="mobileCTAText">
                        Select conversations above to generate videos
                    </div>
                    <button class="btn btn-primary" onclick="generateVideos()">
                        🎬 Generate Videos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button - Always visible on desktop -->
    <button class="floating-action-button" id="floatingGenerateBtn" onclick="generateVideos()" 
            title="Generate Videos" aria-label="Generate Videos" role="button" tabindex="0">
        🎬
    </button>

    <!-- Quick Action Bar - Mobile sticky bottom bar -->
    <div class="quick-action-bar" id="quickActionBar">
        <div class="quick-action-content">
            <div class="selection-summary" id="quickSelectionSummary">
                No conversations selected
            </div>
            <button class="quick-generate-btn" onclick="generateVideos()">
                🎬 Generate
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let conversations = [];
        let selectedConversations = new Set();
        let currentPreview = null;
        let generationInProgress = false;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadConversations();
            updateDurationDisplay();
            updateFpsDisplay();
            loadExistingVideos();
            updateQuickSelectionSummary();
        });
        
        // Load available conversations
        async function loadConversations() {
            try {
                const response = await fetch('/config/conversations_config.json');
                const config = await response.json();
                conversations = Object.keys(config.conversations);
                renderConversations();
            } catch (error) {
                console.error('Error loading conversations:', error);
                showStatus('Error loading conversations', 'error');
            }
        }
        
        // Render conversations list
        function renderConversations() {
            const listContainer = document.getElementById('conversationList');
            listContainer.innerHTML = '';
            
            conversations.forEach(conversation => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.innerHTML = `
                    <div class="conversation-header">
                        <span class="conversation-title">🗣️ ${conversation}</span>
                        <input type="checkbox" class="conversation-checkbox" 
                               data-conversation="${conversation}" 
                               onchange="toggleConversation('${conversation}')">
                    </div>
                    <div class="conversation-stats">
                        <span>📊 Ready for generation</span>
                        <span>🎬 Video available</span>
                    </div>
                    <div class="conversation-preview" id="preview-${conversation}">
                        <div class="video-loading">📥 Loading preview...</div>
                    </div>
                `;
                
                // Add click handler for preview
                item.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        previewConversation(conversation);
                    }
                });
                
                listContainer.appendChild(item);
                
                // Load video preview asynchronously
                loadVideoPreview(conversation);
            });
        }

        // Load video preview for a conversation
        async function loadVideoPreview(conversation) {
            const previewContainer = document.getElementById(`preview-${conversation}`);
            const loadingDiv = previewContainer.querySelector('.video-loading');
            
            try {
                // Check if MP4 video exists
                const videoResponse = await fetch(`/videos/${conversation}.mp4`, { method: 'HEAD' });
                
                if (videoResponse.ok) {
                    // Video exists - create video element
                    const videoHtml = `
                        <video class="preview-video" 
                               data-conversation="${conversation}"
                               muted 
                               loop 
                               preload="metadata"
                               poster="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZjdmOWYzIi8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEwMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIxNDAiIHk9IjkwIiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0ibTMgMTggMTUtOUwzIDZ2MTJ6Ii8+Cjwvc3ZnPgo8L3N2Zz4K">
                            <source src="/videos/${conversation}.mp4" type="video/mp4">
                            <div class="video-fallback">
                                <iframe src="/visualization.html?folder=${conversation}&static=true&animate=false&autostart=false&noSidepanel=true&noTimeline=true&visualOnly=true&cleanCapture=true&hideUI=true&canvasOnly=true&t=${Date.now()}"
                                        loading="lazy"></iframe>
                            </div>
                        </video>
                        <div class="video-overlay">
                            <div class="play-icon">▶️</div>
                            <div class="video-status">Hover to play</div>
                        </div>
                    `;
                    
                    previewContainer.innerHTML = videoHtml;
                    
                    // Add hover functionality
                    setupVideoHover(conversation);
                    
                } else {
                    // Video doesn't exist - use iframe fallback with clean capture parameters
                    const timestamp = Date.now();
                    previewContainer.innerHTML = `
                        <iframe src="/visualization.html?folder=${conversation}&static=true&animate=false&autostart=false&noSidepanel=true&noTimeline=true&visualOnly=true&cleanCapture=true&hideUI=true&canvasOnly=true&t=${timestamp}"
                                loading="lazy"></iframe>
                        <div class="video-overlay generate-prompt">
                            <div class="generate-icon">🎬</div>
                            <div class="video-status">Generate video first</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error(`Error loading preview for ${conversation}:`, error);
                
                // Fallback to iframe with clean capture parameters
                const timestamp = Date.now();
                previewContainer.innerHTML = `
                    <iframe src="/visualization.html?folder=${conversation}&static=true&animate=false&autostart=false&noSidepanel=true&noTimeline=true&visualOnly=true&cleanCapture=true&hideUI=true&canvasOnly=true&t=${timestamp}"
                            loading="lazy"></iframe>
                `;
            }
        }

        // Setup hover functionality for video
        function setupVideoHover(conversation) {
            const previewContainer = document.getElementById(`preview-${conversation}`);
            const video = previewContainer.querySelector('.preview-video');
            const overlay = previewContainer.querySelector('.video-overlay');
            const playIcon = overlay?.querySelector('.play-icon');
            const statusText = overlay?.querySelector('.video-status');
            
            if (!video || !overlay) return;
            
            let isPlaying = false;
            
            // Mouse enter - start playing
            previewContainer.addEventListener('mouseenter', async () => {
                try {
                    if (!isPlaying) {
                        await video.play();
                        isPlaying = true;
                        
                        if (playIcon) playIcon.textContent = '⏸️';
                        if (statusText) statusText.textContent = 'Playing...';
                        overlay.classList.add('playing');
                        
                        // Hide overlay after a moment
                        setTimeout(() => {
                            overlay.style.opacity = '0';
                        }, 500);
                    }
                } catch (error) {
                    console.warn(`Could not play video for ${conversation}:`, error);
                }
            });
            
            // Mouse leave - pause video
            previewContainer.addEventListener('mouseleave', () => {
                if (isPlaying) {
                    video.pause();
                    video.currentTime = 0; // Reset to beginning
                    isPlaying = false;
                    
                    if (playIcon) playIcon.textContent = '▶️';
                    if (statusText) statusText.textContent = 'Hover to play';
                    overlay.classList.remove('playing');
                    overlay.style.opacity = '1';
                }
            });
            
            // Handle video ended event
            video.addEventListener('ended', () => {
                isPlaying = false;
                video.currentTime = 0;
                
                if (playIcon) playIcon.textContent = '▶️';
                if (statusText) statusText.textContent = 'Hover to play';
                overlay.classList.remove('playing');
                overlay.style.opacity = '1';
            });
            
            // Handle errors
            video.addEventListener('error', (e) => {
                console.error(`Video error for ${conversation}:`, e);
                
                // Show fallback message with clean capture parameters
                const timestamp = Date.now();
                previewContainer.innerHTML = `
                    <iframe src="/visualization.html?folder=${conversation}&static=true&animate=false&autostart=false&noSidepanel=true&noTimeline=true&visualOnly=true&cleanCapture=true&hideUI=true&canvasOnly=true&t=${timestamp}"
                            loading="lazy"></iframe>
                    <div class="video-overlay error">
                        <div class="error-icon">⚠️</div>
                        <div class="video-status">Video unavailable</div>
                    </div>
                `;
            });
        }
        
        // Toggle conversation selection
        function toggleConversation(conversation) {
            if (selectedConversations.has(conversation)) {
                selectedConversations.delete(conversation);
            } else {
                selectedConversations.add(conversation);
            }
            updateConversationDisplay();
            updateQuickSelectionSummary();
        }
        
        // Update conversation display
        function updateConversationDisplay() {
            const checkboxes = document.querySelectorAll('.conversation-checkbox');
            checkboxes.forEach(checkbox => {
                const conversation = checkbox.dataset.conversation;
                const item = checkbox.closest('.conversation-item');
                
                if (selectedConversations.has(conversation)) {
                    item.classList.add('selected');
                    checkbox.checked = true;
                } else {
                    item.classList.remove('selected');
                    checkbox.checked = false;
                }
            });
        }
        
        // Select all conversations
        function selectAll() {
            conversations.forEach(conversation => {
                selectedConversations.add(conversation);
            });
            updateConversationDisplay();
            updateQuickSelectionSummary();
        }
        
        // Select none
        function selectNone() {
            selectedConversations.clear();
            updateConversationDisplay();
            updateQuickSelectionSummary();
        }
        
        // Preview conversation
        function previewConversation(conversation) {
            currentPreview = conversation;
            const previewFrame = document.getElementById('previewFrame');
            const placeholder = document.getElementById('previewPlaceholder');
            
            placeholder.style.display = 'none';
            previewFrame.style.display = 'block';
            previewFrame.src = `/visualization.html?folder=${conversation}&autostart=true&animate=true&noSidepanel=true&noTimeline=true&visualOnly=true&cleanCapture=true&hideUI=true&canvasOnly=true&t=${Date.now()}`;
            
            // Highlight the conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const conversationElement = document.querySelector(`[data-conversation="${conversation}"]`);
            if (conversationElement) {
                conversationElement.closest('.conversation-item').classList.add('selected');
            }
        }
        
        // Refresh preview
        function refreshPreview() {
            if (currentPreview) {
                previewConversation(currentPreview);
            }
        }
        
        // Toggle preview animation
        function togglePreview() {
            if (currentPreview) {
                const previewFrame = document.getElementById('previewFrame');
                const currentSrc = previewFrame.src;
                
                if (currentSrc.includes('animate=true')) {
                    previewFrame.src = currentSrc.replace('animate=true', 'animate=false&static=true');
                } else {
                    previewFrame.src = currentSrc.replace('animate=false&static=true', 'animate=true').replace('animate=false', 'animate=true');
                }
            }
        }
        
        // Update duration display
        function updateDurationDisplay() {
            const duration = document.getElementById('duration').value;
            document.getElementById('durationDisplay').textContent = `${duration} seconds`;
        }
        
        // Update FPS display
        function updateFpsDisplay() {
            const fps = document.getElementById('fps').value;
            document.getElementById('fpsDisplay').textContent = `${fps} FPS`;
        }
        
        // Generate videos
        async function generateVideos() {
            if (generationInProgress) return;
            
            if (selectedConversations.size === 0) {
                showStatus('Please select at least one conversation', 'error');
                return;
            }
            
            generationInProgress = true;
            
            const generateBtn = document.getElementById('generateBtn');
            const floatingGenerateBtn = document.getElementById('floatingGenerateBtn');
            const progressContainer = document.getElementById('generationProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // Update UI
            generateBtn.disabled = true;
            floatingGenerateBtn.disabled = true;
            generateBtn.textContent = '🎬 Generating...';
            floatingGenerateBtn.title = 'Generating Videos...';
            progressContainer.style.display = 'block';
            
            // Get settings
            const quality = document.querySelector('input[name="quality"]:checked').value;
            const duration = document.getElementById('duration').value;
            const fps = document.getElementById('fps').value;
            const format = document.getElementById('format').value;
            const captureMode = document.querySelector('input[name="captureMode"]:checked').value;
            const smartCrop = document.getElementById('smartCrop').checked;
            
            const options = {
                quality: quality,
                duration: parseInt(duration),
                fps: parseInt(fps),
                format: format,
                captureMode: captureMode,
                cleanCapture: captureMode === 'clean',
                smartCrop: smartCrop,
                autoStart: true,
                loop: true,
                muted: true,
                hoverOnly: false
            };
            
            const selectedArray = Array.from(selectedConversations);
            let completed = 0;
            let successful = 0;
            
            try {
                for (const conversation of selectedArray) {
                    progressText.textContent = `Generating ${conversation}... (${completed + 1}/${selectedArray.length})`;
                    
                    try {
                        const response = await fetch('/api/generate-video', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                conversationFolder: conversation,
                                options: options
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            successful++;
                            console.log(`✅ Generated video for ${conversation}`);
                        } else {
                            console.error(`❌ Failed to generate video for ${conversation}:`, result.error);
                        }
                    } catch (error) {
                        console.error(`❌ Error generating video for ${conversation}:`, error);
                    }
                    
                    completed++;
                    const progress = (completed / selectedArray.length) * 100;
                    progressFill.style.width = `${progress}%`;
                }
                
                // Complete
                progressText.textContent = `Complete! ${successful}/${selectedArray.length} videos generated`;
                
                if (successful > 0) {
                    showStatus(`Successfully generated ${successful} videos!`, 'success');
                    loadExistingVideos();
                } else {
                    showStatus('No videos were generated successfully', 'error');
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                showStatus('Error during video generation', 'error');
            } finally {
                // Reset UI
                generateBtn.disabled = false;
                floatingGenerateBtn.disabled = false;
                generateBtn.textContent = '🎬 Generate Videos';
                floatingGenerateBtn.title = 'Generate Videos';
                generationInProgress = false;
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 3000);
            }
        }
        
        // Load existing videos
        async function loadExistingVideos() {
            try {
                const response = await fetch('/api/list-videos');
                const videos = await response.json();
                
                const videoList = document.getElementById('videoList');
                videoList.innerHTML = '';
                
                if (videos.length === 0) {
                    videoList.innerHTML = '<div class="progress-text">No videos generated yet</div>';
                    return;
                }

                videos.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';
                    videoItem.innerHTML = `
                        <a href="/videos/${video.filename}" target="_blank">
                            📹 ${video.conversationFolder}
                        </a>
                        <span>${video.fileSize}</span>
                    `;
                    videoList.appendChild(videoItem);
                });

                // Refresh video previews in conversation list
                refreshVideoPreviewsForGeneratedVideos(videos);
                
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        }

        // Refresh video previews for conversations that now have videos
        function refreshVideoPreviewsForGeneratedVideos(videos) {
            videos.forEach(video => {
                const conversation = video.conversationFolder;
                const previewContainer = document.getElementById(`preview-${conversation}`);
                
                if (previewContainer) {
                    // Only refresh if it's currently showing an iframe (not a video)
                    const hasVideo = previewContainer.querySelector('.preview-video');
                    
                    if (!hasVideo) {
                        console.log(`🔄 Refreshing preview for ${conversation} - new video available`);
                        loadVideoPreview(conversation);
                    }
                }
            });
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        // Update quick selection summary
        function updateQuickSelectionSummary() {
            const summaryElement = document.getElementById('quickSelectionSummary');
            const mobileCTAText = document.getElementById('mobileCTAText');
            const generateBtn = document.getElementById('generateBtn');
            const floatingGenerateBtn = document.getElementById('floatingGenerateBtn');
            const quickGenerateBtn = document.querySelector('.quick-generate-btn');
            
            const hasSelection = selectedConversations.size > 0;
            
            if (summaryElement) {
                if (selectedConversations.size === 0) {
                    summaryElement.textContent = 'No conversations selected';
                } else {
                    summaryElement.textContent = `${selectedConversations.size} conversation${selectedConversations.size > 1 ? 's' : ''} selected`;
                }
            }
            
            if (mobileCTAText) {
                if (selectedConversations.size === 0) {
                    mobileCTAText.textContent = 'Select conversations above to generate videos';
                } else {
                    mobileCTAText.textContent = `Ready to generate ${selectedConversations.size} video${selectedConversations.size > 1 ? 's' : ''}!`;
                }
            }

            // Enable/disable buttons based on selection
            if (generateBtn && !generationInProgress) {
                generateBtn.disabled = !hasSelection;
            }
            if (floatingGenerateBtn && !generationInProgress) {
                floatingGenerateBtn.disabled = !hasSelection;
                floatingGenerateBtn.style.opacity = hasSelection ? '1' : '0.5';
            }
            if (quickGenerateBtn && !generationInProgress) {
                quickGenerateBtn.disabled = !hasSelection;
            }
        }
        
        // Force refresh all iframe previews (for debugging)
        function forceRefreshPreviews() {
            console.log('🔄 Force refreshing all iframe previews...');
            conversations.forEach(conversation => {
                const previewContainer = document.getElementById(`preview-${conversation}`);
                if (previewContainer) {
                    const iframe = previewContainer.querySelector('iframe');
                    if (iframe) {
                        const currentSrc = iframe.src;
                        // Remove old timestamp and add new one
                        const baseUrl = currentSrc.split('&t=')[0];
                        iframe.src = `${baseUrl}&t=${Date.now()}`;
                        console.log(`🔄 Refreshed preview for ${conversation}`);
                    }
                }
            });
        }
        
        // Expose function globally for debugging
        window.forceRefreshPreviews = forceRefreshPreviews;
        
        // Auto-refresh video list every 30 seconds
        setInterval(loadExistingVideos, 30000);
    </script>
</body>
</html> 