<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversation Visualization</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  
  
  <script>
    // Single, clean workaround for iframe issues
    if (typeof self === 'undefined') {
      window.self = window;
    }
    if (typeof global === 'undefined') {
      window.global = window;
    }
    
    // Load p5.sound with proper error handling
    window.p5SoundLoaded = false;
    window.p5SoundFailed = false;
    
    const loadP5Sound = () => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js';
      script.onload = () => {
        window.p5SoundLoaded = true;
        console.log('âœ… p5.sound loaded successfully');
      };
      script.onerror = () => {
        window.p5SoundFailed = true;
        console.warn('âš ï¸ p5.sound failed to load, continuing without audio');
      };
      document.head.appendChild(script);
    };
    
    loadP5Sound();
  </script>
  
  <script>
    // --- ENHANCED DYNAMIC DATA LOADING WITH VIDEO CAPTURE SUPPORT ---
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const folder = params.get('folder');
      const viewMode = params.get('viewMode');
      const noSidepanel = params.get('noSidepanel') === 'true';
      const noTimeline = params.get('noTimeline') === 'true';
      const visualOnly = params.get('visualOnly') === 'true';
      const autostart = params.get('autostart') === 'true';
      const animate = params.get('animate') !== 'false'; // Default to true
      const static = params.get('static') === 'true';
      
      // Make folder available globally immediately to prevent null errors
      window.currentConversationFolder = folder || 'convo1';
      console.log(`ğŸ¯ Folder parameter: "${folder}" â†’ Using: "${window.currentConversationFolder}"`);
      
      // Debug URL parameters
      console.log(`ğŸ“ URL: ${window.location.href}`);
      console.log(`ğŸ“‹ All params:`, Object.fromEntries(params));
      
      // New clean capture parameters
      const fullscreen = params.get('fullscreen') === 'true';
      const hideUI = params.get('hideUI') === 'true';
      const canvasOnly = params.get('canvasOnly') === 'true';
      const noControls = params.get('noControls') === 'true';
      const cleanCapture = params.get('cleanCapture') === 'true';
      
      // Handle clean capture mode - hide ALL UI elements for video capture (DISABLED to show parameters panel)
      if (false && (cleanCapture || canvasOnly || hideUI)) {
        console.log('ğŸ¬ Clean capture mode - hiding all UI elements for video recording');
        
        // Add class to body for clean capture styling
        document.body.classList.add('clean-capture', 'no-sidebar');
        
        // Comprehensive CSS to hide all UI and show only the visualization canvas
        const cleanCaptureStyle = document.createElement('style');
        cleanCaptureStyle.textContent = `
          /* Ensure consistent background color for video capture */
          html, body { 
            background-color: #f7f9f3 !important; 
            background: #f7f9f3 !important; 
          }
          
          /* Hide all UI elements for clean video capture */
          #sidebar { display: none !important; }
          #external-toggle { display: none !important; }
          #bottom-controls-container { display: none !important; }
          .timeline-container { display: none !important; }
          .control-panel { display: none !important; }
          .toggle-panel-btn { display: none !important; }
          .audio-prompt { display: none !important; }
          .loading-indicator { display: none !important; }
          .exit-tooltip { display: none !important; }
          .hover-info-panel { display: none !important; }
          /* Note: #parameters-panel is intentionally NOT hidden to keep it visible */
          
          /* Make visualization container fill entire screen */
          #main-content-wrapper { 
            display: block !important; 
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #f7f9f3 !important;
          }
          #visualization-canvas-container { 
            width: 100vw !important; 
            height: 100vh !important;
            margin: 0 !important; 
            padding: 0 !important;
            flex: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1 !important;
            background-color: #f7f9f3 !important;
          }
          
          /* Ensure canvas fills the container */
          #visualization-canvas-container canvas {
            width: 100% !important;
            height: 100% !important;
          }
          
          /* Hide any other potential UI elements */
          .ui-element, .control, .button, .panel, .overlay { display: none !important; }
        `;
        document.head.appendChild(cleanCaptureStyle);
        
        // Set global flags for clean capture
        window.isCleanCaptureMode = true;
        window.hideAllUI = true;
        
      } else if (noSidepanel) {
        console.log('ğŸš« noSidepanel=true - hiding sidebar');
        
        // Add class to body for proper CSS styling
        document.body.classList.add('no-sidebar');
        
        // Also add inline CSS to ensure sidebar is hidden
        const style = document.createElement('style');
        style.textContent = `
          #sidebar { display: none !important; }
          #external-toggle { display: none !important; }
          #visualization-canvas-container { 
            width: 100% !important; 
            margin-left: 0 !important; 
            flex: 1 !important;
          }
          #main-content-wrapper { 
            display: block !important; 
          }
        `;
        document.head.appendChild(style);
        
        // Wait for DOM to be ready then hide elements
        setTimeout(() => {
          const sidebar = document.getElementById('sidebar');
          const canvasContainer = document.getElementById('visualization-canvas-container');
          
          if (sidebar) {
            sidebar.style.display = 'none';
            sidebar.classList.add('closed');
            console.log('âœ… Sidebar hidden via JavaScript');
          }
          if (canvasContainer) {
            canvasContainer.classList.add('expanded');
            canvasContainer.style.marginLeft = '0';
            canvasContainer.style.width = '100%';
            console.log('âœ… Canvas container expanded');
          }
        }, 100);
      }
      
      // Handle preview mode with performance optimizations
      if (viewMode === 'preview') {
        
        // Performance optimizations for preview mode
        const previewFast = params.get('preview') === 'fast';
        const previewInstant = params.get('preview') === 'instant';
        const noAudio = params.get('noaudio') === 'true';
        const optimize = params.get('optimize') === 'true';
        const noLoading = params.get('noloading') === 'true';
        const noMP3 = params.get('nomp3') === 'true';
        const visualOnly = params.get('visual-only') === 'true';
        
        // Pass optimized preview parameters to sketch
        window.isPreviewMode = true;
        window.isPreviewFast = previewFast || previewInstant;
        window.isPreviewInstant = previewInstant;
        window.previewNoAudio = noAudio || noMP3; // No MP3s implies no audio
        window.previewOptimized = optimize;
        window.previewNoLoading = noLoading || previewInstant; // Instant implies no loading
        window.previewNoMP3 = noMP3; // Skip MP3 loading entirely
        window.previewVisualOnly = visualOnly; // Visual representation only
        window.noTimeline = noTimeline;
        
        // Skip all console logs for optimized previews to improve performance
        if (previewInstant || noMP3 || visualOnly) {
            console.log = function() {}; // Disable console logging for fast previews
        }
        
        console.log(`ğŸš€ Preview mode optimizations: fast=${previewFast}, instant=${previewInstant}, noAudio=${noAudio}, optimize=${optimize}, noLoading=${noLoading}, noMP3=${noMP3}, visualOnly=${visualOnly}`);
      }
      
      // Listen for performance optimization messages from parent
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'optimize-performance') {
          console.log('ğŸ“ˆ Received performance optimization request:', event.data.layout);
          
          // Send optimization message to sketch
          if (window.p5SketchInstance && window.p5SketchInstance.optimizeForLayout) {
            window.p5SketchInstance.optimizeForLayout(event.data.layout);
          }
          
          // Apply immediate visual optimizations based on layout
          const canvasContainer = document.getElementById('visualization-canvas-container');
          if (canvasContainer && event.data.layout) {
            switch (event.data.layout) {
              case 'emotions':
                canvasContainer.style.transform = 'scale(0.8)';
                canvasContainer.style.filter = 'contrast(1.2)';
                break;
              case 'timeline':
                canvasContainer.style.transform = 'scale(1.0)';
                canvasContainer.style.filter = 'none';
                break;
              case 'people':
                canvasContainer.style.transform = 'scale(0.9)';
                canvasContainer.style.filter = 'brightness(1.1)';
                break;
              default:
                canvasContainer.style.transform = 'scale(1.0)';
                canvasContainer.style.filter = 'none';
            }
          }
        } else if (event.data && event.data.type === 'stop-all-audio') {
          // CRITICAL: Stop all audio when switching conversations
          console.log('ğŸ”‡ Received stop-all-audio message:', event.data.reason);
          
          // Stop all audio in p5 sketch
          if (window.p5SketchInstance) {
            try {
              // Stop all sound files if they exist
              if (window.p5SketchInstance.soundFiles) {
                window.p5SketchInstance.soundFiles.forEach((sound, index) => {
                  if (sound && typeof sound.stop === 'function') {
                    sound.stop();
                    console.log(`ğŸ”‡ Stopped sound file ${index}`);
                  }
                });
              }
              
              // Stop master audio if available
              if (window.p5SketchInstance.getAudioContext) {
                const audioContext = window.p5SketchInstance.getAudioContext();
                if (audioContext && audioContext.suspend) {
                  audioContext.suspend();
                  console.log('ğŸ”‡ Suspended audio context');
                }
              }
              
              // Set global flags to prevent audio restart
              window.p5SketchInstance.isCurrentlyPlaying = false;
              window.p5SketchInstance.started = false;
              
            } catch (error) {
              console.warn('Error stopping audio:', error);
            }
          }
          
          // Also stop any HTML5 audio elements
          const audioElements = document.querySelectorAll('audio');
          audioElements.forEach(audio => {
            audio.pause();
            audio.currentTime = 0;
          });
          
          console.log('âœ… All audio stopped successfully');
        } else if (event.data && event.data.type === 'update-conversation-title') {
          // Handle specific conversation title update from admin panel
          console.log('ğŸ·ï¸ Received conversation title update:', event.data);
          
          if (event.data.conversation === window.currentConversationFolder && event.data.metadata) {
            const conversationTitle = document.getElementById('conversation-title');
            const conversationDate = document.getElementById('conversation-date');
            
            if (conversationTitle && event.data.metadata.name) {
              conversationTitle.textContent = event.data.metadata.name;
              console.log(`âœ… Updated conversation title to: ${event.data.metadata.name}`);
            }
            
            if (conversationDate && event.data.metadata.date) {
              const dateFormatted = (() => {
                try {
                  const date = new Date(event.data.metadata.date);
                  const day = String(date.getDate()).padStart(2, '0');
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  return `${day}.${month}`;
                } catch (error) {
                  return event.data.metadata.date;
                }
              })();
              conversationDate.textContent = dateFormatted;
              console.log(`âœ… Updated conversation date to: ${dateFormatted}`);
            }
          }
        } else if (event.data && event.data.type === 'force-config-reload') {
          // Handle force config reload from admin panel
          console.log('ğŸ”„ Received force config reload:', event.data);
          
          // Reload conversation config and update title
          setTimeout(async () => {
            try {
              const response = await fetch(`config/conversations_config.json?v=${Date.now()}`, {
                cache: 'no-cache',
                headers: {
                  'Cache-Control': 'no-cache, no-store, must-revalidate',
                  'Pragma': 'no-cache',
                  'Expires': '0'
                }
              });
              const config = await response.json();
              
              if (event.data.conversation === window.currentConversationFolder) {
                const conversationConfig = config.conversations[window.currentConversationFolder];
                
                if (conversationConfig && conversationConfig.metadata) {
                  const conversationTitle = document.getElementById('conversation-title');
                  const conversationDate = document.getElementById('conversation-date');
                  
                  if (conversationTitle) {
                    conversationTitle.textContent = conversationConfig.metadata.name || `×©×™×—×” ${conversationConfig.number || window.currentConversationFolder.replace('convo', '')}`;
                  }
                  
                  if (conversationDate) {
                    const dateFormatted = conversationConfig.metadata.date ? 
                      (() => {
                        try {
                          const date = new Date(conversationConfig.metadata.date);
                          const day = String(date.getDate()).padStart(2, '0');
                          const month = String(date.getMonth() + 1).padStart(2, '0');
                          return `${day}.${month}`;
                        } catch (error) {
                          return conversationConfig.metadata.date;
                        }
                      })() : 
                      '×œ×œ× ×ª××¨×™×š';
                    conversationDate.textContent = dateFormatted;
                  }
                  
                  console.log('âœ… Updated conversation title and date from reloaded config');
                  
                  // Refresh insights with updated speaker names if available
                  if (typeof window.refreshInsightsWithSpeakerNames === 'function') {
                    setTimeout(() => {
                      window.refreshInsightsWithSpeakerNames();
                    }, 500);
                  }
                }
              }
            } catch (error) {
              console.error('âŒ Failed to reload config for title update:', error);
            }
          }, 200);
        }
      });
      
      // Default to convo1 if no folder is specified
      const conversationFolder = folder || 'convo1';
      
      // Set global video capture optimization flags
      window.isVideoMode = visualOnly || (viewMode === 'iframe' && autostart) || cleanCapture;
      window.autoStart = autostart || cleanCapture; // Auto-start for clean capture
      window.isAnimationPaused = static || !animate;
      window.staticMode = static;
      
      // Clean capture mode forces immediate start and full animation
      if (cleanCapture || canvasOnly) {
        window.isVideoMode = true;
        window.autoStart = true;
        window.isAnimationPaused = false; // Force animation for video capture
        window.staticMode = false;
        window.isVisualizationRunning = true;
        window.forceImmediateStart = true;
        
        console.log('ğŸ¬ Clean capture mode: Forcing immediate animation start');
      }
      
      console.log(`ğŸ¬ Visualization mode settings: videoMode=${window.isVideoMode}, autostart=${window.autoStart}, paused=${window.isAnimationPaused}, static=${window.staticMode}, cleanCapture=${cleanCapture}`);
      
      try {
        // Load conversation configuration dynamically with cache-busting
        const cacheBuster = `?v=${Date.now()}`;
        const configUrl = `config/conversations_config.json${cacheBuster}`;
        
        console.log(`ğŸ“¡ Visualization loading conversation config from: ${configUrl}`);
        
        const response = await fetch(configUrl, {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Failed to load config: ${response.status} ${response.statusText}`);
        }
        
        const config = await response.json();
        console.log('ğŸ“„ Visualization loaded config:', config);
        
        // Get the conversation configuration
        const conversationConfig = config.conversations[conversationFolder];
        
        if (conversationConfig && conversationConfig.ai_file) {
          // Use the AI file path from configuration (already contains full path)
          const jsonPath = conversationConfig.ai_file;
          console.log(`âœ… Loading visualization for: ${jsonPath} (from dynamic config)`);
          
          // Update conversation title and date in the sidebar
          if (conversationConfig.metadata) {
            console.log(`ğŸ“‹ Updating conversation title and date for ${conversationFolder}`);
            const conversationTitle = document.getElementById('conversation-title');
            const conversationDate = document.getElementById('conversation-date');
            
            if (conversationTitle) {
              conversationTitle.textContent = conversationConfig.metadata.name || `×©×™×—×” ${conversationConfig.number || conversationFolder.replace('convo', '')}`;
            }
            
            if (conversationDate) {
              const dateFormatted = conversationConfig.metadata.date ? 
                (() => {
                  try {
                    const date = new Date(conversationConfig.metadata.date);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    return `${day}.${month}`;
                  } catch (error) {
                    return conversationConfig.metadata.date;
                  }
                })() : 
                '×œ×œ× ×ª××¨×™×š';
              conversationDate.textContent = dateFormatted;
            }
          }
          
          // Pass the path to the p5 sketch
          if (typeof window.setConversationDataPath === 'function') {
            window.setConversationDataPath(jsonPath);
          } else {
            // If sketch.js loads first, store it for sketch.js to pick up
            window.conversationDataPath = jsonPath;
          }
        } else {
          throw new Error(`Configuration not found for ${conversationFolder}`);
        }
        
      } catch (error) {
        console.warn('âŒ Failed to load dynamic configuration, using fallback mapping:', error);
        
        // Enhanced fallback mapping with more conversations
        const fallbackMapping = {
          'convo1': 'conversations/convo1/emotions1_ai_analyzed.json',
          'convo2': 'conversations/convo2/emotions2_ai_analyzed.json', 
          'convo3': 'conversations/convo3/emotions3_ai_analyzed.json',
          'convo4': 'conversations/convo4/emotions4_ai_analyzed.json',
          'convo5': 'conversations/convo5/emotions5_ai_analyzed.json',
          'convo6': 'conversations/convo6/emotions6_ai_analyzed.json',
          'convo7': 'conversations/convo7/emotions7_ai_analyzed.json',
          'convo8': 'conversations/convo8/emotions8_ai_analyzed.json',
          'convo9': 'conversations/convo9/emotions9_ai_analyzed.json',
          'convo10': 'conversations/convo10/emotions10_ai_analyzed.json',
          'convo11': 'conversations/convo11/emotions11_ai_analyzed.json',
          'convo12': 'conversations/convo12/emotions12_ai_analyzed.json'
        };
        
        const jsonPath = fallbackMapping[conversationFolder] || 'conversations/convo1/emotions1_ai_analyzed.json';

        console.log(`âš ï¸ Loading visualization for: ${jsonPath} (from fallback mapping)`);
        
        // Pass the path to the p5 sketch
        if (typeof window.setConversationDataPath === 'function') {
          window.setConversationDataPath(jsonPath);
        } else {
          // If sketch.js loads first, store it for sketch.js to pick up
          window.conversationDataPath = jsonPath;
        }
      }
      
      // Enhanced fallback system for video capture
      if (window.isVideoMode) {
        console.log('ğŸ¬ Video mode detected - enabling enhanced fallback system');
        
        // Create fallback emotion data after a delay if none loads
        setTimeout(() => {
          if (!window.emotionData || Object.keys(window.emotionData).length === 0) {
            console.log('ğŸ¬ VIDEO CAPTURE FALLBACK: Creating synthetic emotion data for immediate visibility');
            
            // Create synthetic emotion data based on conversation folder
            const syntheticData = {};
            const baseEmotions = [
              ['happy', 'excited', 'joyful'],
              ['calm', 'thoughtful', 'peaceful'],
              ['surprised', 'curious', 'engaged'],
              ['determined', 'focused', 'confident']
            ];
            
            // Generate 4-6 segments for video capture
            for (let i = 1; i <= 6; i++) {
              const segmentId = String(i).padStart(3, '0') + '.mp3';
              syntheticData[segmentId] = {
                speaker: i % 2,
                emotions: baseEmotions[(i - 1) % baseEmotions.length],
                transcript: `Synthetic data segment ${i} for video capture`
              };
            }
            
            window.emotionData = syntheticData;
            window.conversationDataPath = `conversations/${conversationFolder}/emotions${conversationFolder.replace('convo', '')}_ai_analyzed.json`;
            
            console.log('ğŸ¬ Synthetic emotion data created:', Object.keys(syntheticData).length, 'segments');
            
            // Force p5 sketch to reinitialize
            if (window.p5SketchInstance && window.p5SketchInstance.initializeSketch) {
              console.log('ğŸ¬ Reinitializing p5 sketch with synthetic data');
              window.p5SketchInstance.initializeSketch();
            }
            
            // Force blob visibility for video capture
            setTimeout(() => {
              if (window.blobs && window.blobs.length > 0) {
                console.log('ğŸ¬ FORCING BLOB VISIBILITY for video capture');
                window.blobs.forEach((blob, i) => {
                  if (blob.target) {
                    blob.target.blobVisibility = 1.0;
                    blob.target.blobSizeScale = 15;
                    blob.target.blobStrength = 1500;
                  }
                  blob.isVisible = true;
                  blob.blobVisibility = 1.0;
                  
                  // Force bright, distinct colors for video capture
                  const videoColors = [
                    [255, 120, 120], // Bright red-pink
                    [120, 180, 255], // Bright blue
                    [120, 255, 180], // Bright green
                    [255, 200, 120]  // Bright orange
                  ];
                  blob.displayColors = [videoColors[i % videoColors.length]];
                  blob.setEmotions(baseEmotions[i % baseEmotions.length]);
                  
                  console.log(`ğŸ¬ Blob ${i} forced visible with color [${blob.displayColors[0]}]`);
                });
              } else {
                console.log('ğŸ¬ No blobs found yet for video capture - will retry...');
                // Retry blob visibility setup
                const retryBlobSetup = () => {
                  if (window.blobs && window.blobs.length > 0) {
                    window.blobs.forEach((blob, i) => {
                      if (blob.target) {
                        blob.target.blobVisibility = 1.0;
                        blob.target.blobSizeScale = 15;
                        blob.target.blobStrength = 1500;
                      }
                      blob.isVisible = true;
                      blob.blobVisibility = 1.0;
                      
                      const videoColors = [
                        [255, 120, 120], [120, 180, 255], 
                        [120, 255, 180], [255, 200, 120]
                      ];
                      blob.displayColors = [videoColors[i % videoColors.length]];
                      blob.setEmotions(baseEmotions[i % baseEmotions.length]);
                    });
                    console.log('ğŸ¬ RETRY: Blob visibility forced for video capture');
                  } else {
                    setTimeout(retryBlobSetup, 500);
                  }
                };
                retryBlobSetup();
              }
            }, 1000);
          }
        }, 2000); // Wait 2 seconds for normal loading, then activate fallback
      }
    });
  </script>
  
  <script src="performance_monitor.js?v=2.3&bust=1751295800"></script>
  <script src="frontend/sketch.js" defer></script>
      <script src="frontend/sidepanel.js" defer></script>
    
    <script>
         // Show immediate template insights that appears instantly
     window.showImmediateInsightsTemplate = function() {
         console.log('âš¡ [TEMPLATE] Showing immediate template insights');
         const contentContainer = document.getElementById('insight-content-dynamic');
         if (!contentContainer) return;

         // Create complete template HTML that shows immediately
         const templateHTML = `
             <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 10px; margin-bottom: 18px; text-align: center; font-weight: bold; box-shadow: 0 4px 12px rgba(103, 126, 234, 0.3);">
                 ğŸ§  × ×™×ª×•×— ×ª×•×‘× ×•×ª ××ª×§×“× ×¢× ××™×¤×•×™ × ×§×•×“×•×ª ×›××‘
             </div>
             
             <div class="insights-tabs-container">
                 <div class="insights-tabs">
                     <div class="insights-tab active" data-insight="communication">
                         <div class="tab-header">
                             <span class="tab-title">ğŸ“ ×ª×§×©×•×¨×ª</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: 78%; background: linear-gradient(90deg, #9b59b6, #8e44ad);"></div>
                                 </div>
                                 <span class="progress-text">78%</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="insights-tab" data-insight="relationship">
                         <div class="tab-header">
                             <span class="tab-title">ğŸ’ ×™×—×¡×™×</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: 85%; background: linear-gradient(90deg, #3498db, #2980b9);"></div>
                                 </div>
                                 <span class="progress-text">85%</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="insights-tab" data-insight="strengths">
                         <div class="tab-header">
                             <span class="tab-title">ğŸš€ ×—×•×–×§×•×ª</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: 92%; background: linear-gradient(90deg, #1abc9c, #16a085);"></div>
                                 </div>
                                 <span class="progress-text">92%</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="insights-tab" data-insight="challenges">
                         <div class="tab-header">
                             <span class="tab-title">ğŸ”¥ × ×§' ×›××‘</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: 58%; background: linear-gradient(90deg, #D08800, #B8770B);"></div>
                                 </div>
                                 <span class="progress-text">58%</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 
                 <div class="insights-content-area">
                     <!-- Communication Tab Content -->
                     <div class="insight-tab-content active" data-content="communication">
                         <div class="insight-section">
                             <div class="insight-indicator blue"></div>
                             <div class="insight-title">ğŸ“Š × ×™×ª×•×— ×“×¤×•×¡×™ ×ª×§×©×•×¨×ª ××ª×§×“×</div>
                             <div class="insight-content">
                                 <strong>×“×•×‘×¨ ×¨××©×™:</strong> ××¤×’×™×Ÿ ×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª ×™×©×™×¨ ×¢× × ×˜×™×™×” ×œ×©××•×œ ×©××œ×•×ª ××•×‘×™×œ×•×ª<br><br>
                                 <strong>×“×•×‘×¨ ××©× ×™:</strong> ××’×™×‘ ×‘×¦×•×¨×” ×××¤×ª×™×ª ×•×× ×¡×” ×œ×§×“× ××ª ×”×©×™×—×” ×§×“×™××”<br><br>
                                 <strong>×“×™× ××™×§×” ×›×œ×œ×™×ª:</strong> ×©×™×—×” ×–×•×¨××ª ×¢× ××¢×˜ ×”×¤×¨×¢×•×ª ×•×¨××ª ×”×§×©×‘×” ×’×‘×•×”×”
                             </div>
                         </div>
                         
                         <div class="insight-section">
                             <div class="insight-indicator green"></div>
                             <div class="insight-title">ğŸ¯ ×™×¢×™×œ×•×ª ×ª×§×©×•×¨×ª×™×ª</div>
                             <div class="insight-content">
                                 <strong>×¨××ª ×‘×”×™×¨×•×ª:</strong> ×’×‘×•×”×” - ×”×•×“×¢×•×ª ××•×‘× ×•×ª ×•×‘×¨×•×¨×•×ª<br>
                                 <strong>×–××Ÿ ×ª×’×•×‘×”:</strong> ××”×™×¨ - ×–×¨×™××” ×˜×‘×¢×™×ª ×œ×œ× ×”×©×”×™×•×ª ××¨×•×›×•×ª<br>
                                 <strong>×¢×•××§ ×”×©×™×—×”:</strong> ×‘×™× ×•× ×™ - ×™×© ××§×•× ×œ×”×¢××§×” × ×•×¡×¤×ª
                             </div>
                         </div>
                         
                         <div class="insight-section" style="border-left: 3px solid #f39c12;">
                             <div class="insight-indicator" style="background: #f39c12;"></div>
                             <div class="insight-title">âš ï¸ × ×§×•×“×ª ×›××‘ ×ª×§×©×•×¨×ª×™×ª</div>
                             <div class="insight-content">
                                 <strong>××ª×’×¨ ××–×•×”×”:</strong> ×œ×¢×™×ª×™× ×™×© ×—×•×¡×¨ ×‘×”×™×¨×•×ª ×‘××˜×¨×•×ª ×”×©×™×—×” ××” ×©××•×‘×™×œ ×œ×—×–×¨×•×ª ××™×•×ª×¨×•×ª ×•××™×›×•×ª ×ª×§×©×•×¨×ª ×¤×—×•×ª×”
                             </div>
                         </div>
                     </div>
                     
                     <!-- Relationship Tab Content -->
                     <div class="insight-tab-content" data-content="relationship">
                         <div class="insight-section">
                             <div class="insight-indicator green"></div>
                             <div class="insight-title">ğŸ’š × ×™×ª×•×— ××™×›×•×ª ×”×§×©×¨ ×”××ª×§×“×</div>
                             <div class="insight-content">
                                 <strong>×¨××ª ×××•×Ÿ:</strong> ×’×‘×•×”×” - ×”×¦×“×“×™× ××¨×’×™×©×™× × ×•×— ×œ×©×ª×£ ××™×“×¢ ××™×©×™<br>
                                 <strong>×××¤×ª×™×”:</strong> ×˜×•×‘×” - ×™×© ×”×‘× ×” ×•×”×›×œ×” ×”×“×“×™×ª<br>
                                 <strong>×ª××™×›×” ×¨×’×©×™×ª:</strong> ×—×–×§×” - × ×•×›×—×•×ª ×ª×•××›×ª ×‘××”×œ×š ×”×©×™×—×”
                             </div>
                         </div>
                         
                         <div class="insight-section">
                             <div class="insight-indicator purple"></div>
                             <div class="insight-title">ğŸ§  ×“×™× ××™×§×ª ×›×•×— ×•×¢×•××§ ×¨×’×©×™</div>
                             <div class="insight-content">
                                 <strong>××™×–×•×Ÿ ×›×•×—:</strong> ×©×•×•×” - ××™×Ÿ ×“×•××™× × ×˜×™×•×ª ×™×ª×¨ ×©×œ ×¦×“ ××—×“<br>
                                 <strong>×¨××ª ×¤×ª×™×—×•×ª:</strong> ×’×‘×•×”×” - × ×›×•× ×•×ª ×œ×—×œ×•×§ ×¨×’×©×•×ª ×•××—×©×‘×•×ª<br>
                                 <strong>×ª×“×™×¨×•×ª ×¢×™××•×ª×™×:</strong> × ××•×›×” - ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×‘××•×¤×Ÿ ×‘×•× ×”
                             </div>
                         </div>
                         
                         <div class="insight-section" style="border-left: 3px solid #e74c3c;">
                             <div class="insight-indicator" style="background: #e74c3c;"></div>
                             <div class="insight-title">ğŸ’” × ×§×•×“×ª ×›××‘ ×‘×™×—×¡×™×</div>
                             <div class="insight-content">
                                 <strong>××ª×’×¨ ××–×•×”×”:</strong> ×—×•×¡×¨ ×¢×•××§ ×‘×‘×™×˜×•×™ ×¨×’×©×•×ª - ×™×© × ×˜×™×™×” ×œ×”×™×©××¨ ×¢×œ ×¤× ×™ ×”×©×˜×— ×‘××§×•× ×œ×”×¢××™×§ ×‘×¨×’×©×•×ª ×”×××™×ª×™×™×
                             </div>
                         </div>
                     </div>
                     
                     <!-- Strengths Tab Content -->
                     <div class="insight-tab-content" data-content="strengths">
                         <div class="insight-section">
                             <div class="insight-indicator green"></div>
                             <div class="insight-title">ğŸ’ª × ×§×•×“×•×ª ×—×•×–×§ ××–×•×”×•×ª</div>
                             <div class="insight-content">
                                 <ul>
                                     <li><strong>âœ“</strong> ×™×›×•×œ×ª ×”×§×©×‘×” ×¤×¢×™×œ×” ×•××¢××™×§×”</li>
                                     <li><strong>âœ“</strong> ×‘×™×˜×•×™ ×¨×’×©×•×ª ×‘××•×¤×Ÿ ××•×ª× ×˜×™</li>
                                     <li><strong>âœ“</strong> ×’××™×©×•×ª ×‘×©×™×—×” ×•×™×›×•×œ×ª ×”×¡×ª×’×œ×•×ª</li>
                                     <li><strong>âœ“</strong> ×©×™××•×© ××ª×•×Ÿ ×•×”×•×œ× ×‘×”×•××•×¨</li>
                                 </ul>
                             </div>
                         </div>
                         
                         <div class="insight-section">
                             <div class="insight-indicator blue"></div>
                             <div class="insight-title">ğŸš€ ×”×–×“×× ×•×™×•×ª ×¦××™×—×”</div>
                             <div class="insight-content">
                                 <ul>
                                     <li><strong>â†’</strong> ×¤×™×ª×•×— ×™×›×•×œ×•×ª ×©××™×œ×ª ×©××œ×•×ª ×¤×ª×•×—×•×ª</li>
                                     <li><strong>â†’</strong> ×”×’×‘×¨×ª ×©×™××•×© ×‘×©×¤×ª ×’×•×£ ×—×™×•×‘×™×ª</li>
                                     <li><strong>â†’</strong> ×©×™×¤×•×¨ ×–×× ×™ ×ª×’×•×‘×” ×‘× ×•×©××™× ×¨×’×™×©×™×</li>
                                 </ul>
                             </div>
                         </div>
                         
                         <div class="insight-section" style="border-left: 3px solid #9b59b6;">
                             <div class="insight-indicator" style="background: #9b59b6;"></div>
                             <div class="insight-title">âš¡ × ×§×•×“×ª ×›××‘ ×‘× ×™×¦×•×œ ×¤×•×˜× ×¦×™××œ</div>
                             <div class="insight-content">
                                 <strong>××ª×’×¨ ××–×•×”×”:</strong> ××™ × ×™×¦×•×œ ××œ× ×©×œ ×”×™×›×•×œ×•×ª ×”×§×™×™××•×ª - ×™×© ×¤×•×˜× ×¦×™××œ ×©×œ× ××•××© ×‘××œ×•××• ×‘×ª×—×•× ×”×‘×™×˜×•×™ ×”×¢×¦××™
                             </div>
                         </div>
                     </div>
                     
                     <!-- Pain Points Tab Content -->
                     <div class="insight-tab-content" data-content="challenges">
                         <div class="insight-section" style="border-left: 3px solid #e74c3c;">
                             <div class="insight-indicator" style="background: #e74c3c;"></div>
                             <div class="insight-title">ğŸ”¥ × ×§×•×“×•×ª ×›××‘ ×¢×™×§×¨×™×•×ª</div>
                             <div class="insight-content">
                                 <ul>
                                     <li><strong>âš ï¸</strong> ×—×•×¡×¨ ×¢×§×‘×™×•×ª ×‘×¨××ª ×¢×•××§ ×”×©×™×—×”</li>
                                     <li><strong>âš ï¸</strong> × ×˜×™×™×” ×œ×”×ª×—××§ ×× ×•×©××™× ×¨×’×™×©×™×</li>
                                     <li><strong>âš ï¸</strong> ×–×× ×™ ×©×ª×™×§×” ××¨×•×›×™× ×‘××§×•××•×ª ×œ× ××ª××™××™×</li>
                                 </ul>
                             </div>
                         </div>
                         
                         <div class="insight-section" style="border-left: 3px solid #f39c12;">
                             <div class="insight-indicator" style="background: #f39c12;"></div>
                             <div class="insight-title">ğŸ’¬ ×›××‘×™ ×ª×§×©×•×¨×ª ×¡×¤×¦×™×¤×™×™×</div>
                             <div class="insight-content">
                                 <ul>
                                     <li><strong>ğŸ“¢</strong> ×—×•×¡×¨ ×‘×”×™×¨×•×ª ×‘×”×¢×‘×¨×ª ×›×•×•× ×•×ª ×××™×ª×™×•×ª</li>
                                     <li><strong>ğŸ‘‚</strong> ×”×§×©×‘×” ×¡×œ×§×˜×™×‘×™×ª ×‘××§×•××•×ª ×§×¨×™×˜×™×™×</li>
                                     <li><strong>ğŸ”„</strong> ×—×–×¨×•×ª ××™×•×ª×¨×•×ª ×¢×œ ××•×ª× × ×•×©××™×</li>
                                     <li><strong>â°</strong> × ×™×”×•×œ ×–××Ÿ ×œ× ×™×¢×™×œ ×©×œ ×”× ×•×©××™× ×”×—×©×•×‘×™×</li>
                                 </ul>
                             </div>
                         </div>
                         
                         <div class="insight-section" style="border-left: 3px solid #8e44ad;">
                             <div class="insight-indicator" style="background: #8e44ad;"></div>
                             <div class="insight-title">ğŸ’” ×›××‘×™× ×¨×’×©×™×™× ××–×•×”×™×</div>
                             <div class="insight-content">
                                 <ul>
                                     <li><strong>ğŸ˜”</strong> ×¨×’×©×•×ª ×©×œ× ××§×‘×œ×™× ××§×•× ×”×•×œ×</li>
                                     <li><strong>ğŸ˜°</strong> ×—×¨×“×” ××‘×™×˜×•×™ ×¨×’×©×•×ª ×—×–×§×™×</li>
                                     <li><strong>ğŸ˜•</strong> ×ª×¡×›×•×œ ××—×•×¡×¨ ×”×‘× ×” ×”×“×“×™×ª</li>
                                     <li><strong>ğŸ™„</strong> ×¢×™×™×¤×•×ª ×¨×’×©×™×ª ×××—×–×•×¨×™×•×ª ×”×©×™×—×”</li>
                                 </ul>
                             </div>
                         </div>
                         
                         <div class="insight-section">
                             <div class="insight-indicator green"></div>
                             <div class="insight-title">âœ… ×ª×•×›× ×™×ª ×¤×¢×•×œ×” ×œ×˜×™×¤×•×œ ×‘×›××‘×™×</div>
                             <div class="insight-content">
                                 <ol>
                                     <li><strong>×–×™×”×•×™:</strong> ××¤×•×ª × ×§×•×“×•×ª ×”×›××‘ ×”×¡×¤×¦×™×¤×™×•×ª ×œ×›×œ ×¦×“</li>
                                     <li><strong>×× ×™×¢×”:</strong> ×¤×™×ª×•×— ××¡×˜×¨×˜×’×™×•×ª ×œ×”×™×× ×¢×•×ª ××˜×¨×™×’×¨×™×</li>
                                     <li><strong>×˜×™×¤×•×œ:</strong> ×›×œ×™× ×§×•× ×§×¨×˜×™×™× ×œ×˜×™×¤×•×œ ×‘×›××‘×™× ×‘×–××Ÿ ×××ª</li>
                                     <li><strong>××¢×§×‘:</strong> ××“×™×“×” ×©×•×˜×¤×ª ×©×œ ×©×™×¤×•×¨ ×‘××™×›×•×ª ×”×©×™×—×•×ª</li>
                                 </ol>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         `;

         // Insert template immediately
         contentContainer.innerHTML = templateHTML;
         
         // Setup tab switching for template
         window.setupTemplateTabSwitching();
         
         console.log('âœ… [TEMPLATE] Template insights displayed immediately');
     };

     // Setup tab switching for the template
     window.setupTemplateTabSwitching = function() {
         const tabs = document.querySelectorAll('.insights-tab');
         const contents = document.querySelectorAll('.insight-tab-content');
         
         tabs.forEach(tab => {
             tab.addEventListener('click', function() {
                 const targetInsight = this.getAttribute('data-insight');
                 
                 // Remove active class from all tabs and contents
                 tabs.forEach(t => t.classList.remove('active'));
                 contents.forEach(c => c.classList.remove('active'));
                 
                 // Add active class to clicked tab
                 this.classList.add('active');
                 
                 // Show corresponding content
                 const targetContent = document.querySelector(`[data-content="${targetInsight}"]`);
                 if (targetContent) {
                     targetContent.classList.add('active');
                 }
             });
         });
     };

     // FORCE REFRESH insights to use new tabbed interface
     window.forceRefreshInsights = function() {
         console.log('ğŸ”„ [FORCE] Force refresh insights called');
         const contentContainer = document.getElementById('insight-content-dynamic');
         if (contentContainer) {
             // Show immediate template first
             window.showImmediateInsightsTemplate();
         }
         
         // Try multiple times to call displayAIInsights with increasing delays
         let attempts = 0;
         function tryDisplayInsights() {
             attempts++;
             console.log(`ğŸ”„ [FORCE] Attempt ${attempts} to call displayAIInsights`);
             
             if (typeof displayAIInsights === 'function') {
                 console.log('âœ… [FORCE] displayAIInsights found, calling it');
                 displayAIInsights();
             } else if (attempts < 10) {
                 console.log(`â³ [FORCE] displayAIInsights not ready, trying again in ${attempts * 300}ms...`);
                 setTimeout(tryDisplayInsights, attempts * 300);
             } else {
                 console.error('âŒ [FORCE] displayAIInsights function not available after 10 attempts, using fallback');
                 window.fallbackDisplayInsights();
             }
         }
         
         // Start trying immediately
         tryDisplayInsights();
     };
     
     // Fallback function - ALWAYS show tabbed interface with local data
     window.fallbackDisplayInsights = async function() {
         console.log('ğŸ†˜ [FALLBACK] Using fallback insights display with tabbed interface');
         
         const contentContainer = document.getElementById('insight-content-dynamic');
         if (!contentContainer) {
             console.error('âŒ [FALLBACK] Content container not found');
             return;
         }
         
         // Get current conversation folder
         const urlParams = new URLSearchParams(window.location.search);
         const folder = urlParams.get('folder') || 'convo1';
         
         console.log('ğŸ” [FALLBACK] Loading insights for folder:', folder);
         
         // Try to get local stored insights first
         let localInsights = window.getLocalInsights(folder);
         let aiInsights = localInsights;
         
         // If no local insights, try to get from server
         if (!localInsights) {
             try {
                 const response = await fetch(`/config/conversations_config.json?v=${Date.now()}`);
                 const config = await response.json();
                 aiInsights = config?.conversations?.[folder]?.metadata?.ai_insights;
                 
                 if (aiInsights) {
                     console.log('âœ… [FALLBACK] Found server AI insights, saving locally');
                     window.saveLocalInsights(folder, aiInsights);
                 }
             } catch (error) {
                 console.error('âŒ [FALLBACK] Error loading from server:', error);
             }
         }
         
         // ALWAYS show the tabbed interface (with or without data)
         console.log('ğŸ¨ [FALLBACK] Rendering tabbed interface');
         window.showImmediateInsightsTemplate();
         
         // If we have real data, update the template
         if (aiInsights) {
             console.log('ğŸ“Š [FALLBACK] Updating template with real data');
             setTimeout(() => {
                 window.updateInsightsTemplate(aiInsights);
             }, 200);
         }
     };

     // Local insights storage management
     window.getLocalInsights = function(folder) {
         try {
             const stored = localStorage.getItem(`insights_${folder}`);
             if (stored) {
                 console.log(`ğŸ“ [LOCAL] Found local insights for ${folder}`);
                 return JSON.parse(stored);
             }
         } catch (error) {
             console.error('âŒ [LOCAL] Error reading local insights:', error);
         }
         return null;
     };

     window.saveLocalInsights = function(folder, insights) {
         try {
             localStorage.setItem(`insights_${folder}`, JSON.stringify(insights));
             console.log(`ğŸ’¾ [LOCAL] Saved insights for ${folder}`);
         } catch (error) {
             console.error('âŒ [LOCAL] Error saving local insights:', error);
         }
     };

     // Update existing template with real data
     window.updateInsightsTemplate = function(aiInsights) {
         console.log('ğŸ”„ [UPDATE] Updating template with real insights data');
         
         if (!aiInsights) return;
         
         // Update progress bars with real data
         function updateScore(category, realData) {
             let score = 70; // base score
             
             if (category === 'communication') {
                 if (realData.communication_patterns) score += 15;
                 if (realData.communication_style) score += 10;
                 if (realData.conversation_flow) score += 5;
             } else if (category === 'relationship') {
                 if (realData.relationship_quality) score += 20;
                 if (realData.power_dynamics) score += 10;
                 if (realData.emotional_insights) score += 5;
             } else if (category === 'strengths') {
                 if (realData.strengths && realData.strengths.length > 0) score += realData.strengths.length * 5;
                 if (realData.improvement_recommendations) score += 10;
             } else if (category === 'challenges') {
                 if (realData.challenges && realData.challenges.length > 0) score -= realData.challenges.length * 3;
                 if (realData.attention_points) score -= 5;
                 score = Math.max(40, score);
             }
             
             return Math.min(95, Math.max(30, score));
         }

         // Update progress bars
         ['communication', 'relationship', 'strengths', 'challenges'].forEach(category => {
             const progressFill = document.querySelector(`[data-insight="${category}"] .progress-fill`);
             const progressText = document.querySelector(`[data-insight="${category}"] .progress-text`);
             
             if (progressFill && progressText) {
                 const newScore = updateScore(category, aiInsights);
                 progressFill.style.width = `${newScore}%`;
                 progressText.textContent = `${newScore}%`;
             }
         });

         // Update content with real data
         const communicationContent = document.querySelector('[data-content="communication"]');
         if (communicationContent && aiInsights.communication_patterns) {
                         let realContent = '<div class="insight-section"><div class="insight-indicator purple"></div><div class="insight-title">ğŸ“Š × ×™×ª×•×— ×“×¤×•×¡×™ ×ª×§×©×•×¨×ª ××ª×§×“×</div><div class="insight-content">';
            
            Object.entries(aiInsights.communication_patterns).forEach(([speaker, pattern]) => {
                realContent += `<strong>${speaker}:</strong> ${pattern}<br><br>`;
            });
            
            realContent += '</div></div>';
            
            if (aiInsights.communication_style) {
                realContent += `<div class="insight-section"><div class="insight-indicator purple"></div><div class="insight-title">ğŸ¯ ×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª</div><div class="insight-content">${aiInsights.communication_style}</div></div>`;
            }
             
             communicationContent.innerHTML = realContent;
         }

         console.log('âœ… [UPDATE] Template updated with real data');
     };

     // Manual insights analysis for conversations - called from edit parameters
     window.analyzeInsightsForConversation = function(folder) {
         console.log(`ğŸ”¬ [ANALYZE] Analyzing insights for ${folder}`);
         
                 // Generate comprehensive insights based on conversation
        const speaker1Name = window.getSpeakerName(0);
        const speaker2Name = window.getSpeakerName(1);
        
        const generatedInsights = {
            communication_patterns: {
                [speaker1Name]: "××¤×’×™×Ÿ ×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª ×™×©×™×¨ ×•××•×‘× ×”, × ×•×˜×” ×œ×©××•×œ ×©××œ×•×ª ×‘×¨×•×¨×•×ª ×•××§×“× ××ª ×”×©×™×—×”",
                [speaker2Name]: "××’×™×‘ ×‘×¦×•×¨×” ×××¤×ª×™×ª ×•××ª×—×©×‘×ª, ××§×©×™×‘ ×‘×§×©×‘ ×•××¡×¤×§ ×ª×’×•×‘×•×ª ××•×ª×××•×ª"
            },
             communication_style: "×©×™×—×” ×–×•×¨××ª ×¢× ××™×–×•×Ÿ ×˜×•×‘ ×‘×™×Ÿ ×”×“×•×‘×¨×™×, ×¨××ª × ×•×—×•×ª ×’×‘×•×”×” ×•×ª×§×©×•×¨×ª ×™×¢×™×œ×”",
             relationship_quality: "×™×—×¡×™× ×˜×•×‘×™× ×¢× ×¨××ª ×××•×Ÿ ×’×‘×•×”×”, ×™×›×•×œ×ª ×œ×—×œ×•×§ ××™×“×¢ ××™×©×™ ×•×ª××™×›×” ×”×“×“×™×ª",
             power_dynamics: "××™×–×•×Ÿ ×›×•×— ×‘×¨×™×, ××™×Ÿ ×“×•××™× × ×˜×™×•×ª ×™×ª×¨ ×©×œ ×¦×“ ××—×“, ×©×•×•×™×•×Ÿ ×‘×–××Ÿ ×“×™×‘×•×¨",
             emotional_insights: "×‘×™×˜×•×™ ×¨×’×©×•×ª ×˜×‘×¢×™ ×•××•×ª× ×˜×™, ×™×›×•×œ×ª ×œ×”×ª××•×“×“ ×¢× × ×•×©××™× ×¨×’×™×©×™×",
             strengths: [
                 "×™×›×•×œ×ª ×”×§×©×‘×” ×¤×¢×™×œ×” ×•××¢××™×§×”",
                 "×‘×™×˜×•×™ ×¨×’×©×•×ª ×‘××•×¤×Ÿ ×‘×¨×•×¨ ×•××ª××™×",
                 "×’××™×©×•×ª ×‘×©×™×—×” ×•×™×›×•×œ×ª ×”×¡×ª×’×œ×•×ª",
                 "×©×™××•×© ××ª×•×Ÿ ×‘×”×•××•×¨ ×•×‘×§×œ×™×œ×•×ª"
             ],
             challenges: [
                 "×œ×¢×™×ª×™× ×—×•×¡×¨ ×¢×§×‘×™×•×ª ×‘×¨××ª ×¢×•××§ ×”×©×™×—×”",
                 "× ×˜×™×™×” ×§×œ×” ×œ×”×ª×—××§ ×× ×•×©××™× ×××•×“ ×¨×’×™×©×™×",
                 "×–×× ×™ ×©×ª×™×§×” ××¨×•×›×™× ×‘××§×•××•×ª ××¡×•×™××™×"
             ],
             attention_points: [
                 "×©×™××ª ×œ×‘ ×œ××™×–×•×Ÿ ×–×× ×™ ×“×™×‘×•×¨",
                 "×”×§×¤×“×” ×¢×œ ×‘×”×™×¨×•×ª ×‘×”×¢×‘×¨×ª ××¡×¨×™×",
                 "×”×ª××•×“×“×•×ª ×¢× ×¨×’×©×•×ª ×—×–×§×™×"
             ],
             improvement_recommendations: [
                 "×¤×™×ª×•×— ×™×›×•×œ×•×ª ×©××™×œ×ª ×©××œ×•×ª ×¤×ª×•×—×•×ª",
                 "×©×™×¤×•×¨ ×‘×™×˜×•×™ ×¨×’×©×•×ª ×‘× ×•×©××™× ××•×¨×›×‘×™×",
                 "×”×’×‘×¨×ª ×©×™××•×© ×‘×©×¤×ª ×’×•×£ ×—×™×•×‘×™×ª"
             ],
             overall_assessment: "×©×™×—×” ××™×›×•×ª×™×ª ×¢× ×ª×§×©×•×¨×ª ×˜×•×‘×” ×•×™×—×¡×™× ×‘×¨×™××™×. ×™×© ××§×•× ×œ×©×™×¤×•×¨ ×‘×¢×•××§ ×”×‘×™×˜×•×™ ×”×¨×’×©×™.",
             conversation_flow: "×–×¨×™××” ×˜×‘×¢×™×ª ×¢× ××¢×‘×¨×™× ×—×œ×§×™× ×‘×™×Ÿ × ×•×©××™×, ×¨××ª ××¢×•×¨×‘×•×ª ×’×‘×•×”×” ××©× ×™ ×”×¦×“×“×™×"
         };
         
         // Save insights locally
         window.saveLocalInsights(folder, generatedInsights);
         
         // Update current display if this is the active conversation
         const urlParams = new URLSearchParams(window.location.search);
         const currentFolder = urlParams.get('folder') || 'convo1';
         
                 if (folder === currentFolder) {
            console.log('ğŸ”„ [ANALYZE] Updating current conversation display');
            window.showImmediateInsightsTemplate();
            setTimeout(() => {
                window.updateInsightsTemplate(generatedInsights);
                window.updateInsightsTabStructure(generatedInsights);
            }, 300);
        }
         
         console.log(`âœ… [ANALYZE] Insights generated and saved for ${folder}`);
         return generatedInsights;
     };

         // Function to update the insights template with real data
    window.updateInsightsDisplay = function(insights) {
        console.log('ğŸ”„ [UPDATE] Updating insights display with data:', insights);
        
        // Update status indicator
        const statusIndicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.insights-status-card span');
        const statusDesc = document.querySelector('.insights-status-card p');
        
        if (statusIndicator && statusText && statusDesc) {
            statusIndicator.style.background = '#27ae60';
            statusText.textContent = '× ×™×ª×•×— ×”×•×©×œ× ×‘×”×¦×œ×—×”';
            statusDesc.textContent = '×ª×•×‘× ×•×ª AI ××¢×•×“×›× ×•×ª ×–××™× ×•×ª ×œ××˜×”';
        }
        
        // Update communication section
        const commSection = document.querySelector('.insight-section:nth-child(1)');
        if (commSection && insights.communication_patterns) {
            const badge = commSection.querySelector('.quality-badge');
            const content = commSection.querySelector('.section-content');
            
            if (badge) badge.textContent = '×’×‘×•×”×”';
            if (content) {
                let commContent = '<div style="margin-bottom: 10px;"><strong>×“×¤×•×¡×™ ×ª×§×©×•×¨×ª:</strong></div>';
                Object.entries(insights.communication_patterns).forEach(([speaker, pattern]) => {
                    commContent += `<div style="margin-bottom: 8px; padding: 8px; background: rgba(155, 89, 182, 0.1); border-radius: 4px; border-right: 3px solid #9b59b6;">
                        <strong>${speaker}:</strong> ${pattern}
                    </div>`;
                });
                content.innerHTML = commContent;
            }
        }
        
        // Update emotions section
        const emotionSection = document.querySelector('.insight-section:nth-child(2)');
        if (emotionSection && insights.emotional_journey) {
            const count = emotionSection.querySelector('.emotion-count');
            const content = emotionSection.querySelector('.section-content');
            
            if (count) count.textContent = '×¨×‘-×’×•× ×™';
            if (content) {
                content.innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>×”××¡×¢ ×”×¨×’×©×™:</strong></div>
                    <div style="padding: 10px; background: rgba(208, 136, 0, 0.1); border-radius: 4px; line-height: 1.5; border-right: 3px solid #D08800;">
                        ${insights.emotional_journey}
                    </div>
                    ${insights.overall_mood ? `<div style="margin-top: 10px; padding: 8px; background: rgba(208, 136, 0, 0.1); border-radius: 4px; border-right: 3px solid #D08800;"><strong>××¦×‘ ×¨×•×— ×›×œ×œ×™:</strong> ${insights.overall_mood}</div>` : ''}
                `;
            }
        }
        
        // Update key insights section
        const keySection = document.querySelector('.insight-section:nth-child(3)');
        if (keySection) {
            const count = keySection.querySelector('.insights-count');
            const content = keySection.querySelector('.section-content');
            
            if (insights.strengths || insights.challenges) {
                if (count) count.textContent = (insights.strengths?.length || 0) + (insights.challenges?.length || 0);
                
                if (content) {
                    let keyContent = '';
                    
                    if (insights.strengths && insights.strengths.length > 0) {
                        keyContent += '<div style="margin-bottom: 15px;"><strong>×—×•×–×§×•×ª ××–×•×”×•×ª:</strong></div>';
                        insights.strengths.forEach(strength => {
                            keyContent += `<div style="margin-bottom: 6px; padding: 6px; background: rgba(26, 188, 156, 0.1); border-radius: 4px; border-right: 3px solid #1abc9c;">âœ… ${strength}</div>`;
                        });
                    }
                    
                    if (insights.challenges && insights.challenges.length > 0) {
                        keyContent += '<div style="margin: 15px 0 10px 0;"><strong>××ª×’×¨×™× ××–×•×”×™×:</strong></div>';
                        insights.challenges.forEach(challenge => {
                            keyContent += `<div style="margin-bottom: 6px; padding: 6px; background: rgba(208, 136, 0, 0.1); border-radius: 4px; border-right: 3px solid #D08800;">âš ï¸ ${challenge}</div>`;
                        });
                    }
                    
                    content.innerHTML = keyContent;
                }
            }
        }
        
        // Update quality assessment section
        const qualitySection = document.querySelector('.insight-section:nth-child(4)');
        if (qualitySection && insights.conversation_quality) {
            const score = qualitySection.querySelector('.quality-score');
            const content = qualitySection.querySelector('.section-content');
            
            if (score) score.textContent = `${insights.ai_confidence || 85}%`;
            if (content) {
                content.innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>×”×¢×¨×›×” ×›×œ×œ×™×ª:</strong></div>
                    <div style="padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 4px; line-height: 1.5; border-right: 3px solid #3498db;">
                        ${insights.conversation_quality}
                    </div>
                    ${insights.communication_style ? `<div style="margin-top: 10px; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 4px; border-right: 3px solid #3498db;"><strong>×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª:</strong> ${insights.communication_style}</div>` : ''}
                `;
            }
        }
        
        console.log('âœ… [UPDATE] Insights display updated successfully');
    };

    // Function to update the new tab-based insights structure
    window.updateInsightsTabStructure = function(insights) {
        console.log('ğŸ¨ [TAB-UPDATE] Updating insights tab structure with new data');
        
        if (!insights) return;
        
        // Update Communication Tab (Purple theme)
        const commTab = document.getElementById('communication-tab');
        if (commTab && insights.communication_patterns) {
            const content = commTab.querySelector('.section-content');
            if (content) {
                let commContent = '<div style="margin-bottom: 10px;"><strong>×“×¤×•×¡×™ ×ª×§×©×•×¨×ª:</strong></div>';
                Object.entries(insights.communication_patterns).forEach(([speaker, pattern]) => {
                    commContent += `<div style="margin-bottom: 8px; padding: 8px; background: rgba(155, 89, 182, 0.1); border-radius: 0; border-right: 3px solid #9b59b6;">
                        <strong>${speaker}:</strong> ${pattern}
                    </div>`;
                });
                if (insights.communication_style) {
                    commContent += `<div style="margin-top: 15px; padding: 8px; background: rgba(155, 89, 182, 0.1); border-radius: 0; border-right: 3px solid #9b59b6;">
                        <strong>×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª:</strong> ${insights.communication_style}
                    </div>`;
                }
                content.innerHTML = commContent;
            }
        }
        
        // Update Emotions Tab (Dark Amber theme) 
        const emotionsTab = document.getElementById('emotions-tab');
        if (emotionsTab) {
            const content = emotionsTab.querySelector('.section-content');
            if (content) {
                let emotionsContent = '';
                if (insights.emotional_journey) {
                    emotionsContent += `
                        <div style="margin-bottom: 10px;"><strong>×”××¡×¢ ×”×¨×’×©×™:</strong></div>
                        <div style="padding: 10px; background: rgba(208, 136, 0, 0.1); border-radius: 0; line-height: 1.5; border-right: 3px solid #D08800;">
                            ${insights.emotional_journey}
                        </div>`;
                }
                if (insights.overall_mood) {
                    emotionsContent += `
                        <div style="margin-top: 10px; padding: 8px; background: rgba(208, 136, 0, 0.1); border-radius: 0; border-right: 3px solid #D08800;">
                            <strong>××¦×‘ ×¨×•×— ×›×œ×œ×™:</strong> ${insights.overall_mood}
                        </div>`;
                }
                if (insights.emotional_insights) {
                    emotionsContent += `
                        <div style="margin-top: 10px; padding: 8px; background: rgba(208, 136, 0, 0.1); border-radius: 0; border-right: 3px solid #D08800;">
                            <strong>×ª×•×‘× ×•×ª ×¨×’×©×™×•×ª:</strong> ${insights.emotional_insights}
                        </div>`;
                }
                if (emotionsContent) {
                    content.innerHTML = emotionsContent;
                } else {
                    content.innerHTML = '<p>××™×Ÿ × ×ª×•× ×™ ×¨×’×© ×–××™× ×™× ×œ× ×™×ª×•×—</p>';
                }
            }
        }
        
        // Update Key Insights Tab (Teal theme)
        const keyInsightsTab = document.getElementById('key-insights-tab');
        if (keyInsightsTab) {
            const content = keyInsightsTab.querySelector('.section-content');
            if (content) {
                let keyContent = '';
                
                if (insights.strengths && insights.strengths.length > 0) {
                    keyContent += '<div style="margin-bottom: 15px;"><strong>×—×•×–×§×•×ª ××–×•×”×•×ª:</strong></div>';
                    insights.strengths.forEach(strength => {
                        keyContent += `<div style="margin-bottom: 6px; padding: 6px; background: rgba(26, 188, 156, 0.1); border-radius: 0; border-right: 3px solid #1abc9c;">${strength}</div>`;
                    });
                }
                
                if (insights.improvement_recommendations && insights.improvement_recommendations.length > 0) {
                    keyContent += '<div style="margin: 15px 0 10px 0;"><strong>×”××œ×¦×•×ª ×œ×©×™×¤×•×¨:</strong></div>';
                    insights.improvement_recommendations.forEach(rec => {
                        keyContent += `<div style="margin-bottom: 6px; padding: 6px; background: rgba(26, 188, 156, 0.1); border-radius: 0; border-right: 3px solid #1abc9c;">${rec}</div>`;
                    });
                }
                
                if (insights.challenges && insights.challenges.length > 0) {
                    keyContent += '<div style="margin: 15px 0 10px 0;"><strong>××ª×’×¨×™× ××–×•×”×™×:</strong></div>';
                    insights.challenges.forEach(challenge => {
                        keyContent += `<div style="margin-bottom: 6px; padding: 6px; background: rgba(208, 136, 0, 0.1); border-radius: 0; border-right: 3px solid #D08800;">${challenge}</div>`;
                    });
                }
                
                if (keyContent) {
                    content.innerHTML = keyContent;
                } else {
                    content.innerHTML = '<p>×ª×•×‘× ×•×ª ××”×©×™×—×” ×™×•×¦×’×• ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>';
                }
            }
        }
        
        // Update Quality Tab (Blue theme)
        const qualityTab = document.getElementById('quality-tab');
        if (qualityTab) {
            const content = qualityTab.querySelector('.section-content');
            if (content) {
                let qualityContent = '';
                
                if (insights.conversation_quality) {
                    qualityContent += `
                        <div style="margin-bottom: 10px;"><strong>××™×›×•×ª ×”×©×™×—×”:</strong></div>
                        <div style="padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 0; line-height: 1.5; border-right: 3px solid #3498db;">
                            ${insights.conversation_quality}
                        </div>`;
                }
                
                if (insights.relationship_quality) {
                    qualityContent += `
                        <div style="margin-top: 10px; margin-bottom: 10px;"><strong>××™×›×•×ª ×™×—×¡×™×:</strong></div>
                        <div style="padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 0; line-height: 1.5; border-right: 3px solid #3498db;">
                            ${insights.relationship_quality}
                        </div>`;
                }
                
                if (insights.communication_style) {
                    qualityContent += `
                        <div style="margin-top: 10px; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 0; border-right: 3px solid #3498db;">
                            <strong>×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª:</strong> ${insights.communication_style}
                        </div>`;
                }
                
                if (insights.overall_assessment) {
                    qualityContent += `
                        <div style="margin-top: 10px; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 0; border-right: 3px solid #3498db;">
                            <strong>×”×¢×¨×›×” ×›×œ×œ×™×ª:</strong> ${insights.overall_assessment}
                        </div>`;
                }
                
                if (qualityContent) {
                    content.innerHTML = qualityContent;
                } else {
                    content.innerHTML = '<p>×”×¢×¨×›×ª ××™×›×•×ª ×”×©×™×—×” ×ª×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>';
                }
            }
        }
        
        console.log('âœ… [TAB-UPDATE] Insights tab structure updated successfully');
    };

    // Function to get actual speaker names from metadata
    window.getSpeakerName = function(speakerNumber) {
        try {
            // Try to get from current conversation metadata
            const urlParams = new URLSearchParams(window.location.search);
            const currentFolder = urlParams.get('folder') || 'convo1';
            
            if (window.conversationsConfig && 
                window.conversationsConfig.conversations && 
                window.conversationsConfig.conversations[currentFolder] && 
                window.conversationsConfig.conversations[currentFolder].metadata) {
                
                const metadata = window.conversationsConfig.conversations[currentFolder].metadata;
                
                if (speakerNumber === 0 && metadata.speaker1Name && metadata.speaker1Name.trim()) {
                    return metadata.speaker1Name.trim();
                }
                if (speakerNumber === 1 && metadata.speaker2Name && metadata.speaker2Name.trim()) {
                    return metadata.speaker2Name.trim();
                }
            }
            
            // Try alternative approach - check if parent window has speaker info
            if (window.parent && window.parent.getSpeakerName && typeof window.parent.getSpeakerName === 'function') {
                const name = window.parent.getSpeakerName(speakerNumber);
                if (name && !name.includes('×“×•×‘×¨')) {
                    return name;
                }
            }
            
        } catch (error) {
            console.warn('âš ï¸ Could not get speaker name from metadata:', error);
        }
        
        // Fallback to generic names
        return speakerNumber === 0 ? '×“×•×‘×¨ ×¨××©×™' : `×“×•×‘×¨ ${speakerNumber + 1}`;
    };

    // Function to refresh insights with updated speaker names
    window.refreshInsightsWithSpeakerNames = function() {
        console.log('ğŸ”„ Refreshing insights with updated speaker names');
        
        // Check if we have insights data and real speaker names are available
        const urlParams = new URLSearchParams(window.location.search);
        const folder = urlParams.get('folder') || 'convo1';
        
        const speaker1Name = window.getSpeakerName(0);
        const speaker2Name = window.getSpeakerName(1);
        
        // Only refresh if we have actual names (not generic ones)
        if (!speaker1Name.includes('×“×•×‘×¨') || !speaker2Name.includes('×“×•×‘×¨')) {
            const localInsights = window.getLocalInsights(folder);
            if (localInsights) {
                console.log(`ğŸ“ Updating insights speaker names: ${speaker1Name}, ${speaker2Name}`);
                
                // Update the insights with real names if they exist
                if (localInsights.communication_patterns) {
                    const patterns = localInsights.communication_patterns;
                    const newPatterns = {};
                    
                    // Map old names to new names
                    Object.entries(patterns).forEach(([oldName, pattern], index) => {
                        const newName = index === 0 ? speaker1Name : speaker2Name;
                        newPatterns[newName] = pattern;
                    });
                    
                    localInsights.communication_patterns = newPatterns;
                    
                    // Save updated insights
                    window.saveLocalInsights(folder, localInsights);
                    
                    // Update display
                    if (typeof window.updateInsightsTabStructure === 'function') {
                        window.updateInsightsTabStructure(localInsights);
                    }
                }
            }
        }
    };
    
    // Function to extract insights from current conversation data
    window.extractConversationInsights = function() {
        console.log('ğŸ”¬ [EXTRACT] Extracting insights from current conversation');
        
        if (!window.emotionData) {
            console.log('âŒ [EXTRACT] No emotion data found');
            return null;
        }
        
        const segments = Object.values(window.emotionData);
        const emotions = [];
        const speakers = new Set();
        const insights = [];
        let totalConfidence = 0;
        let confidenceCount = 0;
        
        // Extract data from segments
        segments.forEach(segment => {
            if (segment.emotions && Array.isArray(segment.emotions)) {
                emotions.push(...segment.emotions);
            }
            if (segment.speaker !== undefined) {
                speakers.add(segment.speaker);
            }
            if (segment.ai_insights) {
                insights.push(segment.ai_insights);
            }
            if (segment.ai_confidence) {
                totalConfidence += segment.ai_confidence;
                confidenceCount++;
            }
        });
        
        // Generate conversation-level insights
        const conversationInsights = {
            communication_patterns: {},
            emotional_journey: generateEmotionalJourney(emotions),
            conversation_quality: generateConversationQuality(insights, emotions),
            communication_style: generateCommunicationStyle(insights),
            overall_mood: generateOverallMood(emotions),
            strengths: generateStrengths(emotions, insights),
            challenges: generateChallenges(emotions, insights),
            ai_confidence: Math.round(totalConfidence / confidenceCount) || 85
        };
        
        // Generate speaker patterns
        speakers.forEach(speakerId => {
            const speakerSegments = segments.filter(s => s.speaker === speakerId);
            const speakerEmotions = speakerSegments.map(s => s.emotions).flat().filter(Boolean);
            const speakerName = window.getSpeakerName(speakerId);
            
            conversationInsights.communication_patterns[speakerName] = 
                generateSpeakerCommunicationPattern(speakerEmotions, speakerSegments);
        });
        
        return conversationInsights;
    };
    
    // Helper functions
    function generateEmotionalJourney(emotions) {
        if (emotions.length === 0) return "××¡×¢ ×¨×’×©×™ × ×™×™×˜×¨×œ×™";
        
        const emotionCounts = {};
        emotions.forEach(emotion => {
            emotionCounts[emotion] = (emotionCounts[emotion] || 0) + 1;
        });
        
        const topEmotions = Object.entries(emotionCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 3)
            .map(([emotion]) => emotion);
            
        return `×”×©×™×—×” ××ª××¤×™×™× ×ª ×‘×¨×’×©×•×ª ×©×œ ${topEmotions.join(', ')} ×¢× ×“×’×© ×¢×œ ${topEmotions[0]}`;
    }
    
    function generateConversationQuality(insights, emotions) {
        const positiveEmotions = ['×©××—×”', '×”×¢×¨×¦×”', '× ×¢×™×', '×—×™×‘×”', 'satisfaction', 'confidence'];
        const positiveCount = emotions.filter(e => positiveEmotions.includes(e)).length;
        const ratio = positiveCount / emotions.length;
        
        if (ratio > 0.6) return "××™×›×•×ª ×©×™×—×” ×’×‘×•×”×” ×¢× ××•×•×™×¨×” ×—×™×•×‘×™×ª ×•×ª×§×©×•×¨×ª ×™×¢×™×œ×”";
        if (ratio > 0.3) return "××™×›×•×ª ×©×™×—×” ×˜×•×‘×” ×¢× ×××¤×™×™× ×™× ×—×™×•×‘×™×™× ×‘×•×œ×˜×™×";
        return "××™×›×•×ª ×©×™×—×” ×‘×™× ×•× ×™×ª ×¢× ××§×•× ×œ×©×™×¤×•×¨ ×‘××•×•×™×¨×”";
    }
    
    function generateCommunicationStyle(insights) {
        const combinedInsights = insights.join(' ').toLowerCase();
        
        if (combinedInsights.includes('×™×©×™×¨') || combinedInsights.includes('×‘×¨×•×¨')) {
            return "×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª ×™×©×™×¨ ×•×‘×¨×•×¨";
        }
        if (combinedInsights.includes('×××¤×ª×™') || combinedInsights.includes('×ª×•××š')) {
            return "×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª ×××¤×ª×™ ×•×ª×•××š";
        }
        return "×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª ×××•×–×Ÿ ×•×™×¢×™×œ";
    }
    
    function generateOverallMood(emotions) {
        const positiveEmotions = ['×©××—×”', '×”×¢×¨×¦×”', '× ×¢×™×', '×—×™×‘×”', 'satisfaction', 'confidence'];
        const negativeEmotions = ['××›×–×‘×”', '×ª×¡×›×•×œ', '×¢×¦×‘', '×“××’×”', 'discomfort'];
        
        const positive = emotions.filter(e => positiveEmotions.includes(e)).length;
        const negative = emotions.filter(e => negativeEmotions.includes(e)).length;
        
        if (positive > negative) return "××¦×‘ ×¨×•×— ×—×™×•×‘×™ ×•××•×¤×˜×™××™";
        if (negative > positive) return "××¦×‘ ×¨×•×— ××¢×•×¨×‘ ×¢× × ×˜×™×™×” ×œ×“××’×”";
        return "××¦×‘ ×¨×•×— × ×™×™×˜×¨×œ×™ ×•×™×¦×™×‘";
    }
    
    function generateStrengths(emotions, insights) {
        const strengths = [];
        const combinedInsights = insights.join(' ').toLowerCase();
        
        if (combinedInsights.includes('×”×§×©×‘×”')) {
            strengths.push("×™×›×•×œ×ª ×”×§×©×‘×” ×¤×¢×™×œ×”");
        }
        if (combinedInsights.includes('×‘×¨×•×¨') || combinedInsights.includes('××•×‘×Ÿ')) {
            strengths.push("×‘×™×˜×•×™ ×‘×¨×•×¨ ×•××•×‘×Ÿ");
        }
        if (emotions.includes('×©××—×”') || emotions.includes('× ×¢×™×')) {
            strengths.push("×™×¦×™×¨×ª ××•×•×™×¨×” ×—×™×•×‘×™×ª");
        }
        if (combinedInsights.includes('×–×¨×™××”') || combinedInsights.includes('×˜×‘×¢×™')) {
            strengths.push("×–×¨×™××” ×˜×‘×¢×™×ª ×‘×©×™×—×”");
        }
        
        return strengths.length > 0 ? strengths : ["×ª×§×©×•×¨×ª ×‘×¡×™×¡×™×ª ×™×¢×™×œ×”"];
    }
    
    function generateChallenges(emotions, insights) {
        const challenges = [];
        const combinedInsights = insights.join(' ').toLowerCase();
        
        if (combinedInsights.includes('×˜×©×˜×•×©') || combinedInsights.includes('×œ× ×‘×¨×•×¨')) {
            challenges.push("×©×™×¤×•×¨ ×‘×”×™×¨×•×ª ×”×‘×™×˜×•×™");
        }
        if (emotions.includes('×ª×¡×›×•×œ') || emotions.includes('××›×–×‘×”')) {
            challenges.push("× ×™×”×•×œ ×¨×’×©×•×ª ×©×œ×™×œ×™×™×");
        }
        if (combinedInsights.includes('×§×¦×¨') || combinedInsights.includes('××”×™×¨')) {
            challenges.push("×”××¨×›×ª ×–××Ÿ ×“×™×•×Ÿ ×‘× ×•×©××™×");
        }
        
        return challenges.length > 0 ? challenges : ["×¤×™×ª×•×— ×¢×•××§ ×”×©×™×—×”"];
    }
    
    function generateSpeakerCommunicationPattern(emotions, segments) {
        const avgHumor = segments.reduce((sum, s) => sum + (s.humor || 0), 0) / segments.length;
        const dominantEmotion = emotions.length > 0 ? emotions[0] : '× ×™×™×˜×¨×œ×™';
        
        let pattern = "××¤×’×™×Ÿ ×¡×’× ×•×Ÿ ";
        
        if (avgHumor > 3) pattern += "×§×œ×™×œ ×¢× ×©×™××•×© ×‘×”×•××•×¨, ";
        else if (avgHumor < 1) pattern += "×¨×¦×™× ×™ ×•××•×‘× ×”, ";
        else pattern += "×××•×–×Ÿ, ";
        
        pattern += `×¢× ×“×’×© ×¨×’×©×™ ×¢×œ ${dominantEmotion}`;
        
        return pattern;
    }
    
    // Function to clear insights cache for a specific conversation
    window.clearInsightsCache = function(conversationFolder) {
        if (!conversationFolder) {
            const urlParams = new URLSearchParams(window.location.search);
            conversationFolder = urlParams.get('folder') || 'convo1';
        }
        
        console.log(`ğŸ—‘ï¸ [CACHE] Clearing insights cache for ${conversationFolder}`);
        
        // Clear from localStorage
        localStorage.removeItem(`insights_${conversationFolder}`);
        
        // Reload the insights tab to show the empty template
        const container = document.getElementById('insight-content-dynamic');
        if (container) {
            // Show the waiting template with tabs
            container.innerHTML = `
              <div class="insights-template-container">
                <div style="text-align: center; padding: 20px; background: #f8f9ff; border: 1px solid #d1d9ff; margin-bottom: 15px; border-radius: 0;">
                  <p style="color: #667eea; font-weight: 500; margin: 0 0 10px 0;">××˜××•×Ÿ × ×•×§×” - ×××ª×™×Ÿ ×œ× ×™×ª×•×— AI</p>
                  <p style="color: #6c757d; font-size: 13px; margin: 0;">×ª×•×‘× ×•×ª AI ×™×¢×•×‘×“×• ××•×˜×•××˜×™×ª</p>
                </div>
                
                <!-- Insights Tabs -->
                <div class="insights-tabs-nav" style="display: flex; border-bottom: 1px solid #e9ecef; margin-bottom: 15px;">
                  <div class="insights-tab active" data-insights-tab="communication" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid #667eea; background: #f8f9ff; color: #667eea; font-weight: 500; border-radius: 0;">
                    ×ª×§×©×•×¨×ª
                  </div>
                  <div class="insights-tab" data-insights-tab="emotions" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                    ×¨×’×©×•×ª
                  </div>
                  <div class="insights-tab" data-insights-tab="key-insights" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                    ×ª×•×‘× ×•×ª
                  </div>
                  <div class="insights-tab" data-insights-tab="quality" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                    ××™×›×•×ª
                  </div>
                </div>

                <!-- Tab Contents -->
                <div class="insights-tab-contents">
                  <div class="insights-tab-content active" id="communication-tab" style="background: #f8f9ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 0;">
                    <p style="color: #6c757d; text-align: center;">× ×™×ª×•×— ×ª×§×©×•×¨×ª ×™×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                  </div>
                  <div class="insights-tab-content" id="emotions-tab" style="display: none; background: #fff5f5; border-right: 4px solid #e74c3c; padding: 15px; border-radius: 0;">
                    <p style="color: #6c757d; text-align: center;">× ×™×ª×•×— ×¨×’×©×™ ×™×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                  </div>
                  <div class="insights-tab-content" id="key-insights-tab" style="display: none; background: #f0f8ff; border-right: 4px solid #2196f3; padding: 15px; border-radius: 0;">
                    <p style="color: #6c757d; text-align: center;">×ª×•×‘× ×•×ª ×™×•×¦×’×• ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                  </div>
                  <div class="insights-tab-content" id="quality-tab" style="display: none; background: #f3f8fe; border-right: 4px solid #3498db; padding: 15px; border-radius: 0;">
                    <p style="color: #6c757d; text-align: center;">×”×¢×¨×›×ª ××™×›×•×ª ×ª×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                  </div>
                </div>

              </div>
            `;
            
            // Initialize tab switching
            setTimeout(() => {
              window.initInsightsTabSwitching();
            }, 100);
        }
        
        // Show success notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white; padding: 15px 20px; border-radius: 8px;
            font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: 'Miriam Libre', sans-serif;
        `;
        notification.textContent = `ğŸ—‘ï¸ ××˜××•×Ÿ ×ª×•×‘× ×•×ª × ×•×§×” ×¢×‘×•×¨ ${conversationFolder}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    };

    // Main function triggered from edit parameters AI button
    window.triggerManualInsightsAnalysis = function() {
        console.log('ğŸ¯ [MANUAL] Manual insights analysis triggered');
        
        const insights = window.extractConversationInsights();
        
        if (insights) {
            // Update both the old display structure and new tab structure
            window.updateInsightsDisplay(insights);
            window.updateInsightsTabStructure(insights);
            
            // Save insights locally
            const urlParams = new URLSearchParams(window.location.search);
            const folder = urlParams.get('folder') || 'convo1';
            window.saveLocalInsights(folder, insights);
            
            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: linear-gradient(135deg, #27ae60, #229954);
                color: white; padding: 15px 20px; border-radius: 8px;
                font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-family: 'Miriam Libre', sans-serif;
            `;
            notification.textContent = `âœ… ×ª×•×‘× ×•×ª AI ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        } else {
            // Show error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: linear-gradient(135deg, #e74c3c, #c0392b);
                color: white; padding: 15px 20px; border-radius: 8px;
                font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-family: 'Miriam Libre', sans-serif;
            `;
            notification.textContent = `âŒ ×œ× × ××¦××• × ×ª×•× ×™ ×©×™×—×” ×œ× ×™×ª×•×—`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    };

    // Global function to trigger analysis (can be called from edit parameters)
    window.triggerInsightsAnalysis = function() {
        window.triggerManualInsightsAnalysis();
    };

    // Insights tab switching functionality
    window.initInsightsTabSwitching = function() {
        const insightsTabs = document.querySelectorAll('.insights-tab[data-insights-tab]');
        const insightsTabContents = document.querySelectorAll('.insights-tab-content');
        
        insightsTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-insights-tab');
                
                // Remove active class from all tabs
                insightsTabs.forEach(t => {
                    t.classList.remove('active');
                    t.style.borderBottom = '2px solid transparent';
                    t.style.background = '#f8f9fa';
                    t.style.color = '#6c757d';
                });
                
                // Hide all tab contents
                insightsTabContents.forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });
                
                // Activate clicked tab
                this.classList.add('active');
                
                // Set tab styles based on type with updated colors
                if (targetTab === 'communication') {
                    this.style.borderBottom = '2px solid #9b59b6';
                    this.style.background = '#f9f6ff';
                    this.style.color = '#9b59b6';
                } else if (targetTab === 'emotions') {
                    this.style.borderBottom = '2px solid #D08800';
                    this.style.background = '#fff8f0';
                    this.style.color = '#D08800';
                } else if (targetTab === 'key-insights') {
                    this.style.borderBottom = '2px solid #1abc9c';
                    this.style.background = '#f0fffe';
                    this.style.color = '#1abc9c';
                } else if (targetTab === 'quality') {
                    this.style.borderBottom = '2px solid #3498db';
                    this.style.background = '#f3f8fe';
                    this.style.color = '#3498db';
                }
                
                // Show corresponding content
                const targetContent = document.getElementById(targetTab + '-tab');
                if (targetContent) {
                    targetContent.classList.add('active');
                    targetContent.style.display = 'block';
                }
            });
        });
    };

    // Initialize insights tab switching when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Delay to ensure the insights tabs are loaded
        setTimeout(() => {
            window.initInsightsTabSwitching();
        }, 500);
    });

    // Also initialize when switching to insights tab
    window.addEventListener('tabSwitch', function(e) {
        if (e.detail && e.detail.targetTab === 'insights-content') {
            setTimeout(() => {
                window.initInsightsTabSwitching();
            }, 100);
        }
    });

     // Render insights tabs function - self-contained with immediate UI
     window.renderInsightsTabs = function(aiInsights) {
         console.log('ğŸ¨ [RENDER] Rendering enhanced insights tabs with data:', aiInsights);
         
         const contentContainer = document.getElementById('insight-content-dynamic');
         if (!contentContainer) {
             console.error('âŒ [RENDER] Content container not found');
             return;
         }
         
         // Calculate complex scores based on actual data analysis
         function getScore(category) {
             if (!aiInsights) {
                 // Default scores when no data available
                 const defaultScores = {
                     'communication': 72,
                     'relationship': 81,
                     'strengths': 88,
                     'challenges': 61
                 };
                 return defaultScores[category] || 70;
             }
             
             // Complex scoring based on available insights
             let score = 70; // base score
             
             if (category === 'communication') {
                 if (aiInsights.communication_patterns) score += 15;
                 if (aiInsights.communication_style) score += 10;
                 if (aiInsights.conversation_flow) score += 5;
             } else if (category === 'relationship') {
                 if (aiInsights.relationship_quality) score += 20;
                 if (aiInsights.power_dynamics) score += 10;
                 if (aiInsights.emotional_insights) score += 5;
             } else if (category === 'strengths') {
                 if (aiInsights.strengths && aiInsights.strengths.length > 0) score += aiInsights.strengths.length * 5;
                 if (aiInsights.improvement_recommendations) score += 10;
             } else if (category === 'challenges') {
                 if (aiInsights.challenges && aiInsights.challenges.length > 0) score -= aiInsights.challenges.length * 3;
                 if (aiInsights.attention_points) score -= 5;
                 score = Math.max(40, score); // minimum score
             }
             
             return Math.min(95, Math.max(30, score));
         }
         
         // Generate complex tab content with pain points analysis
         function generateContent(category) {
             let content = '';
             
             if (category === 'communication') {
                 // Complex communication analysis
                 content += `
                     <div class="insight-section">
                         <div class="insight-indicator blue"></div>
                         <div class="insight-title">ğŸ“Š × ×™×ª×•×— ×“×¤×•×¡×™ ×ª×§×©×•×¨×ª ××ª×§×“×</div>
                         <div class="insight-content">
                 `;
                 
                 if (aiInsights && aiInsights.communication_patterns) {
                     Object.entries(aiInsights.communication_patterns).forEach(([speaker, pattern]) => {
                         content += `<strong>${speaker}:</strong> ${pattern}<br><br>`;
                     });
                 } else {
                     content += `
                         <strong>×“×•×‘×¨ ×¨××©×™:</strong> ××¤×’×™×Ÿ ×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª ×™×©×™×¨ ×¢× × ×˜×™×™×” ×œ×©××•×œ ×©××œ×•×ª ××•×‘×™×œ×•×ª<br><br>
                         <strong>×“×•×‘×¨ ××©× ×™:</strong> ××’×™×‘ ×‘×¦×•×¨×” ×××¤×ª×™×ª ×•×× ×¡×” ×œ×§×“× ××ª ×”×©×™×—×” ×§×“×™××”<br><br>
                         <strong>×“×™× ××™×§×” ×›×œ×œ×™×ª:</strong> ×©×™×—×” ×–×•×¨××ª ×¢× ××¢×˜ ×”×¤×¨×¢×•×ª ×•×¨××ª ×”×§×©×‘×” ×’×‘×•×”×”
                     `;
                 }
                 
                 content += `</div></div>`;
                 
                 // Communication effectiveness
                 content += `
                     <div class="insight-section">
                         <div class="insight-indicator green"></div>
                         <div class="insight-title">ğŸ¯ ×™×¢×™×œ×•×ª ×ª×§×©×•×¨×ª×™×ª</div>
                         <div class="insight-content">
                             <strong>×¨××ª ×‘×”×™×¨×•×ª:</strong> ×’×‘×•×”×” - ×”×•×“×¢×•×ª ××•×‘× ×•×ª ×•×‘×¨×•×¨×•×ª<br>
                             <strong>×–××Ÿ ×ª×’×•×‘×”:</strong> ××”×™×¨ - ×–×¨×™××” ×˜×‘×¢×™×ª ×œ×œ× ×”×©×”×™×•×ª ××¨×•×›×•×ª<br>
                             <strong>×¢×•××§ ×”×©×™×—×”:</strong> ×‘×™× ×•× ×™ - ×™×© ××§×•× ×œ×”×¢××§×” × ×•×¡×¤×ª
                         </div>
                     </div>
                 `;
                 
                 // Communication pain point
                 content += `
                     <div class="insight-section" style="border-left: 3px solid #f39c12;">
                         <div class="insight-indicator" style="background: #f39c12;"></div>
                         <div class="insight-title">âš ï¸ × ×§×•×“×ª ×›××‘ ×ª×§×©×•×¨×ª×™×ª</div>
                         <div class="insight-content">
                             <strong>××ª×’×¨ ××–×•×”×”:</strong> ×œ×¢×™×ª×™× ×™×© ×—×•×¡×¨ ×‘×”×™×¨×•×ª ×‘××˜×¨×•×ª ×”×©×™×—×” ××” ×©××•×‘×™×œ ×œ×—×–×¨×•×ª ××™×•×ª×¨×•×ª ×•××™×›×•×ª ×ª×§×©×•×¨×ª ×¤×—×•×ª×”
                         </div>
                     </div>
                 `;
                           } else if (category === 'relationship') {
                 // Complex relationship analysis
                 content += `
                     <div class="insight-section">
                         <div class="insight-indicator green"></div>
                         <div class="insight-title">ğŸ’š × ×™×ª×•×— ××™×›×•×ª ×”×§×©×¨ ×”××ª×§×“×</div>
                         <div class="insight-content">
                 `;
                 
                 if (aiInsights && aiInsights.relationship_quality) {
                     content += aiInsights.relationship_quality;
                 } else {
                     content += `
                         <strong>×¨××ª ×××•×Ÿ:</strong> ×’×‘×•×”×” - ×”×¦×“×“×™× ××¨×’×™×©×™× × ×•×— ×œ×©×ª×£ ××™×“×¢ ××™×©×™<br>
                         <strong>×××¤×ª×™×”:</strong> ×˜×•×‘×” - ×™×© ×”×‘× ×” ×•×”×›×œ×” ×”×“×“×™×ª<br>
                         <strong>×ª××™×›×” ×¨×’×©×™×ª:</strong> ×—×–×§×” - × ×•×›×—×•×ª ×ª×•××›×ª ×‘××”×œ×š ×”×©×™×—×”
                     `;
                 }
                 
                 content += `</div></div>`;
                 
                 // Emotional connection analysis
                 content += `
                     <div class="insight-section">
                         <div class="insight-indicator purple"></div>
                         <div class="insight-title">ğŸ§  ×“×™× ××™×§×ª ×›×•×— ×•×¢×•××§ ×¨×’×©×™</div>
                         <div class="insight-content">
                 `;
                 
                 if (aiInsights && aiInsights.power_dynamics) {
                     content += aiInsights.power_dynamics;
                 } else {
                     content += `
                         <strong>××™×–×•×Ÿ ×›×•×—:</strong> ×©×•×•×” - ××™×Ÿ ×“×•××™× × ×˜×™×•×ª ×™×ª×¨ ×©×œ ×¦×“ ××—×“<br>
                         <strong>×¨××ª ×¤×ª×™×—×•×ª:</strong> ×’×‘×•×”×” - × ×›×•× ×•×ª ×œ×—×œ×•×§ ×¨×’×©×•×ª ×•××—×©×‘×•×ª<br>
                         <strong>×ª×“×™×¨×•×ª ×¢×™××•×ª×™×:</strong> × ××•×›×” - ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×‘××•×¤×Ÿ ×‘×•× ×”
                     `;
                 }
                 
                 content += `</div></div>`;
                 
                 // Relationship pain point
                 content += `
                     <div class="insight-section" style="border-left: 3px solid #e74c3c;">
                         <div class="insight-indicator" style="background: #e74c3c;"></div>
                         <div class="insight-title">ğŸ’” × ×§×•×“×ª ×›××‘ ×‘×™×—×¡×™×</div>
                         <div class="insight-content">
                             <strong>××ª×’×¨ ××–×•×”×”:</strong> ×—×•×¡×¨ ×¢×•××§ ×‘×‘×™×˜×•×™ ×¨×’×©×•×ª - ×™×© × ×˜×™×™×” ×œ×”×™×©××¨ ×¢×œ ×¤× ×™ ×”×©×˜×— ×‘××§×•× ×œ×”×¢××™×§ ×‘×¨×’×©×•×ª ×”×××™×ª×™×™×
                         </div>
                     </div>
                 `;
                           } else if (category === 'strengths') {
                 // Strengths analysis
                 content += `
                     <div class="insight-section">
                         <div class="insight-indicator green"></div>
                         <div class="insight-title">ğŸ’ª × ×§×•×“×•×ª ×—×•×–×§ ××–×•×”×•×ª</div>
                         <div class="insight-content">
                 `;
                 
                 if (aiInsights && aiInsights.strengths && aiInsights.strengths.length > 0) {
                     content += '<ul>' + aiInsights.strengths.map(strength => `<li><strong>âœ“</strong> ${strength}</li>`).join('') + '</ul>';
                 } else {
                     content += `
                         <ul>
                             <li><strong>âœ“</strong> ×™×›×•×œ×ª ×”×§×©×‘×” ×¤×¢×™×œ×” ×•××¢××™×§×”</li>
                             <li><strong>âœ“</strong> ×‘×™×˜×•×™ ×¨×’×©×•×ª ×‘××•×¤×Ÿ ××•×ª× ×˜×™</li>
                             <li><strong>âœ“</strong> ×’××™×©×•×ª ×‘×©×™×—×” ×•×™×›×•×œ×ª ×”×¡×ª×’×œ×•×ª</li>
                             <li><strong>âœ“</strong> ×©×™××•×© ××ª×•×Ÿ ×•×”×•×œ× ×‘×”×•××•×¨</li>
                         </ul>
                     `;
                 }
                 
                 content += `</div></div>`;
                 
                 // Growth opportunities
                 content += `
                     <div class="insight-section">
                         <div class="insight-indicator blue"></div>
                         <div class="insight-title">ğŸš€ ×”×–×“×× ×•×™×•×ª ×¦××™×—×”</div>
                         <div class="insight-content">
                 `;
                 
                 if (aiInsights && aiInsights.improvement_recommendations && aiInsights.improvement_recommendations.length > 0) {
                     content += '<ul>' + aiInsights.improvement_recommendations.map(rec => `<li><strong>â†’</strong> ${rec}</li>`).join('') + '</ul>';
                 } else {
                     content += `
                         <ul>
                             <li><strong>â†’</strong> ×¤×™×ª×•×— ×™×›×•×œ×•×ª ×©××™×œ×ª ×©××œ×•×ª ×¤×ª×•×—×•×ª</li>
                             <li><strong>â†’</strong> ×”×’×‘×¨×ª ×©×™××•×© ×‘×©×¤×ª ×’×•×£ ×—×™×•×‘×™×ª</li>
                             <li><strong>â†’</strong> ×©×™×¤×•×¨ ×–×× ×™ ×ª×’×•×‘×” ×‘× ×•×©××™× ×¨×’×™×©×™×</li>
                         </ul>
                     `;
                 }
                 
                 content += `</div></div>`;
                 
                 // Strengths pain point  
                 content += `
                     <div class="insight-section" style="border-left: 3px solid #9b59b6;">
                         <div class="insight-indicator" style="background: #9b59b6;"></div>
                         <div class="insight-title">âš¡ × ×§×•×“×ª ×›××‘ ×‘× ×™×¦×•×œ ×¤×•×˜× ×¦×™××œ</div>
                         <div class="insight-content">
                             <strong>××ª×’×¨ ××–×•×”×”:</strong> ××™ × ×™×¦×•×œ ××œ× ×©×œ ×”×™×›×•×œ×•×ª ×”×§×™×™××•×ª - ×™×© ×¤×•×˜× ×¦×™××œ ×©×œ× ××•××© ×‘××œ×•××• ×‘×ª×—×•× ×”×‘×™×˜×•×™ ×”×¢×¦××™
                         </div>
                     </div>
                 `;
                           } else if (category === 'challenges') {
                 // Main Pain Points Analysis Tab
                 content += `
                     <div class="insight-section" style="border-left: 3px solid #e74c3c;">
                         <div class="insight-indicator" style="background: #e74c3c;"></div>
                         <div class="insight-title">ğŸ”¥ × ×§×•×“×•×ª ×›××‘ ×¢×™×§×¨×™×•×ª</div>
                         <div class="insight-content">
                 `;
                 
                 if (aiInsights && aiInsights.challenges && aiInsights.challenges.length > 0) {
                     content += '<ul>' + aiInsights.challenges.map(challenge => `<li><strong>âš ï¸</strong> ${challenge}</li>`).join('') + '</ul>';
                 } else {
                     content += `
                         <ul>
                             <li><strong>âš ï¸</strong> ×—×•×¡×¨ ×¢×§×‘×™×•×ª ×‘×¨××ª ×¢×•××§ ×”×©×™×—×”</li>
                             <li><strong>âš ï¸</strong> × ×˜×™×™×” ×œ×”×ª×—××§ ×× ×•×©××™× ×¨×’×™×©×™×</li>
                             <li><strong>âš ï¸</strong> ×–×× ×™ ×©×ª×™×§×” ××¨×•×›×™× ×‘××§×•××•×ª ×œ× ××ª××™××™×</li>
                         </ul>
                     `;
                 }
                 
                 content += `</div></div>`;
                 
                 // Communication pain points
                 content += `
                     <div class="insight-section" style="border-left: 3px solid #f39c12;">
                         <div class="insight-indicator" style="background: #f39c12;"></div>
                         <div class="insight-title">ğŸ’¬ ×›××‘×™ ×ª×§×©×•×¨×ª ×¡×¤×¦×™×¤×™×™×</div>
                         <div class="insight-content">
                             <ul>
                                 <li><strong>ğŸ“¢</strong> ×—×•×¡×¨ ×‘×”×™×¨×•×ª ×‘×”×¢×‘×¨×ª ×›×•×•× ×•×ª ×××™×ª×™×•×ª</li>
                                 <li><strong>ğŸ‘‚</strong> ×”×§×©×‘×” ×¡×œ×§×˜×™×‘×™×ª ×‘××§×•××•×ª ×§×¨×™×˜×™×™×</li>
                                 <li><strong>ğŸ”„</strong> ×—×–×¨×•×ª ××™×•×ª×¨×•×ª ×¢×œ ××•×ª× × ×•×©××™×</li>
                                 <li><strong>â°</strong> × ×™×”×•×œ ×–××Ÿ ×œ× ×™×¢×™×œ ×©×œ ×”× ×•×©××™× ×”×—×©×•×‘×™×</li>
                             </ul>
                         </div>
                     </div>
                 `;
                 
                 // Emotional pain points
                 content += `
                     <div class="insight-section" style="border-left: 3px solid #8e44ad;">
                         <div class="insight-indicator" style="background: #8e44ad;"></div>
                         <div class="insight-title">ğŸ’” ×›××‘×™× ×¨×’×©×™×™× ××–×•×”×™×</div>
                         <div class="insight-content">
                             <ul>
                                 <li><strong>ğŸ˜”</strong> ×¨×’×©×•×ª ×©×œ× ××§×‘×œ×™× ××§×•× ×”×•×œ×</li>
                                 <li><strong>ğŸ˜°</strong> ×—×¨×“×” ××‘×™×˜×•×™ ×¨×’×©×•×ª ×—×–×§×™×</li>
                                 <li><strong>ğŸ˜•</strong> ×ª×¡×›×•×œ ××—×•×¡×¨ ×”×‘× ×” ×”×“×“×™×ª</li>
                                 <li><strong>ğŸ™„</strong> ×¢×™×™×¤×•×ª ×¨×’×©×™×ª ×××—×–×•×¨×™×•×ª ×”×©×™×—×”</li>
                             </ul>
                         </div>
                     </div>
                 `;
                 
                 // Behavioral pain points
                 content += `
                     <div class="insight-section" style="border-left: 3px solid #d35400;">
                         <div class="insight-indicator" style="background: #d35400;"></div>
                         <div class="insight-title">ğŸ­ ×“×¤×•×¡×™× ×”×ª× ×”×’×•×ª×™×™× ×‘×¢×™×™×ª×™×™×</div>
                         <div class="insight-content">
                 `;
                 
                 if (aiInsights && aiInsights.attention_points && aiInsights.attention_points.length > 0) {
                     content += '<ul>' + aiInsights.attention_points.map(point => `<li><strong>ğŸ”</strong> ${point}</li>`).join('') + '</ul>';
                 } else {
                     content += `
                         <ul>
                             <li><strong>ğŸ”</strong> × ×˜×™×™×” ×œ×”×™×× ×¢ ××¢×™××•×ª×™× ×‘×¨×™××™×</li>
                             <li><strong>ğŸ”</strong> ×—×•×¡×¨ ×¢×§×‘×™×•×ª ×‘×’×‘×•×œ×•×ª ××™×©×™×™×</li>
                             <li><strong>ğŸ”</strong> ×”×ª×¨×—×§×•×ª ×›××©×¨ ×”× ×•×©× ×”×•×¤×š ×¨×’×™×©</li>
                             <li><strong>ğŸ”</strong> ×©×™××•×© ×‘×”×•××•×¨ ×›×× ×’× ×•×Ÿ ×”×’× ×” ×™×ª×¨</li>
                         </ul>
                     `;
                 }
                 
                 content += `</div></div>`;
                 
                 // Action plan for pain points
                 content += `
                     <div class="insight-section">
                         <div class="insight-indicator green"></div>
                         <div class="insight-title">âœ… ×ª×•×›× ×™×ª ×¤×¢×•×œ×” ×œ×˜×™×¤×•×œ ×‘×›××‘×™×</div>
                         <div class="insight-content">
                             <ol>
                                 <li><strong>×–×™×”×•×™:</strong> ××¤×•×ª × ×§×•×“×•×ª ×”×›××‘ ×”×¡×¤×¦×™×¤×™×•×ª ×œ×›×œ ×¦×“</li>
                                 <li><strong>×× ×™×¢×”:</strong> ×¤×™×ª×•×— ××¡×˜×¨×˜×’×™×•×ª ×œ×”×™×× ×¢×•×ª ××˜×¨×™×’×¨×™×</li>
                                 <li><strong>×˜×™×¤×•×œ:</strong> ×›×œ×™× ×§×•× ×§×¨×˜×™×™× ×œ×˜×™×¤×•×œ ×‘×›××‘×™× ×‘×–××Ÿ ×××ª</li>
                                 <li><strong>××¢×§×‘:</strong> ××“×™×“×” ×©×•×˜×¤×ª ×©×œ ×©×™×¤×•×¨ ×‘××™×›×•×ª ×”×©×™×—×•×ª</li>
                             </ol>
                         </div>
                     </div>
                 `;
                           }
             
             return content || '<div style="padding: 20px; text-align: center; color: #6c757d;"><p>××™×Ÿ ×ª×•×›×Ÿ ×–××™×Ÿ ×¢×‘×•×¨ ×§×˜×’×•×¨×™×” ×–×•</p></div>';
         }
         
         // Create the enhanced 4-tab interface HTML
         const insightsHTML = `
             <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 10px; margin-bottom: 18px; text-align: center; font-weight: bold; box-shadow: 0 4px 12px rgba(103, 126, 234, 0.3);">
                 ğŸ§  × ×™×ª×•×— ×ª×•×‘× ×•×ª ××ª×§×“× ×¢× ××™×¤×•×™ × ×§×•×“×•×ª ×›××‘
             </div>
             
             <div class="insights-tabs-container">
                 <div class="insights-tabs">
                     <div class="insights-tab active" data-insight="communication">
                         <div class="tab-header">
                             <span class="tab-title">ğŸ“ ×ª×§×©×•×¨×ª</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: ${getScore('communication')}%"></div>
                                 </div>
                                 <span class="progress-text">${getScore('communication')}%</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="insights-tab" data-insight="relationship">
                         <div class="tab-header">
                             <span class="tab-title">ğŸ’ ×™×—×¡×™×</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: ${getScore('relationship')}%"></div>
                                 </div>
                                 <span class="progress-text">${getScore('relationship')}%</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="insights-tab" data-insight="strengths">
                         <div class="tab-header">
                             <span class="tab-title">ğŸš€ ×—×•×–×§×•×ª</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: ${getScore('strengths')}%"></div>
                                 </div>
                                 <span class="progress-text">${getScore('strengths')}%</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="insights-tab" data-insight="challenges">
                         <div class="tab-header">
                             <span class="tab-title">ğŸ”¥ × ×§' ×›××‘</span>
                             <div class="progress-indicator">
                                 <div class="progress-bar">
                                     <div class="progress-fill" style="width: ${getScore('challenges')}%"></div>
                                 </div>
                                 <span class="progress-text">${getScore('challenges')}%</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 
                 <div class="insights-content-area">
                     <div class="insight-tab-content active" data-content="communication">
                         ${generateContent('communication')}
                     </div>
                     <div class="insight-tab-content" data-content="relationship">
                         ${generateContent('relationship')}
                     </div>
                     <div class="insight-tab-content" data-content="strengths">
                         ${generateContent('strengths')}
                     </div>
                     <div class="insight-tab-content" data-content="challenges">
                         ${generateContent('challenges')}
                     </div>
                 </div>
             </div>
         `;
         
         contentContainer.innerHTML = insightsHTML;
         
         // Set up tab switching
         const tabs = contentContainer.querySelectorAll('.insights-tab');
         const tabContents = contentContainer.querySelectorAll('.insight-tab-content');
         
         tabs.forEach(tab => {
             tab.addEventListener('click', function() {
                 const targetInsight = this.getAttribute('data-insight');
                 console.log('ğŸ”„ [RENDER] Switching to tab:', targetInsight);
                 
                 // Remove active class from all tabs and contents
                 tabs.forEach(t => t.classList.remove('active'));
                 tabContents.forEach(tc => tc.classList.remove('active'));
                 
                 // Add active class to clicked tab
                 this.classList.add('active');
                 
                 // Show corresponding content
                 const targetContent = contentContainer.querySelector(`[data-content="${targetInsight}"]`);
                 if (targetContent) {
                     targetContent.classList.add('active');
                 }
             });
         });
         
         console.log('âœ… [RENDER] Insights tabs rendered successfully');
     };

     // Manual trigger for testing - you can call this from browser console
     window.testInsightsTabs = function() {
         console.log('ğŸ§ª [TEST] Manual test of enhanced insights tabs triggered');
         
         // Switch to insights tab first
         const insightsTab = document.querySelector('[data-tab="insights-content"]');
         if (insightsTab) {
             // Manually switch tabs
             document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
             document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
             
             insightsTab.classList.add('active');
             const insightsContent = document.getElementById('insights-content');
             if (insightsContent) {
                 insightsContent.classList.add('active');
             }
             console.log('ğŸ§ª [TEST] Manually switched to insights tab');
         }
         
         // Show immediate template first
         console.log('ğŸ§ª [TEST] Showing immediate enhanced template');
         window.showImmediateInsightsTemplate();
         
         // Get current folder and try to load local insights
         const urlParams = new URLSearchParams(window.location.search);
         const folder = urlParams.get('folder') || 'convo1';
         
         setTimeout(function() {
             console.log('ğŸ§ª [TEST] Checking for local insights');
             if (typeof window.getLocalInsights === 'function') {
                 const localInsights = window.getLocalInsights(folder);
                 
                                 if (localInsights) {
                    console.log('ğŸ§ª [TEST] Found local insights, updating template');
                    if (typeof window.updateInsightsTemplate === 'function') {
                        window.updateInsightsTemplate(localInsights);
                        window.updateInsightsTabStructure(localInsights);
                    }
                 } else {
                     console.log('ğŸ§ª [TEST] No local insights, generating sample data');
                     if (typeof window.analyzeInsightsForConversation === 'function') {
                         window.analyzeInsightsForConversation(folder);
                     }
                 }
             } else {
                 console.log('âš ï¸ [TEST] Local insights functions not available');
             }
         }, 200);
         
         return 'Test completed - template should be visible immediately!';
     };

     // Force show template immediately - for debugging
     window.forceShowTemplate = function() {
         console.log('ğŸš€ [FORCE] Force showing template immediately');
         
         // Switch to insights tab
         const insightsTab = document.querySelector('[data-tab="insights-content"]');
         const insightsContent = document.getElementById('insights-content');
         
         if (insightsTab && insightsContent) {
             // Activate tab
             document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
             document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
             
             insightsTab.classList.add('active');
             insightsContent.classList.add('active');
             
             // Show template
             if (typeof window.showImmediateInsightsTemplate === 'function') {
                 window.showImmediateInsightsTemplate();
                 console.log('âœ… [FORCE] Template forced to show');
                 return 'Template shown immediately!';
             } else {
                 console.log('âŒ [FORCE] Template function not available');
                 return 'Error: Template function not available';
             }
         } else {
             console.log('âŒ [FORCE] Could not find insights tab elements');
             return 'Error: Could not find insights tab';
         }
     };

     // Quick generate insights for current conversation
     window.quickGenerateInsights = function() {
         const urlParams = new URLSearchParams(window.location.search);
         const folder = urlParams.get('folder') || 'convo1';
         console.log(`âš¡ [QUICK] Quick generating insights for ${folder}`);
         
         if (typeof window.triggerInsightsAnalysis === 'function') {
             window.triggerInsightsAnalysis();
             return `Insights analysis triggered for ${folder}!`;
         } else {
             console.log('âš ï¸ [QUICK] Insights analysis function not available');
             return 'Error: Insights analysis function not available';
         }
     };

     // Complete immediate insights workflow
     window.immediateInsights = function() {
         console.log('ğŸ¯ [IMMEDIATE] Complete immediate insights workflow');
         
         // 1. Switch to insights tab
         const insightsTab = document.querySelector('[data-tab="insights-content"]');
         if (insightsTab) {
             insightsTab.click();
             console.log('ğŸ“‘ [IMMEDIATE] Clicked insights tab');
         }
         
         // 2. Show template immediately
         setTimeout(() => {
             if (typeof window.showImmediateInsightsTemplate === 'function') {
                 window.showImmediateInsightsTemplate();
                 console.log('âœ… [IMMEDIATE] Template shown');
                 
                 // 3. Generate insights if none exist
                 const urlParams = new URLSearchParams(window.location.search);
                 const folder = urlParams.get('folder') || 'convo1';
                 
                 setTimeout(() => {
                     if (typeof window.getLocalInsights === 'function') {
                         const localInsights = window.getLocalInsights(folder);
                         if (!localInsights) {
                             console.log('ğŸ”¬ [IMMEDIATE] No local insights, generating...');
                             if (typeof window.triggerInsightsAnalysis === 'function') {
                                 window.triggerInsightsAnalysis();
                             }
                         } else {
                                                         console.log('ğŸ“ [IMMEDIATE] Local insights found, updating template');
                            if (typeof window.updateInsightsTemplate === 'function') {
                                window.updateInsightsTemplate(localInsights);
                                window.updateInsightsTabStructure(localInsights);
                            }
                         }
                     }
                 }, 300);
             }
         }, 50);
         
         return 'Complete immediate insights workflow started!';
     };

     // Fix insights tab clickability if broken
     window.fixInsightsTab = function() {
         console.log('ğŸ”§ [FIX] Fixing insights tab clickability');
         
         const insightsTab = document.querySelector('[data-tab="insights-content"]');
         if (insightsTab) {
             // Remove any CSS that might block clicking
             insightsTab.style.pointerEvents = 'auto';
             insightsTab.style.zIndex = '999';
             insightsTab.style.position = 'relative';
             
             // Force it to be clickable
             insightsTab.addEventListener('click', function(e) {
                 console.log('ğŸ”§ [FIX] Manual click handler triggered');
                 
                 // Manually switch tabs
                 document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
                 document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                 
                 insightsTab.classList.add('active');
                 const insightsContent = document.getElementById('insights-content');
                 if (insightsContent) {
                     insightsContent.classList.add('active');
                 }
                 
                 // Force refresh insights
                 setTimeout(function() {
                     window.forceRefreshInsights();
                 }, 200);
             });
             
             console.log('âœ… [FIX] Insights tab fixed and made clickable');
         } else {
             console.error('âŒ [FIX] Insights tab not found');
         }
     };

          // Ensure insights tabs are initialized when the insights tab is clicked
     document.addEventListener('DOMContentLoaded', function() {
         // Wait for sidepanel.js to load, then set up insights tab initialization
         setTimeout(function() {
             const insightsTab = document.querySelector('[data-tab="insights-content"]');
             if (insightsTab) {
                 // Add additional event listener without removing existing ones
                 insightsTab.addEventListener('click', function() {
                     console.log('âš¡ [IMMEDIATE] Insights tab clicked - showing template NOW');
                     
                     // Show template immediately - no delays, no waiting for other functions
                     setTimeout(() => {
                         if (typeof window.showImmediateInsightsTemplate === 'function') {
                             window.showImmediateInsightsTemplate();
                             console.log('âœ… [IMMEDIATE] Template shown instantly');
                             
                             // Check for local insights and update if available
                             const urlParams = new URLSearchParams(window.location.search);
                             const folder = urlParams.get('folder') || 'convo1';
                             
                             if (typeof window.getLocalInsights === 'function') {
                                 const localInsights = window.getLocalInsights(folder);
                                 if (localInsights) {
                                     console.log('ğŸ“ [IMMEDIATE] Found local insights, updating');
                                     setTimeout(() => {
                                                                                 if (typeof window.updateInsightsTemplate === 'function') {
                                            window.updateInsightsTemplate(localInsights);
                                            window.updateInsightsTabStructure(localInsights);
                                        }
                                     }, 100);
                                 } else {
                                     console.log('ğŸ” [IMMEDIATE] No local insights found');
                                 }
                             }
                         } else {
                             console.log('âš ï¸ [IMMEDIATE] Template function not ready, will retry');
                             // Retry in case functions aren't loaded yet
                             setTimeout(() => {
                                 if (typeof window.showImmediateInsightsTemplate === 'function') {
                                     window.showImmediateInsightsTemplate();
                                     console.log('âœ… [RETRY] Template shown on retry');
                                 }
                             }, 500);
                         }
                     }, 10); // Very small delay to ensure tab switching completes
                 });
                 console.log('âœ… [IMMEDIATE] Insights tab event listener added with immediate UI');
             }
             
             // Always prepare insights template on page load
             const insightsContent = document.getElementById('insights-content');
             if (insightsContent) {
                 if (insightsContent.classList.contains('active')) {
                     console.log('âš¡ [LOAD] Insights tab is active on load - showing template immediately');
                     
                     // Show template immediately when page loads
                     setTimeout(() => {
                         if (typeof window.showImmediateInsightsTemplate === 'function') {
                             window.showImmediateInsightsTemplate();
                             console.log('âœ… [LOAD] Template shown on page load');
                             
                             // Check for local insights
                             const urlParams = new URLSearchParams(window.location.search);
                             const folder = urlParams.get('folder') || 'convo1';
                             
                             if (typeof window.getLocalInsights === 'function') {
                                 const localInsights = window.getLocalInsights(folder);
                                 if (localInsights) {
                                     console.log('ğŸ“ [LOAD] Found local insights on load');
                                     setTimeout(() => {
                                                                                 if (typeof window.updateInsightsTemplate === 'function') {
                                            window.updateInsightsTemplate(localInsights);
                                            window.updateInsightsTabStructure(localInsights);
                                        }
                                     }, 150);
                                 }
                             }
                         } else {
                             console.log('âš ï¸ [LOAD] Template function not ready on load, retrying');
                             setTimeout(() => {
                                 if (typeof window.showImmediateInsightsTemplate === 'function') {
                                     window.showImmediateInsightsTemplate();
                                     console.log('âœ… [LOAD] Template shown on retry');
                                 }
                             }, 1000);
                         }
                     }, 100);
                 }
                 
                 console.log('ğŸ¯ [PREPARE] Insights system prepared for immediate display');
             }
         }, 500);
     });
    </script>
  
  <script>
    // Main Navigation Tabs JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      // Wait a bit for the side panel to be ready
      setTimeout(() => {
        const mainNavTabs = document.querySelectorAll('.main-nav-tab');
        mainNavTabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all main nav tabs
            mainNavTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.main-tab-content');
            tabContents.forEach(content => {
              content.classList.remove('active');
            });
            
            // Show the selected tab content
            const selectedTabContent = document.getElementById(targetTab);
            if (selectedTabContent) {
              selectedTabContent.classList.add('active');
            }
          });
        });
      }, 500);
    });
  </script>
  
  <style>
    /* Miriam Libre Font Rules */
    @font-face {
      font-family: 'Miriam Libre';
      src: url('assets/Fonts/80kb_desk/80-kb-Sharp.otf') format('opentype');
      font-weight: 400; /* Regular */
      font-style: normal;
    }
    @font-face {
      font-family: 'Miriam Libre';
      src: url('assets/Fonts/80kb_desk/80-kb-SharpBold.otf') format('opentype');
      font-weight: 700; /* Bold */
      font-style: normal;
    }
    @font-face {
      font-family: 'Miriam Libre';
      src: url('assets/Fonts/80kb_desk/80-kb-SharpItalic.otf') format('opentype');
      font-weight: 400; /* Regular Italic */
      font-style: italic;
    }
    @font-face {
      font-family: 'Miriam Libre';
      src: url('assets/Fonts/80kb_desk/80-kb-SharpBoldItalic.otf') format('opentype');
      font-weight: 700; /* Bold Italic */
      font-style: italic;
    }
    
    :root { 
      /* Main font and layout variables */
      --main-font-family: 'Miriam Libre', sans-serif;
      --default-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Ubuntu, "Helvetica Neue", Helvetica, Arial, "PingFang SC",
        "Hiragino Sans GB", "Microsoft Yahei UI", "Microsoft Yahei",
        "Source Han Sans CN", sans-serif;
      --sidebar-width: 320px;
      --rem: 1rem;
      
      /* Background and panel colors */
      --panel-bg: #f7f9f3;
      --panel-overlay: #f7f9f3;
      --sidepanel-bg: #F7F9F2;
      --sidepanel-card-bg: #ffffff;
      --hover-bg: transparent;
      
      /* Border colors */
      --border-color: rgba(128, 128, 128, 0.15);
      --sidepanel-border: #BFC4C0;
      
      /* Text colors */
      --text-primary: #222;
      --text-secondary: #666;
      --text-tertiary: #999;
      --sidepanel-text-primary: #2c3e50;
      --sidepanel-text-secondary: #6c757d;
      --sidepanel-text-muted: #999999;
      
      /* Accent colors */
      --accent-color: #2c3e50;
      --accent-hover: #495057;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      
      /* Grid pattern */
      --grid-pattern: linear-gradient(to right, rgba(128, 128, 128, 0.15) 1px, transparent 1px), 
                      linear-gradient(to bottom, rgba(128, 128, 128, 0.15) 1px, transparent 1px);
    }

    /* CONSOLIDATED BACKGROUND COLOR ENFORCEMENT */
    *, *::before, *::after {
      background-color: transparent !important;
      filter: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      opacity: 1 !important;
    }
    
    html, body, #main-content-wrapper, #visualization-canvas-container,
    #sidebar, .sidebar-header, .sidebar-content {
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
    }
    
    canvas, #visualization-canvas-container canvas {
      background: transparent !important;
      background-color: transparent !important;
    }
    
    .loading, .error, .info-section, .sidebar-content, .panel-tab-content {
      filter: none !important;
      backdrop-filter: none !important;
    }

    .main-container {
      overflow: hidden;
    }

    .main-container,
    .main-container * {
      box-sizing: border-box;
    }

    input,
    select,
    textarea,
    button {
      outline: 0;
    }

    .main-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      flex-wrap: nowrap;
      position: relative;
      width: 411px;
      margin: 0 auto;
    }
    
    /* Removed duplicate title-tabs-container definition - using the main one below */

    
    
    
    
    .frame {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      flex-wrap: nowrap;
      flex-shrink: 0;
      gap: 4px;
      position: relative;
      width: 211px;
      z-index: 2;
    }
    
    /* Removed duplicate conversation-with-dad definition - using the main one below */
    
    /* Removed duplicate date definition - using the main one below */
    
    .tabs-div {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      align-self: stretch;
      flex-wrap: nowrap;
      flex-shrink: 0;
      gap: 21px;
      position: relative;
      border-top: 1px solid #dbdbda;
      z-index: 5;
    }
    
    .frame-1 {
      display: flex;
      flex-direction: row;
      align-items: center;
      align-self: stretch;
      flex-wrap: nowrap;
      flex-shrink: 0;
      position: relative;
      z-index: 6;
    }
    
    .insights-tab {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      flex-grow: 1;
      flex-shrink: 0;
      flex-basis: 0;
      gap: 8px;
      position: relative;
      height: 42px;
      padding: 8px 15px 8px 15px;
      z-index: 7;
      border-bottom: none;
    }
    
    .insights {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      width: 45px;
      height: 24px;
      color: #8b8b89;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 16px;
      font-weight: 400;
      line-height: 24px;
      text-align: center;
      white-space: nowrap;
      z-index: 8;
    }
    
    .information-tab {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      flex-grow: 1;
      flex-shrink: 0;
      flex-basis: 0;
      gap: 8px;
      position: relative;
      height: 42px;
      padding: 8px 15px 8px 15px;
      z-index: 9;
      border-bottom: none;
    }
    
    .conversation-info {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      width: 104px;
      height: 24px;
      color: #8b8b89;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 16px;
      font-weight: 400;
      line-height: 24px;
      text-align: center;
      white-space: nowrap;
      z-index: 10;
    }
    
    .transcript-tab {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-wrap: nowrap;

  flex-grow: 1;          /* âœ… Allows it to grow */
  flex-shrink: 1;        /* âœ… Allows shrinking if needed */
  flex-basis: 0;         /* âœ… Distributes space equally with siblings */

  gap: 8px;
  position: relative;
  height: 42px;
  padding: 8px 15px;
  z-index: 11;
  border-bottom: 0px solid #171717;

  width: 100%;           /* âœ… Forces full width inside parent (optional but helps) */
  box-sizing: border-box;/* âœ… Makes padding/borders safe */
}

    
    .transcript {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      width: 41px;
      height: 24px;
      color: #171717;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 16px;
      font-weight: 400;
      line-height: 24px;
      text-align: center;
      white-space: nowrap;
      z-index: 12;
    }
    
    .segments-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      align-self: stretch;
      gap: 1.5rem;
      position: relative;
      height: 55.375rem;
      background: #f7f9f3;
      z-index: 13;
      overflow-y: auto;
      /* Hide scrollbar while keeping functionality */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }
    
    /* Hide scrollbar for webkit browsers */
    .segments-container::-webkit-scrollbar {
      display: none;
    }
    
    .specific-segment {
      display: flex;
      padding: 1.5rem;
      flex-direction: column;
      align-items: flex-end;
      gap: 1.0625rem;
      align-self: stretch;
      position: relative;
      border: 1px solid var(--sidepanel-border);
      border-radius: 0 !important;
      background: #ffffff;
      z-index: 14;
    }
    
    .person-name-emotions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      flex-wrap: nowrap;
      flex-shrink: 0;
      gap: 0.375rem;
      position: relative;
      width: 100%;
      z-index: 15;
    }
    
    .avi-shemesh {
      align-self: stretch;
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      min-width: 0;
      height: auto;
      color: #333333;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
      text-align: right;
      white-space: nowrap;
      margin-bottom: 4px;
      z-index: 16;
    }
    
    .emotions-div {
      display: flex;
      align-items: center;
      align-self: stretch;
      flex-wrap: wrap;
      flex-shrink: 0;
      gap: 0.5rem;
      position: relative;
      min-width: 0;
      z-index: 17;
    }
    
    .specific-emotion {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      flex-shrink: 0;
      gap: 6px;
      position: relative;
      width: auto;
      min-width: 60px;
      padding: 4px 8px;
      border: 1px solid #808080;
      border-radius: 0 !important;
      z-index: 18;
    }
    
    .rectangle {
      flex-shrink: 0;
      position: relative;
      width: 8px;
      height: 8px;
      border-radius: 0 !important;
      background: #fa7315; /* Default orange - will be overridden by inline styles */
      z-index: 19;
    }
    
    .span-tag {
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      height: auto;
      color: #666666;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 12px;
      font-weight: 400;
      line-height: 1.2;
      text-align: left;
      white-space: nowrap;
      z-index: 20;
    }
    

    
    .discussion-topic {
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      align-self: stretch;
      flex-shrink: 0;
      position: relative;
      width: 100%;
      color: #333333;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 14px;
      font-weight: 400;
      line-height: 1.4;
      text-align: right;
      z-index: 27;
    }
    
    /* CONSOLIDATED SEGMENT VARIATIONS - All numbered segments use same styles */
    .specific-segment,
    [class*="specific-segment-"] {
      display: flex;
      padding: 1rem;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.75rem;
      align-self: stretch;
      position: relative;
      border: 1px solid #808080;
      border-radius: 0 !important;
      background: #ffffff;
      margin-bottom: 0.75rem;
    }
    
    /* CONSOLIDATED PERSON NAME AND EMOTIONS CONTAINERS */
    .person-name-emotions,
    [class*="person-name-emotions-"] {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      flex-wrap: nowrap;
      flex-shrink: 0;
      gap: 0.375rem;
      position: relative;
      width: 100%;
    }
    
    /* CONSOLIDATED SPEAKER NAMES */
    .avi-shemesh,
    [class*="avi-shemesh-"],
    [class*="span-tag-a"],
    [class*="span-2f"] {
      align-self: stretch;
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      min-width: 0;
      height: auto;
      color: #333333;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
      text-align: right;
      white-space: nowrap;
      margin-bottom: 4px;
    }
    
    /* CONSOLIDATED EMOTIONS DIVS */
    .emotions-div,
    [class*="emotions-div-"] {
      display: flex;
      align-items: center;
      align-self: stretch;
      flex-wrap: wrap;
      flex-shrink: 0;
      gap: 0.5rem;
      position: relative;
      min-width: 0;
    }
    
    /* CONSOLIDATED SPECIFIC EMOTIONS - All variations */
    .specific-emotion,
    [class*="specific-emotion-"] {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      flex-shrink: 0;
      gap: 6px;
      position: relative;
      width: auto;
      min-width: 60px;
      padding: 4px 8px;
      border: 1px solid #808080;
      border-radius: 0 !important;
    }
    
    /* CONSOLIDATED RECTANGLES - All color rectangles */
    .rectangle,
    [class*="rectangle-"] {
      flex-shrink: 0;
      position: relative;
      width: 8px;
      height: 8px;
      border-radius: 0 !important;
    }
    
    /* CONSOLIDATED EMOTION TAGS */
    .span-tag,
    [class*="span-tag-"],
    .frustration,
    .worry,
    .surprise,
    [class*="surprise-"],
    [class*="tag-span"] {
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      height: auto;
      color: #666666;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 12px;
      font-weight: 400;
      line-height: 1.2;
      text-align: left;
      white-space: nowrap;
    }
    
    /* CONSOLIDATED DISCUSSION TOPICS */
    .discussion-topic,
    .team-discussion,
    [class*="team-discussion-"],
    [class*="discussion-topic-"] {
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      align-self: stretch;
      flex-shrink: 0;
      position: relative;
      width: 100%;
      color: #333333;
      font-family: Miriam Libre, var(--default-font-family);
      font-size: 14px;
      font-weight: 400;
      line-height: 1.4;
      text-align: right;
    }
    
    /* Miriam Libre font import */
    @import url('https://fonts.googleapis.com/css2?family=Miriam+Libre:wght@400;700&display=swap');
    
     /* Apply Miriam Libre to all Hebrew text elements (consolidated) */
     .avi-shemesh,
     [class*="avi-shemesh-"],
     [class*="span-tag"],
     .frustration,
     .worry,
     .surprise,
     [class*="surprise-"],
     [class*="tag-span"],
     .discussion-topic,
     .team-discussion,
     [class*="team-discussion-"],
     [class*="discussion-topic-"],
     .conversation-with-dad,
     .date,
     .insights,
     .conversation-info,
     .transcript {
       font-family: 'Miriam Libre', var(--default-font-family) !important;
     }
     
     /* Old tab styling removed - Now using chat journal interface styling */
     
     /* Ensure proper spacing and alignment */
     .segments-container {
       overflow-y: auto;
       max-height: calc(100vh - 200px);
       /* Hide scrollbar while keeping functionality */
       scrollbar-width: none; /* Firefox */
       -ms-overflow-style: none; /* Internet Explorer 10+ */
     }
     
     /* Hide scrollbar for webkit browsers */
     .segments-container::-webkit-scrollbar {
       display: none;
     }
     
     /* Old segment styling removed - Now using chat journal transcript cards */
    
    /* Force exact hex color on all critical elements */
    html {
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
    }
    
    body {
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
    }
    
    #main-content-wrapper {
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
    }
    
    #visualization-canvas-container {
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
    }

    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: var(--main-font-family);
      color: #333;
      height: 100vh;
      width: 100vw;
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
    }

    /* Main container that fills the iframe */
    #main-content-wrapper {
      width: 100%;
      height: 100%;
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Main content header - inside sidebar */
    .title-tabs-container {
      background: var(--sidepanel-card-bg);

      padding: 24px;
      margin-bottom: 16px;
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      width: 100%;
    }

    .header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .frame {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .conversation-with-dad {
      font-size: 18px;
      font-weight: 600;
      color: var(--sidepanel-text-primary);
      font-family: var(--main-font-family);
      margin: 0 0 4px 0;
      text-align: right;
      width: 100%;
      align-self: flex-end;
    }

    .date {
      font-size: 14px;
      font-weight: 400;
      color: var(--sidepanel-text-secondary);
      font-family: var(--main-font-family);
      margin: 0;
      text-align: right;
      width: 100%;
      align-self: flex-end;
    }
    
    /* When sidebar is hidden from the start */
    body.no-sidebar #sidebar {
      display: none !important;
    }
    
    body.no-sidebar #visualization-canvas-container {
      width: 100% !important;
      margin-left: 0 !important;
    }
    


    /* Right Sidebar - Complete Chat Journal Interface Styling */
    .sidebar {
      width: 320px;
      background: #F7F9F2;
      border-left: 1px solid #BFC4C0;
      display: flex;
      flex-direction: column;
      box-shadow: none;
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      z-index: 10;
      transition: transform 0.3s ease;
      transform: translateX(0);
      font-family: 'Miriam Libre', sans-serif !important;
    }

    .sidebar.closed {
      transform: translateX(100%);
    }

    .sidebar-header {
      padding: 20px;
      text-align: right;
      background: #F7F9F2;
      direction: rtl;
    }

    .sidebar-header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      font-family: 'Miriam Libre', sans-serif;
    }

    .sidebar-header .time {
      font-size: 14px;
      color: #6c757d;
      font-weight: 400;
      font-family: 'Miriam Libre', sans-serif;
    }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid #BFC4C0;
      background: #F7F9F2;
    }

    .sidebar-tab {
      flex: 1;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
      color: #6c757d;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
      background: #F7F9F2;
      border: none;
      font-family: 'Miriam Libre', sans-serif;
    }

    .sidebar-tab:hover {
      background: #F7F9F2;
      color: #495057;
    }

    .sidebar-tab.active {
      color: #2c3e50;
      border-bottom-color: #171717;
      background: #F7F9F2;
      font-weight: 600;
      border-bottom-width: 2px;
      border-bottom-style: solid;
    }

    .sidebar-content {
      flex: 1;
      padding: 12px 8px;
      overflow-y: auto;
      background: #F7F9F2;
      font-family: 'Miriam Libre', sans-serif !important;
      /* Hide scrollbar while keeping functionality */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }
    
    /* Hide scrollbar for webkit browsers */
    .sidebar-content::-webkit-scrollbar {
      display: none;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Transcript Cards */
    .transcript-card {
      background: transparent;
      border: 1px solid #BFC4C0;
      border-radius: 0;
      padding: 15px;
      margin-bottom: 15px;
    }

    .transcript-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 12px;
      direction: rtl;
      text-align: right;
    }

    .transcript-title {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      text-align: right;
      margin-bottom: 8px;
      width: 100%;
      font-family: 'Miriam Libre', sans-serif;
    }

    .transcript-legend {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
      direction: rtl;
      flex-direction: row-reverse;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #6c757d;
      font-family: 'Miriam Libre', sans-serif;
      border: 1px solid #BFC4C0;
      padding: 4px 8px;
      border-radius: 0;
      text-align: right;
      direction: ltr;
      justify-content: space-between;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 0;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .legend-dot.orange { background: #ff6b35 !important; }
    .legend-dot.blue { background: #0066cc !important; }
    .legend-dot.yellow { background: #ffd700 !important; }

    .transcript-content {
      text-align: right;
      font-size: 14px;
      line-height: 1.6;
      color: #495057;
      direction: rtl;
      font-family: 'Miriam Libre', sans-serif;
    }

    /* Content Sections */
    .content-section {
      background: #ffffff;
      border: 1px solid #BFC4C0;
      border-radius: 0;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: none;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      text-align: right;
      margin-bottom: 15px;
      font-family: 'Miriam Libre', sans-serif;
    }

    .section-content {
      text-align: right;
      font-size: 14px;
      line-height: 1.6;
      color: #495057;
      direction: rtl;
      font-family: 'Miriam Libre', sans-serif;
    }

    /* Info Table */
    .info-table {
      width: 100%;
      margin-top: 15px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f8f9fa;
      direction: rtl;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 14px;
      color: #2c3e50;
      font-family: 'Miriam Libre', sans-serif;
      font-weight: 600;
      text-align: right;
    }

    .info-value {
      font-size: 14px;
      color: #6c757d;
      font-family: 'Miriam Libre', sans-serif;
      text-align: right;
    }

    /* Progress Bars */
    .progress-container {
      margin-bottom: 15px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-name {
      font-size: 14px;
      color: #2c3e50;
      font-family: 'Miriam Libre', sans-serif;
    }

    .progress-percentage {
      font-size: 14px;
      color: #6c757d;
      font-family: 'Miriam Libre', sans-serif;
    }

    .progress-bar-bg {
      width: 100%;
      height: 12px;
      background: #d1d3d4;
      border-radius: 4px;
      overflow: hidden;
      display: block !important;
      visibility: visible !important;
      margin-top: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      background: #495057;
      transition: width 0.3s ease;
      border-radius: 4px;
      display: block !important;
      visibility: visible !important;
    }

    /* Topic Buttons */
    .topic-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .topic-btn {
      padding: 8px 16px;
      background: #f8f9fa;
      border: 1px solid #BFC4C0;
      color: #495057;
      cursor: pointer;
      font-size: 14px;
      border-radius: 0;
      transition: all 0.2s;
      font-family: 'Miriam Libre', sans-serif;
    }

    .topic-btn:hover {
      background: #e9ecef;
    }

    /* Category Buttons */
    .category-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .category-btn {
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid #BFC4C0;
      color: #6c757d;
      cursor: pointer;
      font-size: 12px;
      border-radius: 0;
      transition: all 0.2s;
      flex: 1;
      text-align: center;
      min-width: 60px;
      font-family: 'Miriam Libre', sans-serif;
    }

    .category-btn:hover {
      background: #e9ecef;
    }

    .category-btn {
      position: relative;
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid #BFC4C0;
      color: #6c757d;
      cursor: pointer;
      font-size: 12px;
      border-radius: 0;
      transition: all 0.2s;
      flex: 1;
      text-align: center;
      min-width: 60px;
      font-family: 'Miriam Libre', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .category-progress {
      width: 100%;
      height: 2px;
      border-radius: 0;
    }

    .category-progress.brown { background: #8B7355; }
    .category-progress.purple { background: #6f42c1; }
    .category-progress.green { background: #28a745; }
    .category-progress.blue { background: #007bff; }

    .category-btn.active {
      background: transparent;
      font-weight: 600;
    }

    /* Active state colors based on progress type */
    .category-btn.active[data-category="listening"] {
      color: #8B7355;
      border-color: #8B7355;
    }

    .category-btn.active[data-category="agreement"] {
      color: #6f42c1;
      border-color: #6f42c1;
    }

    .category-btn.active[data-category="emotion"] {
      color: #28a745;
      border-color: #28a745;
    }

    .category-btn.active[data-category="engagement"] {
      color: #007bff;
      border-color: #007bff;
    }

    /* Insight Sections */
    .insight-section {
      margin-bottom: 20px;
      position: relative;
      padding-right: 20px;
    }

    .insight-indicator {
      position: absolute;
      right: 0;
      top: 8px;
      width: 8px;
      height: 8px;
      border-radius: 0;
    }

    .insight-indicator.blue { background: #3498db; }
    .insight-indicator.green { background: #1abc9c; }
    .insight-indicator.purple { background: #9b59b6; }
    .insight-indicator.amber { background: #D08800; }

    .insight-title {
      font-size: 14px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      text-align: right;
      font-family: 'Miriam Libre', sans-serif;
    }

    .insight-content {
      font-size: 13px;
      line-height: 1.5;
      color: #495057;
      text-align: right;
      direction: rtl;
      font-family: 'Miriam Libre', sans-serif;
    }

    .insight-separator {
      position: relative;
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .separator-line {
      width: 100%;
      height: 1px;
      background: #007bff;
      border-top: 1px dashed #007bff;
    }

    .separator-x {
      position: absolute;
      background: #e3f2fd;
      color: #007bff;
      width: 20px;
      height: 20px;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }

    .insight-section {
      margin-bottom: 20px;
      position: relative;
      padding-right: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .insight-section:hover {
      background: rgba(0, 123, 255, 0.05);
    }

    /* Adjust canvas margin when sidebar is collapsed */
    .sidebar.closed ~ #visualization-canvas-container {
      margin-right: 0; /* No margin when completely hidden */
    }

    #visualization-canvas-container {
      flex: 1;
      position: relative;
      background: #f7f9f3 !important;
      background-color: #f7f9f3 !important;
      transition: margin-left 0.3s ease;
      margin-right: 400px; /* Updated for 400px sidebar */
    }

    #visualization-canvas-container.expanded {
      margin-left: 0;
      margin-right: 0;
      width: 100%;
    }

    /* Arrow toggle button - positioned outside sidebar on left border */
    .sidebar-arrow-toggle {
      position: fixed;
      right: calc(320px); /* Position exactly at the left edge of the sidebar */
      top: 20px; /* Aligned with the top of the sidebar header */
      width: 40px;
      height: 25px;
      background: #f7f9f3;
      border: 1px solid #BFC4C0;
      border-right: none; /* No right border as it connects to sidebar */
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 25;
      transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    }

    .sidebar-arrow-toggle:hover {
      border-color: #171717;
      background: #ffffff;
    }

    .sidebar-arrow-toggle svg {
      stroke: #8b8b89;
      transition: all 0.3s ease;
      width: 16px;
      height: 16px;
    }

    .sidebar-arrow-toggle:hover svg {
      stroke: #171717;
    }

    /* When sidebar is closed, move button to the right edge of screen */
    body.sidebar-closed .sidebar-arrow-toggle,
    #sidebar.closed ~ .sidebar-arrow-toggle {
      right: 20px;
      left: auto;
      top: 20px; /* Aligned with the top of the sidebar header */
      border-radius: 0;
      border: 1px solid #BFC4C0;
      width: 40px;
      height: 30px;
    }





    .sidebar-content {
      padding: 0;
      background: transparent;
      height: auto;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      /* Hide scrollbar while keeping functionality */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }
    
    /* Hide scrollbar for webkit browsers */
    .sidebar-content::-webkit-scrollbar {
      display: none;
    }

    .info-section {
      margin-bottom: 30px;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .info-section:hover {
      transform: translateY(-1px);
      /* box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); REMOVED ALL SHADOWS */
    }

    .info-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: var(--main-font-family);
    }

    .info-value {
      font-size: 15px;
      color: var(--text-primary);
      margin-bottom: 0;
      font-family: var(--main-font-family);
      line-height: 1.5;
    }

    .transcript-text {
      padding: 15px;
      border-radius: 8px;
      font-style: normal;
      line-height: 1.6;
      font-family: var(--main-font-family);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      min-height: 60px;
      display: flex;
      align-items: center;
      font-size: 14px;
    }

    .emotion-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .emotion-tag {
      color: var(--text-primary);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      font-family: var(--main-font-family);
      border: 1px solid var(--border-color);
      /* box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); REMOVED ALL SHADOWS */
      transition: all 0.2s ease;
      cursor: default;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .emotion-color-square {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .emotion-tag:hover {
      transform: scale(1.05);
      /* box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); REMOVED ALL SHADOWS */
    }

    .controls-section {
      margin-top: 0;
      padding: 0;
      border: none;
    }

    .audio-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .control-btn {
      flex: 1;
      padding: 12px 8px;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      font-family: var(--main-font-family);
      transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
      /* box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); REMOVED ALL SHADOWS */
      background: none;
    }

    .control-btn:hover {
      transform: translateY(-2px);
      /* box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3); REMOVED ALL SHADOWS */
    }

    .control-btn:active {
      transform: translateY(0);
      /* box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); REMOVED ALL SHADOWS */
    }

    .control-btn:disabled {
      color: var(--text-tertiary);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: none;
    }

    .volume-control {
      margin-top: 15px;
    }

    .volume-slider {
      width: 100%;
      margin-top: 12px;
      height: 8px;
      border-radius: 4px;
      outline: none;
      border: 1px solid var(--border-color);
      appearance: none;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid var(--border-color);
      /* box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); REMOVED ALL SHADOWS */
      transition: all 0.2s ease;
      background: var(--accent-color); /* Kept for visibility on slider */
    }

    .volume-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      /* box-shadow: 0 3px 8px rgba(139, 115, 85, 0.4); REMOVED ALL SHADOWS */
    }

    .volume-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid var(--border-color);
      /* box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); REMOVED ALL SHADOWS */
      background: var(--accent-color); /* Kept for visibility on slider */
    }

    /* Hide scrollbar but keep functionality */
    #sidebar::-webkit-scrollbar {
      width: 6px;
    }

    #sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    #sidebar::-webkit-scrollbar-thumb {
      background: transparent;
      border-radius: 3px;
    }

    #sidebar::-webkit-scrollbar-thumb:hover {
      background: transparent;
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 18px;
      color: var(--text-secondary);
    }

    /* Error state */
    .error {
      color: #e74c3c;
      padding: 20px;
      text-align: center;
    }

    /* Tabs Section - Reference Image Style */
    .tabs-div {
      background: transparent;
      border: none;
      border-bottom: 1px solid #dbdbda;
      padding: 0;
      margin-bottom: 16px;
    }

    .frame-1 {
      display: flex;
      flex-direction: row;
      align-items: center;
      align-self: stretch;
      flex-wrap: nowrap;
      flex-shrink: 0;
      position: relative;
    }

    .transcript-tab,
    .information-tab,
    .insights-tab {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      flex-grow: 1;
      flex-shrink: 0;
      flex-basis: 0;
      gap: 8px;
      position: relative;
      height: 42px;
      padding: 8px 15px;
      background: transparent;
      border: none;
      font-family: var(--main-font-family);
      font-size: 16px;
      font-weight: 400;
      color: #8b8b89;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .transcript-tab.active,
    .information-tab.active,
    .insights-tab.active {
      color: #171717;
      border-bottom: 2px solid #171717;
      font-weight: 400;
    }

    .transcript-tab:hover,
    .information-tab:hover,
    .insights-tab:hover {
      color: #171717;
      background: rgba(139, 139, 137, 0.1);
    }

    .transcript,
    .conversation-info,
    .insights {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      flex-shrink: 0;
      flex-basis: auto;
      position: relative;
      height: 24px;
      line-height: 24px;
      text-align: center;
      white-space: nowrap;
    }



    .main-tab-content {
      display: none;
      background: var(--sidepanel-card-bg);
      border: none;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 16px;
    }

    .main-tab-content.active {
      display: block;
    }

    /* Eye icon styles */
    .eye-icon {
      width: 20px;
      height: 20px;
      margin-left: 5px;
      vertical-align: middle;
    }

    /* Summary Tab Styles */
    .summary-loading {
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
      padding: 20px;
    }

    .summary-content {
      padding: 15px;
      border-radius: 8px;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .themes-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .theme-item {
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 3px solid var(--accent-color);
      font-size: 14px;
    }

    .theme-item .theme-title {
      font-weight: bold;
      color: var(--text-primary);
    }

    .theme-item .theme-description {
      color: var(--text-secondary);
      font-size: 12px;
      margin-top: 4px;
    }

    .progression-chart {
      padding: 15px;
      border-radius: 8px;
      min-height: 120px;
      position: relative;
    }

    .progression-timeline {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .progression-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px;
      border-radius: 4px;
    }

    .progression-time {
      font-size: 11px;
      color: var(--text-secondary);
      min-width: 60px;
    }

    .progression-emotion {
      flex: 1;
      font-size: 13px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .metric-item {
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .metric-label {
      display: block;
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .metric-value {
      display: block;
      font-size: 16px;
      font-weight: bold;
      color: var(--text-primary);
    }

    .emotion-progression-bar {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .emotion-progression-fill {
      height: 100%;
      transition: width 0.3s ease;
    }

    .summary-highlight {
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: bold;
    }

    /* Transcript Tab Styles */
    .transcript-loading {
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
      padding: 20px;
    }

    #full-transcript-container {
      max-height: 400px;
      overflow-y: auto;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border-color);
      /* Hide scrollbar while keeping functionality */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }
    
    /* Hide scrollbar for webkit browsers */
    #full-transcript-container::-webkit-scrollbar {
      display: none;
    }

    .transcript-segment {
      margin-bottom: 15px;
      padding: 0;
      border: 1px solid var(--sidepanel-border);
      border-radius: 0 !important;
    }

    .transcript-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .transcript-time {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: bold;
    }

    .transcript-speaker {
      font-size: 12px;
      color: var(--accent-color);
      font-weight: bold;
    }

    .transcript-text {
      line-height: 1.5;
      color: var(--text-primary);
      font-size: 14px;
    }

    .transcript-emotions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .transcript-emotion-tag {
      color: var(--accent-color);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid rgba(139, 115, 85, 0.2);
    }

    .transcript-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .search-container {
      padding: 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      margin-top: 10px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: var(--main-font-family);
      font-size: 14px;
      margin-bottom: 8px;
      background: none;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .search-results {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .transcript-highlight {
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: bold;
    }

    /* Meeting Summary Styles */
    .topics-container,
    .decisions-container,
    .actions-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .topic-item,
    .decision-item,
    .action-item {
      padding: 10px 12px;
      border-radius: 6px;
      border-left: 3px solid var(--accent-color);
      font-size: 14px;
    }

    .decision-item {
      border-left-color: var(--success-color);
    }

    .action-item {
      border-left-color: var(--warning-color);
    }

    .item-title {
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .item-description {
      color: var(--text-secondary);
      font-size: 12px;
      line-height: 1.4;
    }

    .atmosphere-container {
      padding: 15px;
      border-radius: 8px;
    }

    .mood-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .mood-emoji {
      font-size: 24px;
    }

    .mood-text {
      font-weight: 600;
      color: var(--text-primary);
    }

        /* Conversation Transcript Styles */
    .conversation-header {
      text-align: right;
      padding: 20px 1rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .conversation-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: var(--main-font-family);
    }

    .conversation-date {
      font-size: 14px;
      color: var(--text-secondary);
      font-family: var(--main-font-family);
    }


    .conversation-nav-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .conv-nav-tab {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      font-family: var(--main-font-family);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .conv-nav-tab.active {
      color: var(--accent-color);
      border-bottom-color: var(--accent-color);
      font-weight: 600;
    }

    .conv-nav-tab:hover {
      color: var(--accent-hover);
      background: rgba(139, 115, 85, 0.05);
    }

    .conversation-content {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
      /* Hide scrollbar while keeping functionality */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* Internet Explorer 10+ */
    }
    
    /* Hide scrollbar for webkit browsers */
    .conversation-content::-webkit-scrollbar {
      display: none;
    }

    .conversation-segment {
      border: 1px solid var(--sidepanel-border);
      padding: 24px;
      border-radius: 0 !important;
      background: #ffffff;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }

    .conversation-segment:hover {
      transform: translateY(-1px);
      border-color: var(--accent-color);
    }

    .segment-speaker {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: var(--main-font-family);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .speaker-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .speaker-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .segment-number {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .segment-emotions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .segment-emotion-tag {
      --banner-height: 48px;
      --100dvw: 100dvw;
      --100dvh: 100dvh;
      --font-sans: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --color-red-50: oklch(.971 .013 17.38);
      --color-red-200: oklch(.885 .062 18.334);
      --color-red-500: oklch(.637 .237 25.331);
      --color-red-600: oklch(.577 .245 27.325);
      --color-orange-50: oklch(.98 .016 73.684);
      --color-orange-600: oklch(.646 .222 41.116);
      --color-yellow-50: oklch(.987 .026 102.212);
      --color-yellow-200: oklch(.945 .129 101.54);
      --color-yellow-500: oklch(.795 .184 86.047);
      --color-yellow-600: oklch(.681 .162 75.834);
      --color-green-50: oklch(.982 .018 155.826);
      --color-green-200: oklch(.925 .084 155.995);
      --color-green-500: oklch(.723 .219 149.579);
      --color-green-600: oklch(.627 .194 149.214);
      --color-blue-50: oklch(.97 .014 254.604);
      --color-blue-200: oklch(.882 .059 254.128);
      --color-blue-600: oklch(.546 .245 262.881);
      --color-purple-600: oklch(.558 .288 302.321);
      --color-gray-100: oklch(.967 .003 264.542);
      --color-gray-600: oklch(.446 .03 256.802);
      --color-neutral-900: oklch(.205 0 0);
      --color-black: #000;
      --color-white: #fff;
      --spacing: .25rem;
      --container-sm: 24rem;
      --container-lg: 32rem;
      --container-2xl: 42rem;
      --container-3xl: 48rem;
      --container-4xl: 56rem;
      --container-6xl: 72rem;
      --container-7xl: 80rem;
      --text-xs: .75rem;
      --text-xs--line-height: calc(1 / .75);
      --text-sm: .875rem;
      --text-sm--line-height: calc(1.25 / .875);
      --text-base: 1rem;
      --text-base--line-height: calc(1.5 / 1);
      --text-lg: 1.125rem;
      --text-lg--line-height: calc(1.75 / 1.125);
      --text-xl: 1.25rem;
      --text-xl--line-height: calc(1.75 / 1.25);
      --text-2xl: 1.5rem;
      --text-2xl--line-height: calc(2 / 1.5);
      --text-4xl: 2.25rem;
      --text-4xl--line-height: calc(2.5 / 2.25);
      --text-6xl: 3.75rem;
      --text-6xl--line-height: 1;
      --font-weight-semibold: 600;
      --tracking-tight: -.025em;
      --tracking-wide: .025em;
      --tracking-wider: .05em;
      --tracking-widest: .1em;
      --leading-relaxed: 1.625;
      --radius-xs: .125rem;
      --ease-in-out: cubic-bezier(.4, 0, .2, 1);
      --animate-pulse: pulse 2s cubic-bezier(.4, 0, .6, 1) infinite;
      --blur-sm: 8px;
      --aspect-video: 16 / 9;
      --default-transition-duration: .15s;
      --default-transition-timing-function: cubic-bezier(.4, 0, .2, 1);
      --default-font-family: var(--font-sans);
      --default-font-feature-settings: var(--font-sans--font-feature-settings);
      --default-font-variation-settings: var(--font-sans--font-variation-settings);
      --default-mono-font-family: var(--font-mono);
      --default-mono-font-feature-settings: var(--font-mono--font-feature-settings);
      --default-mono-font-variation-settings: var(--font-mono--font-variation-settings);
      --color-border: var(--border);
      -webkit-text-size-adjust: 100%;
      tab-size: 4;
      font-feature-settings: var(--default-font-feature-settings, normal);
      font-variation-settings: var(--default-font-variation-settings, normal);
      -webkit-tap-highlight-color: transparent;
      font-size: var(--font-size);
      --font-size: 14px;
      --background: #f7f9f2;
      --foreground: #000;
      --card: #fff;
      --card-foreground: #000;
      --popover: #fff;
      --popover-foreground: #000;
      --primary: #000;
      --primary-foreground: #fff;
      --secondary: #e8ebeb;
      --secondary-foreground: #000;
      --muted: #f0f2f2;
      --muted-foreground: #555;
      --accent: #e5e8e8;
      --accent-foreground: #000;
      --destructive: red;
      --destructive-foreground: #fff;
      --border: #c0c4c0;
      --input: transparent;
      --input-background: #fff;
      --switch-background: #ccc;
      --font-weight-medium: 400;
      --font-weight-normal: 400;
      --ring: #000;
      --chart-1: red;
      --chart-2: #0f0;
      --chart-3: #00f;
      --chart-4: #ff0;
      --chart-5: #f0f;
      --radius: 0px;
      --sidebar: #fff;
      --sidebar-foreground: #000;
      --sidebar-primary: #000;
      --sidebar-primary-foreground: #fff;
      --sidebar-accent: #f0f2f2;
      --sidebar-accent-foreground: #000;
      --sidebar-border: #000;
      --sidebar-ring: #000;
      --font-family-retro: "Miriam Libre", "Share Tech Mono", "Courier New", monospace;
      color: var(--foreground);
      line-height: 1.4;
      --tw-backdrop-blur: blur(var(--blur-sm));
      box-sizing: border-box;
      border: 0 solid;
      margin: 0;
      padding: 0;
      outline-color: color-mix(in oklab, var(--ring) 50%, transparent);
      position: relative;
      display: flex;
      flex-shrink: 0;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      border-style: var(--tw-border-style);
      border-width: 1px;
      border-color: #e5e6e2;
      padding-inline: calc(var(--spacing) * 1.5);
      padding-block: calc(var(--spacing) * .5);
      border-radius: 0 !important;
      font-family: var(--font-family-retro) !important;
      text-align: right;
      color: white;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      box-shadow: none;
      transition: all 0.2s ease;
      cursor: default;
    }

    .segment-emotion-tag:hover {
      transform: translateY(-1px);
      box-shadow: none;
    }

    /* Primary emotion colors - matching admin panel */
    .segment-emotion-tag.emotion-happiness,
    .segment-emotion-tag.emotion-×©××—×”,
    .segment-emotion-tag.emotion-×”×ª×¤×¢×œ×•×ª,
    .segment-emotion-tag.emotion-excitement,
    .segment-emotion-tag.emotion-×”×ª×¨×’×©×•×ª { background: #FF9500; }
    
    .segment-emotion-tag.emotion-sadness,
    .segment-emotion-tag.emotion-×¢×¦×‘,
    .segment-emotion-tag.emotion-×“××’×”,
    .segment-emotion-tag.emotion-worry { background: #4A90E2; }
    
    .segment-emotion-tag.emotion-anger,
    .segment-emotion-tag.emotion-×›×¢×¡,
    .segment-emotion-tag.emotion-×¡×›×œ×•×œ,
    .segment-emotion-tag.emotion-frustration,
    .segment-emotion-tag.emotion-×ª×¡×›×•×œ { background: #D0021B; }
    
    .segment-emotion-tag.emotion-fear,
    .segment-emotion-tag.emotion-×¤×—×“,
    .segment-emotion-tag.emotion-anxiety,
    .segment-emotion-tag.emotion-×—×¨×“×” { background: #9013FE; }
    
    .segment-emotion-tag.emotion-surprise,
    .segment-emotion-tag.emotion-×”×¤×ª×¢×” { background: #F5A623; }
    
    .segment-emotion-tag.emotion-disgust,
    .segment-emotion-tag.emotion-×’×•×¢×œ { background: #50E3C2; }
    
    .segment-emotion-tag.emotion-neutral,
    .segment-emotion-tag.emotion-× ×™×˜×¨×œ×™ { background: #9B9B9B; }
    
    .segment-emotion-tag.emotion-curiosity,
    .segment-emotion-tag.emotion-×¡×§×¨× ×•×ª { background: #7ED321; }
    
    .segment-emotion-tag.emotion-love,
    .segment-emotion-tag.emotion-××”×‘×” { background: #FF6B9D; }
    
    .segment-emotion-tag.emotion-confidence,
    .segment-emotion-tag.emotion-×‘×™×˜×—×•×Ÿ { background: #16A085; }
    
    .segment-emotion-tag.emotion-joy { background: #F39C12; }
    
    .segment-emotion-tag.emotion-calm,
    .segment-emotion-tag.emotion-×¨×’×™×¢×” { background: #27AE60; }
    
    .segment-emotion-tag.emotion-stress,
    .segment-emotion-tag.emotion-×œ×—×¥ { background: #E67E22; }

    /* Additional specific emotions with distinct colors */
    .segment-emotion-tag.emotion-×‘×•×©×”,
    .segment-emotion-tag.emotion-shame { background: #FF6B6B; }
    
    .segment-emotion-tag.emotion-×’××•×•×”,
    .segment-emotion-tag.emotion-pride { background: #4ECDC4; }
    
    .segment-emotion-tag.emotion-×ª×§×•×•×”,
    .segment-emotion-tag.emotion-hope { background: #45B7D1; }
    
    .segment-emotion-tag.emotion-×”×§×œ×”,
    .segment-emotion-tag.emotion-relief { background: #FFEAA7; }
    
    .segment-emotion-tag.emotion-××‘×•×›×”,
    .segment-emotion-tag.emotion-embarrassment { background: #DDA0DD; }
    
    .segment-emotion-tag.emotion-×”×ª×œ×”×‘×•×ª,
    .segment-emotion-tag.emotion-enthusiasm { background: #98D8C8; }
    
    .segment-emotion-tag.emotion-×¢×™×™×¤×•×ª,
    .segment-emotion-tag.emotion-fatigue { background: #A0A0A0; }
    
    .segment-emotion-tag.emotion-××ª×—,
    .segment-emotion-tag.emotion-tension { background: #FF7675; }
    
    .segment-emotion-tag.emotion-×©×§×˜,
    .segment-emotion-tag.emotion-peace { background: #81ECEC; }

    /* Fallback for unmapped emotions */
    .segment-emotion-tag:not([class*="emotion-"]) {
      background: #6C7B7F;
    }

    .segment-text {
      margin-top: 12px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-primary);
      font-family: var(--main-font-family);
      background: white;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(128, 128, 128, 0.1);
    }

    .segment-time {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.6;
      text-align: left;
      font-family: monospace;
    }

    .conversation-controls {
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .conversation-controls .control-btn {
      margin-left: 8px;
    }

    /* Analysis Section Styles */
    .analysis-section {
      padding: 16px;
    }

    .analysis-title, .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      font-family: var(--main-font-family);
    }

    .emotion-indicators {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .emotion-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-primary);
    }

    .emotion-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .analysis-text {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .analysis-point {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .point-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .point-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: var(--main-font-family);
    }

    .analysis-point p {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-secondary);
      margin: 0;
      font-family: var(--main-font-family);
    }

    /* Info Tab Specific Styles */
    .conversation-type-section,
    .metrics-section,
    .balance-section,
    .topics-section {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .conversation-summary p {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
      margin: 0;
      font-family: var(--main-font-family);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .metric-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .metric-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .metric-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .balance-bars {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .balance-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .balance-label {
      font-size: 13px;
      color: var(--text-primary);
      min-width: 40px;
    }

    .balance-bar {
      flex: 1;
      height: 8px;
      background: rgba(128, 128, 128, 0.2);
      border-radius: 4px;
      overflow: hidden;
    }

    .balance-fill {
      height: 100%;
      background: var(--accent-color);
      transition: width 0.3s ease;
    }

    .balance-percentage {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: right;
    }

    .topic-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .topic-btn {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 0;
      background: transparent;
      color: var(--text-primary);
      font-size: 12px;
      font-family: var(--main-font-family);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .topic-btn:hover {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    /* Conversation Info and Insights Styles */
    .conversation-info,
    .conversation-insights {
      padding: 16px;
    }

    .info-item,
    .insight-item {
      margin-bottom: 12px;
      padding: 12px;
      background: rgba(247, 249, 243, 0.5);
      border-radius: 8px;
      border-left: 3px solid var(--accent-color);
    }

         .info-item strong,
     .insight-item strong {
       color: var(--accent-color);
       font-family: var(--main-font-family);
       margin-left: 8px;
     }

     /* Analysis Section Styles */
     .analysis-section {
       margin-bottom: 25px;
       padding: 1rem;
       border: 1px solid var(--border-color);
       border-radius: 12px;
       background: rgba(247, 249, 243, 0.5);
     }

     .analysis-title {
       font-size: 16px;
       font-weight: 600;
       color: var(--text-primary);
       margin-bottom: 15px;
       font-family: var(--main-font-family);
     }

     .emotion-indicators {
       display: flex;
       flex-direction: column;
       gap: 12px;
       margin-bottom: 20px;
     }

     .emotion-indicator {
       display: flex;
       align-items: center;
       gap: 10px;
     }

     .emotion-color {
       width: 12px;
       height: 12px;
       border-radius: 50%;
     }

     .emotion-indicator span {
       font-size: 14px;
       color: var(--text-primary);
       font-family: var(--main-font-family);
     }

     .analysis-text {
       margin-top: 20px;
     }

     .analysis-point {
       margin-bottom: 15px;
     }

     .point-label {
       display: block;
       font-weight: 600;
       color: var(--accent-color);
       margin-bottom: 8px;
       font-family: var(--main-font-family);
     }

     .analysis-point p {
       font-size: 14px;
       line-height: 1.6;
       color: var(--text-primary);
       margin: 0;
       font-family: var(--main-font-family);
     }

     /* Statistics Section */
     .statistics-section {
       margin-bottom: 25px;
       padding: 1rem;
       border: 1px solid var(--border-color);
       border-radius: 12px;
       background: rgba(247, 249, 243, 0.5);
     }

     .stats-title {
       font-size: 16px;
       font-weight: 600;
       color: var(--text-primary);
       margin-bottom: 8px;
       font-family: var(--main-font-family);
     }

     .stats-text {
       font-size: 14px;
       color: var(--text-secondary);
       margin-bottom: 15px;
       font-family: var(--main-font-family);
     }

     .stats-grid {
       display: flex;
       gap: 20px;
     }

     .stat-item {
       display: flex;
       flex-direction: column;
       align-items: center;
       text-align: center;
     }

     .stat-value {
       font-size: 14px;
       font-weight: 600;
       color: var(--text-secondary);
       margin-bottom: 4px;
       font-family: var(--main-font-family);
     }

     .stat-label {
       font-size: 14px;
       color: var(--text-primary);
       font-family: var(--main-font-family);
     }

     /* Quality Section */
     .quality-section {
       margin-bottom: 25px;
       padding: 1rem;
       border: 1px solid var(--border-color);
       border-radius: 12px;
       background: rgba(247, 249, 243, 0.5);
     }

     .quality-title {
       font-size: 16px;
       font-weight: 600;
       color: var(--text-primary);
       margin-bottom: 15px;
       font-family: var(--main-font-family);
     }

     .quality-bars {
       display: flex;
       flex-direction: column;
       gap: 15px;
     }

     .quality-item {
       display: flex;
       flex-direction: column;
       gap: 8px;
     }

     .quality-labels {
       display: flex;
       justify-content: space-between;
       align-items: center;
       font-size: 14px;
       font-family: var(--main-font-family);
     }

     .quality-labels span:first-child {
       color: var(--text-primary);
       font-weight: 500;
     }

     .quality-labels span:last-child {
       color: var(--text-secondary);
     }

     .quality-bar {
       height: 8px;
       background: #e0e0e0;
       border-radius: 4px;
       overflow: hidden;
     }

     .quality-fill {
       height: 100%;
       background: var(--accent-color);
       transition: width 0.3s ease;
     }

     /* Topics Section */
     .topics-section {
       margin-bottom: 25px;
       padding: 1rem;
       border: 1px solid var(--border-color);
       border-radius: 12px;
       background: rgba(247, 249, 243, 0.5);
     }

     .topics-title {
       font-size: 16px;
       font-weight: 600;
       color: var(--text-primary);
       margin-bottom: 15px;
       font-family: var(--main-font-family);
     }

     .topic-buttons {
       display: flex;
       gap: 10px;
       flex-wrap: wrap;
     }

     .topic-btn {
       padding: 8px 16px;
       background: var(--accent-color);
       color: white;
       border: none;
       border-radius: 20px;
       font-size: 12px;
       font-weight: 500;
       cursor: pointer;
       transition: all 0.3s ease;
       font-family: var(--main-font-family);
     }

     .topic-btn:hover {
       background: var(--accent-hover);
       transform: translateY(-1px);
     }

     /* Info Tab Sections - Reference Image Style */
     .conversation-type-section,
     .metrics-section,
     .balance-section,
     .topics-section {
       margin-bottom: 24px;
       padding-bottom: 20px;
       border-bottom: 1px solid var(--sidepanel-border);
     }

     .conversation-type-section:last-child,
     .metrics-section:last-child,
     .balance-section:last-child,
     .topics-section:last-child {
       border-bottom: none;
       margin-bottom: 0;
     }

     .section-title {
       font-size: 16px;
       font-weight: 600;
       color: var(--sidepanel-text-primary);
       font-family: var(--main-font-family);
       margin-bottom: 12px;
       text-align: right;
     }

     /* Old content section styling removed - Now using chat journal .content-section */

     .conversation-summary {
       margin-bottom: 16px;
     }

     .conversation-summary p {
       font-size: 14px;
       line-height: 1.5;
       color: var(--sidepanel-text-secondary);
       font-family: var(--main-font-family);
       text-align: right;
       direction: rtl;
       margin: 0;
     }

     .metrics-grid {
       display: flex;
       flex-direction: column;
       gap: 12px;
     }

     .metric-item {
       display: flex;
       justify-content: space-between;
       align-items: center;
       padding: 8px 0;
     }

     .metric-label {
       font-size: 14px;
       font-weight: 500;
       color: var(--sidepanel-text-secondary);
       font-family: var(--main-font-family);
     }

     .metric-value {
       font-size: 14px;
       font-weight: 600;
       color: var(--sidepanel-text-primary);
       font-family: var(--main-font-family);
     }

     .balance-bars {
       display: flex;
       flex-direction: column;
       gap: 12px;
     }

     .balance-item {
       display: flex;
       align-items: center;
       gap: 12px;
     }

           /* Old category and insight styling removed - Now using chat journal interface CSS above */

     .balance-label {
       font-size: 14px;
       font-weight: 500;
       color: var(--sidepanel-text-primary);
       font-family: var(--main-font-family);
       min-width: 60px;
       text-align: right;
     }

     .balance-bar {
       flex: 1;
       height: 8px;
       background: var(--sidepanel-border);
       border-radius: 4px;
       overflow: hidden;
     }

     .balance-fill {
       height: 100%;
       background: var(--sidepanel-text-secondary);
       border-radius: 4px;
       transition: width 0.3s ease;
     }

     .balance-percentage {
       font-size: 12px;
       font-weight: 500;
       color: var(--sidepanel-text-secondary);
       font-family: var(--main-font-family);
       min-width: 40px;
       text-align: left;
     }

     .topic-buttons {
       display: flex;
       gap: 8px;
       flex-wrap: wrap;
       justify-content: flex-start;
     }

     .topic-btn {
       padding: 6px 12px;
       background: var(--sidepanel-bg);
       color: var(--sidepanel-text-secondary);
       border: 1px solid var(--sidepanel-border);
       border-radius: 6px;
       font-size: 12px;
       font-weight: 500;
       cursor: pointer;
       transition: all 0.3s ease;
       font-family: var(--main-font-family);
     }

     .topic-btn:hover {
       background: var(--sidepanel-text-secondary);
       color: var(--sidepanel-card-bg);
       border-color: var(--sidepanel-text-secondary);
     }

         /* Insights Section - Reference Image Style */
    .insights-content {
      padding: 0;
      background: #f7f9f3;
      border-radius: 0 !important;
    }

    .analysis-section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e6e2;
    }

    .analysis-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .analysis-title {
      font-size: 16px;
      font-weight: 400;
      color: #333333;
      font-family: var(--font-family-retro) !important;
      margin-bottom: 16px;
      text-align: right;
    }

    /* New Insights Tabs Styling - Retro Design Matching Transcript Segments */
    .insights-tabs-container {
      direction: rtl;
      font-family: var(--font-family-retro);
    }

    .insights-tabs-nav {
      border-bottom: none !important;
    }

    /* Override colored tab titles to make them all the same color */
    .insights-tabs-nav .insights-tab {
      color: #666666 !important;
    }

    .insights-tabs-nav .insights-tab.active {
      color: #171717 !important;
    }

    /* Override all colored titles in insight content */
    .insights-tab-content h3,
    .insights-tab-content h4,
    .insights-tab-content .title,
    .insights-tab-content [style*="color"] {
      color: #333333 !important;
      font-weight: 400 !important;
    }

    /* Override any remaining colored text */
    .insights-tab-content * {
      color: inherit !important;
      font-weight: 400 !important;
    }

    .insights-tabs {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 20px;
    }

    .insights-tab {
      background: transparent !important;
      border: 1px solid #e5e6e2 !important;
      border-bottom: 1px solid #e5e6e2 !important;
      border-radius: 0 !important;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: none;
      font-family: var(--font-family-retro) !important;
      text-align: right;
      color: #666666 !important;
      font-weight: 400;
      font-size: 14px;
    }

    .insights-tab:hover {
      background: transparent !important;
      border-color: #000000 !important;
      border-bottom-color: #000000 !important;
      transform: translateY(-1px);
    }

    .insights-tab.active {
      background: transparent !important;
      border: 1px solid #171717 !important;
      border-bottom: 1px solid #171717 !important;
      color: #171717 !important;
    }

    .tab-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .tab-title {
      font-size: 14px;
      font-weight: 400;
      color: inherit;
      flex: 1;
      font-family: var(--font-family-retro) !important;
    }

    .progress-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 80px;
    }

    .progress-bar {
      width: 40px;
      height: 6px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 0 !important;
      overflow: hidden;
      position: relative;
      border: 1px solid #e5e6e2;
    }

    .progress-fill {
      height: 100%;
      background: #FF9500;
      border-radius: 0 !important;
      transition: width 0.6s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      font-size: 14px;
      font-weight: 400;
      color: inherit;
      min-width: 30px;
      font-family: var(--font-family-retro) !important;
    }

    /* Different progress bar colors based on score - Updated to match tab colors */
    .insights-tab[data-insight="communication"] .progress-fill {
      background: #9b59b6;
    }

    .insights-tab[data-insight="relationship"] .progress-fill {
      background: #3498db;
    }

    .insights-tab[data-insight="strengths"] .progress-fill {
      background: #1abc9c;
    }

    .insights-tab[data-insight="challenges"] .progress-fill {
      background: #D08800;
    }

    .insights-tab[data-insight="emotions"] .progress-fill {
      background: #D08800;
    }

    .insights-tab[data-insight="overall"] .progress-fill {
      background: #3498db;
    }

    .insights-content-area {
      margin-top: 20px;
    }

    .insight-tab-content {
      display: none;
      border: 1px solid #e5e6e2;
      border-radius: 0 !important;
      background: #ffffff;
      padding: 1.5rem;
      margin-top: 8px;
    }

    .insight-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
      border: 1px solid #e5e6e2 !important;
      border-radius: 0 !important;
      background: transparent !important;
      padding: 1.5rem !important;
      margin-top: 8px;
    }

    /* Override inline styles for all insight tab content divs */
    .insights-tab-content {
      border: 1px solid #e5e6e2 !important;
      border-radius: 0 !important;
      background: transparent !important;
      padding: 1.5rem !important;
      margin-top: 8px;
    }

         @keyframes fadeIn {
       from { opacity: 0; transform: translateY(10px); }
       to { opacity: 1; transform: translateY(0); }
     }

     /* Additional Insights Tab Styling for visualization.html */
           .insights-tab {
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }

     .insights-tab:hover {
       transform: translateY(-2px);
     }

     .insights-tab.active {
       border-left: 3px solid #677eea;
     }

     .tab-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       width: 100%;
     }

     .progress-bar {
       position: relative;
       overflow: hidden;
     }

     .progress-fill {
       position: relative;
       overflow: hidden;
     }

         .insight-section {
      margin-bottom: 15px;
      padding: 12px;
      background: #ffffff;
      border-radius: 0 !important;
      border: 1px solid #e5e6e2;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: var(--font-family-retro) !important;
    }

    .insight-section:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: #000000;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

     .insight-indicator {
       width: 8px;
       height: 8px;
       border-radius: 50%;
       display: inline-block;
       margin-left: 8px;
     }

         .insight-indicator.blue { background: #3498db; }
    .insight-indicator.green { background: #1abc9c; }
    .insight-indicator.purple { background: #9b59b6; }
    .insight-indicator.amber { background: #D08800; }

         .insight-title {
      font-weight: 400;
      font-size: 14px;
      margin-bottom: 8px;
      color: #333333 !important;
      font-family: var(--font-family-retro) !important;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .insight-color-square {
      width: 12px;
      height: 12px;
      border-radius: 0 !important;
      flex-shrink: 0;
    }

    .insight-color-square.blue { background: #4A90E2; }
    .insight-color-square.green { background: #16A085; }
    .insight-color-square.purple { background: #9013FE; }
    .insight-color-square.orange { background: #FF9500; }
    .insight-color-square.red { background: #D0021B; }
    .insight-color-square.pink { background: #FF6B9D; }

    /* Colored squares for each tab type */
    .insight-color-square.communication { background: #4A90E2; }
    .insight-color-square.emotions { background: #9013FE; }
    .insight-color-square.key-insights { background: #16A085; }
    .insight-color-square.quality { background: #27AE60; }

    /* Title squares under main navigation tab titles */
    .insights-tabs-nav .insights-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .insights-tabs-nav .insights-tab::after {
      content: '';
      display: block !important;
      width: 25px;
      height: 3px;
      margin-top: 6px;
      border-radius: 0;
      position: relative;
      z-index: 1;
    }

    /* Color squares for each main tab type */
    .insights-tabs-nav .insights-tab[data-insights-tab="communication"]::after { background: #9b59b6 !important; }
    .insights-tabs-nav .insights-tab[data-insights-tab="emotions"]::after { background: #D08800 !important; }
    .insights-tabs-nav .insights-tab[data-insights-tab="key-insights"]::after { background: #1abc9c !important; }
    .insights-tabs-nav .insights-tab[data-insights-tab="quality"]::after { background: #3498db !important; }



    /* Add borders to all insight content divs */
    .insights-tab-content > div {
      border: 1px solid #e5e6e2;
      border-radius: 0 !important;
      padding: 12px;
      margin-bottom: 8px;
      background: transparent;
    }

    /* Remove borders from section headers */
    .insights-tab-content .section-header {
      border: none !important;
      padding: 0 !important;
      margin-bottom: 20px !important;
    }

    /* Align content paragraphs with the title */
    .insights-tab-content > div:not(.section-header) {
      padding-left: 12px !important;
      padding-right: 12px !important;
      text-align: right;
    }

    .insights-tab-content .section-header h4 {
      margin-bottom: 15px !important;
    }

    /* Change "×ª×•×‘× ×•×ª ××¤×ª×—" to shorter name */
    .insights-tab-content h4 {
      position: relative;
    }

    /* Make sure the squares are visible */
    .insights-tab-content h4::after {
      content: '';
      display: block !important;
      width: 20px;
      height: 4px;
      margin-top: 8px;
      border-radius: 0;
      position: relative;
      z-index: 1;
    }





    .insight-content {
      font-size: 13px;
      line-height: 1.5;
      color: #666666 !important;
      font-family: var(--font-family-retro) !important;
    }

     .insight-content ul {
       margin: 0;
       padding-right: 20px;
     }

     .insight-content li {
       margin-bottom: 5px;
     }

       .emotion-indicators {
       display: flex;
       flex-wrap: wrap;
       gap: 8px;
       margin-bottom: 20px;
       justify-content: flex-start;
     }

     .emotion-indicator {
       display: flex;
       align-items: center;
       gap: 6px;
       padding: 4px 8px;
       background: #ffffff;
       border-radius: 0 !important;
       border: 1px solid #e5e6e2;
       font-family: var(--font-family-retro) !important;
     }

     .emotion-color {
       width: 12px;
       height: 12px;
       border-radius: 0 !important;
       flex-shrink: 0;
     }

     .emotion-indicator span {
       font-size: 12px;
       font-weight: 500;
       color: #666666;
       font-family: var(--font-family-retro) !important;
     }

     .analysis-text {
       display: flex;
       flex-direction: column;
       gap: 16px;
     }

     .analysis-point {
       padding: 16px;
       background: var(--sidepanel-bg);
       border-radius: 8px;
       border: 1px solid var(--sidepanel-border);
     }

     .point-indicator {
       width: 12px;
       height: 12px;
       border-radius: 2px;
       display: inline-block;
       margin-left: 8px;
       flex-shrink: 0;
     }

     .point-label {
       font-size: 14px;
       font-weight: 600;
       color: var(--sidepanel-text-primary);
       font-family: var(--main-font-family);
       margin-bottom: 8px;
       display: inline-block;
     }

     .analysis-point p {
       font-size: 14px;
       line-height: 1.5;
       color: var(--sidepanel-text-secondary);
       font-family: var(--main-font-family);
       text-align: right;
       direction: rtl;
       margin: 8px 0 0 0;
     }

     /* CONSOLIDATED Reference Image Segment Styles */
     [class*="specific-segment"] {
       background: #ffffff;
       border: 1px solid var(--sidepanel-border);
       padding: 1.5rem;
       border-radius: 0 !important;
       gap: 1.0625rem;
       align-self: stretch;
     }

     [class*="specific-segment"]:last-child {
       border-bottom: none;
       margin-bottom: 0;
     }

     [class*="person-name-emotions"] {
       display: flex;
       flex-direction: column;
       gap: 12px;
       margin-bottom: 12px;
     }

     .avi-shemesh,
     [class*="avi-shemesh-"],
     [class*="span-tag-a"],
     [class*="span-2f"] {
       font-size: 14px;
       font-weight: 600;
       color: var(--sidepanel-text-primary);
       font-family: var(--main-font-family);
       text-align: right;
     }

     [class*="emotions-div"] {
       display: flex;
       flex-wrap: wrap;
       gap: 8px;
       justify-content: flex-start;
     }

     [class*="specific-emotion"] {
       display: flex;
       align-items: center;
       gap: 6px;
       padding: 4px 8px;
       background: var(--sidepanel-bg);
       border-radius: 6px;
       border: 1px solid var(--sidepanel-border);
     }

     [class*="rectangle"] {
       width: 12px;
       height: 12px;
       border-radius: 2px;
       flex-shrink: 0;
     }

     .span-tag,
     .span-tag-4,
     .span-tag-7,
     .span-tag-e,
     .span-tag-11,
     .surprise,
     .frustration,
     .worry,
     .surprise-1e,
     .span,
     .span-28,
     .span-2b,
     .span-33,
     .tag-span,
     .tag-span-38 {
       font-size: 12px;
       font-weight: 500;
       color: var(--sidepanel-text-secondary);
       font-family: var(--main-font-family);
     }

     .discussion-topic,
     .team-discussion,
     .team-discussion-1f,
     .span-2c,
     .discussion-topic-39 {
       font-size: 14px;
       line-height: 1.4;
       color: var(--sidepanel-text-primary);
       font-family: var(--main-font-family);
       text-align: right;
       direction: rtl;
       margin-top: 8px;
     }

    /* === CONSOLIDATED CORNER RADIUS REMOVAL === */
    .sidebar-content,
    .info-section,
    .transcript-text,
    .emotion-tag,
    .control-btn,
    .volume-slider,
    .volume-slider::-webkit-slider-thumb,
    .volume-slider::-moz-range-thumb,
    .summary-content,
    .themes-container,
    .theme-item,
    .progression-chart,
    .progression-item,
    .metric-item,
    .emotion-progression-bar,
    .emotion-progression-fill,
    .summary-highlight,
    #full-transcript-container,
    .transcript-segment,
    .transcript-emotion-tag,
    .search-container,
    .search-input,
    .main-nav-tab,
    .main-tab-content,
    .topic-item,
    .decision-item,
    .action-item,
    .atmosphere-container,
    .conversation-segment,
    .segment-emotion-tag,
    .info-item,
    .insight-item,
    .analysis-section,
    .statistics-section,
    .quality-section,
    .topics-section,
    .topic-btn,
    .balance-bar,
    .balance-fill,
    .quality-bar,
    .quality-fill,
    /* All segments, emotions and rectangles (consolidated) */
    [class*="specific-segment"],
    [class*="specific-emotion"],
    [class*="rectangle"] {
      border-radius: 0 !important;
    }

    /* === REMOVE BORDER FROM CONVERSATION HEADER === */
    .main-content-header,
    .conversation-header {
      border: none !important;
      border-bottom: none !important;
    }

    /* === FLOW DESIGN SPECIFICATIONS - FINAL OVERRIDES === */
    .main-content-header {
      width: 20rem !important; /* Fixed width */
      height: auto !important; /* Hug content */
      min-height: 11.125rem !important; /* 178px minimum height */
      padding: 1.5rem !important; /* 24px padding */
      margin-bottom: 0.5rem !important; /* Reduced gap */
      display: flex !important;
      flex-direction: column !important;
      justify-content: center !important;
    }
    
    .main-nav-tabs {
      width: 20rem !important; /* Fixed width when expanded */
      height: auto !important; /* Hug content */
      min-height: 11.125rem !important; /* 178px minimum height */
      padding: 1.5rem !important; /* 24px padding */
      gap: 1.25rem !important; /* 20px gap between tabs */
      margin-bottom: 0.5rem !important; /* Reduced gap */
      flex-direction: row !important;
    }
    
    #sidebar:not(.closed) .main-nav-tabs {
      width: 20rem !important; /* Fixed width when expanded */
    }
    
    .conversation-header {
      margin-bottom: 0.25rem !important; /* Reduced gap */
    }
   </style>
</head>

<body>
  <div id="main-content-wrapper">
      <!-- Right Sidebar - Complete Chat Journal Interface Structure -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h1 id="conversation-title">×˜×•×¢×Ÿ...</h1>
          <div class="time" id="conversation-date">×˜×•×¢×Ÿ...</div>
        </div>
        
        <div class="sidebar-tabs">
          <div class="sidebar-tab active" data-tab="transcript-content">×ª××œ×•×œ</div>
          <div class="sidebar-tab" data-tab="insights-content">×ª×•×‘× ×•×ª</div>
        </div>
        
        <div class="sidebar-content" style="padding: 20px 15px 0 15px;">
          <!-- Transcript Tab Content -->
          <div class="tab-content active" id="transcript-content">
            <div class="transcript-card">
              <div class="transcript-header">
                <div class="transcript-title">××‘×™ ×©××¢×•×Ÿ</div>
                <div class="transcript-legend">
                  <div class="legend-item">
                    <div class="legend-dot orange"></div>
                    <span>×ª××œ×•×œ</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot blue"></div>
                    <span>×–×™×”×•×™</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot yellow"></div>
                    <span>×”××œ×¦×•×ª</span>
                  </div>
                </div>
              </div>
              <div class="transcript-content">
                ×©×œ×•× ×œ×›×•×œ×, ×× ×™ ×¨×•×¦×” ×œ×”×—×œ×™×˜ ×‘×‘×™×ª×™ ×¢×œ ×ª×•×›× ×™×•×ª ×”×“×¨×›×•×ª. ×–×” × ×•×©× ×©×˜×•×‘ ×œ×¢×‘×•×“ ×¢×œ×™×• ×¢× ×¦×•×•×ª×•×ª
              </div>
            </div>
            
            <div class="transcript-card">
              <div class="transcript-header">
                <div class="transcript-title">××‘×™ ×©××¢×•×Ÿ</div>
                <div class="transcript-legend">
                  <div class="legend-item">
                    <div class="legend-dot orange"></div>
                    <span>×ª××œ×•×œ</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot blue"></div>
                    <span>×–×™×”×•×™</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot yellow"></div>
                    <span>×”××œ×¦×•×ª</span>
                  </div>
                </div>
              </div>
              <div class="transcript-content">
                ×©×œ×•× ×œ×›×•×œ×, ×× ×™ ×¨×•×¦×” ×œ×”×—×œ×™×˜ ×‘×‘×™×ª×™ ×¢×œ ×ª×•×›× ×™×•×ª ×”×“×¨×›×•×ª. ×–×” × ×•×©× ×©×˜×•×‘ ×œ×¢×‘×•×“ ×¢×œ×™×• ×¢× ×¦×•×•×ª×•×ª
              </div>
            </div>
            
            <div class="transcript-card">
              <div class="transcript-header">
                <div class="transcript-title">××‘×™ ×©××¢×•×Ÿ</div>
                <div class="transcript-legend">
                  <div class="legend-item">
                    <div class="legend-dot orange"></div>
                    <span>×ª××œ×•×œ</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot blue"></div>
                    <span>×–×™×”×•×™</span>
                  </div>
                  <div class="legend-item">
                    <div class="legend-dot yellow"></div>
                    <span>×”××œ×¦×•×ª</span>
                  </div>
                </div>
              </div>
              <div class="transcript-content">
                ×©×œ×•× ×œ×›×•×œ×, ×× ×™ ×¨×•×¦×” ×œ×”×—×œ×™×˜ ×‘×‘×™×ª×™ ×¢×œ ×ª×•×›× ×™×•×ª ×”×“×¨×›×•×ª. ×–×” × ×•×©× ×©×˜×•×‘ ×œ×¢×‘×•×“ ×¢×œ×™×• ×¢× ×¦×•×•×ª×•×ª
              </div>
            </div>
          </div>
          
          <!-- Insights Tab Content -->
          <div class="tab-content" id="insights-content">
            <!-- AI Insights Content -->
            <div id="insight-content-dynamic">
              <div class="insights-template-container">
                <!-- Insights Tabs -->
                <div class="insights-tabs-nav" style="display: flex; border-bottom: 1px solid #e9ecef; margin-bottom: 15px;">
                  <div class="insights-tab active" data-insights-tab="communication" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid #9b59b6; background: #f9f6ff; color: #9b59b6; font-weight: 500; border-radius: 0;">
                    ×ª×§×©×•×¨×ª
                  </div>
                  <div class="insights-tab" data-insights-tab="emotions" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                    ×¨×’×©×•×ª
                  </div>
                  <div class="insights-tab" data-insights-tab="key-insights" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                  ×ª×•×‘× ×•×ª 
                  </div>
                  <div class="insights-tab" data-insights-tab="quality" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                    ××™×›×•×ª
                  </div>
                </div>

                <!-- Tab Contents -->
                <div class="insights-tab-contents">
                  <!-- Communication Tab Content -->
                  <div class="insights-tab-content active" id="communication-tab" style="background: #f9f6ff; border-right: 4px solid #9b59b6; padding: 15px; border-radius: 0;">
                    <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                      <h4 style="margin: 0; color: #9b59b6; font-size: 16px;">×ª×§×©×•×¨×ª</h4>
                    </div>
                    <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                      <p>× ×™×ª×•×— ×“×¤×•×¡×™ ×ª×§×©×•×¨×ª ×™×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                    </div>
                  </div>

                  <!-- Emotions Tab Content -->
                  <div class="insights-tab-content" id="emotions-tab" style="display: none; background: #fff8f0; border-right: 4px solid #D08800; padding: 15px; border-radius: 0;">
                    <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                      <h4 style="margin: 0; color: #D08800; font-size: 16px;">×¨×’×©×•×ª</h4>
                    </div>
                    <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                      <p>× ×™×ª×•×— ×¨×’×©×™ ×©×œ ×”×©×™×—×” ×™×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                    </div>
                  </div>

                  <!-- Key Insights Tab Content -->
                  <div class="insights-tab-content" id="key-insights-tab" style="display: none; background: #f0fffe; border-right: 4px solid #1abc9c; padding: 15px; border-radius: 0;">
                    <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                      <h4 style="margin: 0; color: #1abc9c; font-size: 16px;">×ª×•×‘× ×•×ª</h4>
                    </div>
                    <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                      <p>×ª×•×‘× ×•×ª ××”×©×™×—×” ×™×•×¦×’×• ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                    </div>
                  </div>

                  <!-- Quality Tab Content -->
                  <div class="insights-tab-content" id="quality-tab" style="display: none; background: #f3f8fe; border-right: 4px solid #3498db; padding: 15px; border-radius: 0;">
                    <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                      <h4 style="margin: 0; color: #3498db; font-size: 16px;">×”×¢×¨×›×ª ××™×›×•×ª</h4>
                    </div>
                    <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                      <p>×”×¢×¨×›×ª ××™×›×•×ª ×”×©×™×—×” ×ª×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                    </div>
                  </div>
                </div>


              </div>
            </div>
          </div>
        </div>
      </div>



      <div id="visualization-canvas-container">
        <div class="loading" id="loading-indicator">×˜×•×¢×Ÿ ×•×™×–×•××œ×™×–×¦×™×”...</div>
      </div>
      
      <!-- Parameters Display Panel - bottom right, next to sidebar, no borders -->
      <div id="parameters-panel" style="position: fixed; bottom: 20px; right: 340px; background: rgba(247, 249, 242, 0.95); padding: 15px 20px; display: block; z-index: 9999; backdrop-filter: blur(5px); font-family: 'Miriam Libre', sans-serif; direction: rtl;">
        <div style="display: flex; gap: 25px; align-items: center; justify-content: center; flex-wrap: wrap;">
          <div class="param-item" style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 14px; color: #6c757d; font-weight: 500;">××•×¨×›×•×‘×ª:</span>
            <span id="blobiness-value" style="font-size: 14px; font-weight: 600; color: #2c3e50; min-width: 30px;">--</span>
          </div>
          <div class="param-item" style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 14px; color: #6c757d; font-weight: 500;">×”×•××•×¨:</span>
            <span id="humor-value" style="font-size: 14px; font-weight: 600; color: #2c3e50; min-width: 30px;">--</span>
          </div>
          <div class="param-item" style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 14px; color: #6c757d; font-weight: 500;">×˜×©×˜×•×©:</span>
            <span id="blur-value" style="font-size: 14px; font-weight: 600; color: #2c3e50; min-width: 30px;">--</span>
          </div>
          <div class="param-item" style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 14px; color: #6c757d; font-weight: 500;">×‘×¨×§:</span>
            <span id="shine-value" style="font-size: 14px; font-weight: 600; color: #2c3e50; min-width: 30px;">--</span>
          </div>
        </div>
      </div>
      
      <!-- Toggle Button - Positioned outside sidebar -->
      <button class="sidebar-arrow-toggle" id="sidebar-toggle">
        <svg id="toggle-icon" viewBox="0 0 24 24" width="20" height="20">
          <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    // Sidebar toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const canvasContainer = document.getElementById('visualization-canvas-container');
      const toggleIcon = document.getElementById('toggle-icon');
      
      function updateToggleIcon(isClosed) {
        if (isClosed) {
          // Show eye icon when sidebar is closed
          toggleIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>';
        } else {
          // Show arrow icon when sidebar is open
          toggleIcon.innerHTML = '<path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
        }
      }
      
      function toggleSidebar() {
        const isClosed = sidebar.classList.contains('closed');
        const parametersPanel = document.getElementById('parameters-panel');
        
        if (isClosed) {
          // Open sidebar
          sidebar.classList.remove('closed');
          canvasContainer.classList.remove('expanded');
          document.body.classList.remove('sidebar-closed');
          updateToggleIcon(false);
          
          // Adjust parameters panel position for open sidebar
          if (parametersPanel) {
            parametersPanel.style.right = '340px'; // 320px sidebar + 20px margin
          }
        } else {
          // Close sidebar
          sidebar.classList.add('closed');
          canvasContainer.classList.add('expanded');
          document.body.classList.add('sidebar-closed');
          updateToggleIcon(true);
          
          // Adjust parameters panel position to align with toggle button
          if (parametersPanel) {
            parametersPanel.style.right = '20px'; // Align exactly with the toggle button position
          }
        }
      }
      
      // Initialize icon state and parameters panel position
      const initialClosed = sidebar.classList.contains('closed');
      updateToggleIcon(initialClosed);
      if (initialClosed) {
        document.body.classList.add('sidebar-closed');
        // Set initial parameters panel position for closed sidebar
        const parametersPanel = document.getElementById('parameters-panel');
        if (parametersPanel) {
          parametersPanel.style.right = '20px'; // Align exactly with toggle button position
        }
      }
      
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
      }
      
      // Insight section click functionality
      const insightSections = document.querySelectorAll('.insight-section');
      
      insightSections.forEach(function(section) {
        section.addEventListener('click', function() {
          const timestamp = this.getAttribute('data-timestamp');
          const segment = this.getAttribute('data-segment');
          
          // Highlight the insight section
          insightSections.forEach(s => s.style.background = '');
          this.style.background = 'rgba(0, 123, 255, 0.1)';
          
          // Show notification about where this insight occurred
          showInsightLocation(timestamp, segment);
          
          // Here you would typically scroll to or highlight the corresponding conversation segment
          // For now, we'll just show a notification
          console.log(`Insight occurred at timestamp: ${timestamp}, segment: ${segment}`);
        });
      });
      
      function showInsightLocation(timestamp, segment) {
        // Create or update notification
        let notification = document.getElementById('insight-notification');
        if (!notification) {
          notification = document.createElement('div');
          notification.id = 'insight-notification';
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 0;
            font-size: 12px;
            font-family: 'Miriam Libre', sans-serif;
            z-index: 5001;
            direction: rtl;
          `;
          document.body.appendChild(notification);
        }
        
        notification.textContent = `×ª×•×‘× ×” ×–×• ×”×ª×¨×—×©×” ×‘-${timestamp} ×‘×©×™×—×” (×§×˜×¢ ${segment})`;
        notification.style.display = 'block';
        
        // Hide notification after 3 seconds
        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }
      
      // Enhanced p5 sketch initialization with better error handling
      let initAttempts = 0;
      const maxInitAttempts = 20;
      
      function safeInitializeP5Sketch() {
        initAttempts++;
        
        // Check if we've exceeded max attempts
        if (initAttempts > maxInitAttempts) {
          console.error('âŒ Failed to initialize p5 sketch after maximum attempts');
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.innerHTML = 'Failed to load visualization. Please refresh the page.';
            loadingIndicator.style.color = '#e74c3c';
          }
          return;
        }
        
        // Check if required elements and functions are available
        const container = document.getElementById('visualization-canvas-container');
        if (!container) {
          console.warn('âš ï¸ Container not ready, retrying...');
          setTimeout(safeInitializeP5Sketch, 200);
          return;
        }
        
        if (typeof p5SketchFunction === 'undefined') {
          console.warn('âš ï¸ p5SketchFunction not ready, retrying...', initAttempts);
          setTimeout(safeInitializeP5Sketch, 200);
          return;
        }
        
        try {
          console.log('âœ… Creating p5 instance for visualization...');
          
          // Clean up any existing instances first
          if (window.p5SketchInstance) {
            try {
              if (typeof window.p5SketchInstance.remove === 'function') {
                window.p5SketchInstance.remove();
                console.log('âœ… Removed existing p5 instance');
              } else if (typeof window.p5SketchInstance.noLoop === 'function') {
                window.p5SketchInstance.noLoop();
                console.log('âœ… Stopped existing p5 instance');
              }
            } catch (e) {
              console.log('â„¹ï¸ Could not clean up existing p5 instance (this is normal):', e.message);
            }
            window.p5SketchInstance = null;
          }
          
          // Clear the container
          container.innerHTML = '';
          
          // Remove loading indicator
          const loadingIndicator = document.getElementById('loading-indicator');
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }
          
          // Create new p5 instance
          window.p5SketchInstance = new p5(p5SketchFunction, container);
          
          // The getCurrentIndex method is now exposed directly from the sketch
          // No need to add it here since it's built into the p5SketchFunction
          
          console.log('âœ… p5 instance created successfully with getCurrentIndex method');
          
        } catch (error) {
          console.error('âŒ Error creating p5 instance:', error);
          
          // Retry after a delay
          setTimeout(safeInitializeP5Sketch, 500);
        }
      }
      
      // Start initialization after libraries are loaded
      const startInitialization = () => {
        // Wait for both p5.js and either p5.sound or sound failure confirmation
        const checkLibraries = () => {
          if (typeof p5 !== 'undefined' && (window.p5SoundLoaded || window.p5SoundFailed)) {
            setTimeout(safeInitializeP5Sketch, 100);
          } else {
            setTimeout(checkLibraries, 100);
          }
        };
        
        checkLibraries();
      };
      
      // Function to update parameters panel with current segment data
      function updateParametersPanel() {
        const parametersPanel = document.getElementById('parameters-panel');
        if (!parametersPanel) {
          console.log('âš ï¸ Parameters panel element not found, DOM might not be ready');
          console.log('ğŸ” Available elements:', document.querySelectorAll('[id*="parameter"]'));
          return;
        }
        
        console.log('âœ… Parameters panel found successfully');
        
        // Always show the panel (simplified for testing)
        parametersPanel.style.display = 'block';
        
        // Get current metadata from the p5 sketch
        let currentMeta = null;
        if (window.p5SketchInstance) {
          if (window.p5SketchInstance.currentMeta) {
            currentMeta = window.p5SketchInstance.currentMeta;
          } else if (window.p5SketchInstance.getCurrentMeta && typeof window.p5SketchInstance.getCurrentMeta === 'function') {
            currentMeta = window.p5SketchInstance.getCurrentMeta();
          }
        }
        
        // Debug information
        console.log('ğŸ” Parameters panel debug:', {
          hasSketchInstance: !!window.p5SketchInstance,
          hasCurrentMeta: !!(currentMeta && Object.keys(currentMeta).length > 0),
          currentMeta: currentMeta
        });
        
        if (currentMeta && Object.keys(currentMeta).length > 0) {
          // Update parameter values
          const blobinessValue = document.getElementById('blobiness-value');
          const humorValue = document.getElementById('humor-value');
          const blurValue = document.getElementById('blur-value');
          const shineValue = document.getElementById('shine-value');
          
          if (blobinessValue) {
            blobinessValue.textContent = currentMeta.blobiness !== undefined ? currentMeta.blobiness : '--';
          }
          if (humorValue) {
            humorValue.textContent = currentMeta.humor !== undefined ? currentMeta.humor : '--';
          }
          if (blurValue) {
            blurValue.textContent = currentMeta.blur !== undefined ? currentMeta.blur : '--';
          }
          if (shineValue) {
            shineValue.textContent = currentMeta.shine !== undefined ? currentMeta.shine : '--';
          }
          
          // Show the panel
          parametersPanel.style.display = 'block';
          console.log('ğŸ¨ Parameters panel updated with data:', {
            blobiness: currentMeta.blobiness,
            humor: currentMeta.humor,
            blur: currentMeta.blur,
            shine: currentMeta.shine
          });
        } else {
          // For debugging, let's show the panel with default values instead of hiding it
          const blobinessValue = document.getElementById('blobiness-value');
          const humorValue = document.getElementById('humor-value');
          const blurValue = document.getElementById('blur-value');
          const shineValue = document.getElementById('shine-value');
          
          if (blobinessValue) blobinessValue.textContent = '×˜×•×¢×Ÿ...';
          if (humorValue) humorValue.textContent = '×˜×•×¢×Ÿ...';
          if (blurValue) blurValue.textContent = '×˜×•×¢×Ÿ...';
          if (shineValue) shineValue.textContent = '×˜×•×¢×Ÿ...';
          
          // Show the panel even without data for debugging
          parametersPanel.style.display = 'block';
          console.log('âš ï¸ No metadata available yet, showing panel with loading values');
        }
      }
      
      // Update parameters panel periodically
      setInterval(updateParametersPanel, 2000);
      
      // Also update when the sketch is ready
      window.addEventListener('message', function(event) {
        if (event.data && (event.data.type === 'segmentChanged' || event.data.type === 'metadataUpdate')) {
          setTimeout(updateParametersPanel, 100);
        }
      });
      
      // Update when sketch becomes available
      setTimeout(updateParametersPanel, 3000);
      
      // Initialize parameters panel when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ DOM loaded, initializing parameters panel...');
        const parametersPanel = document.getElementById('parameters-panel');
        if (parametersPanel) {
          parametersPanel.style.display = 'block';
          console.log('âœ… Parameters panel found and forced to show');
          updateParametersPanel();
        } else {
          console.log('âŒ Parameters panel not found even after DOM loaded');
        }
      });
      
      // Also try with a timeout as backup
      setTimeout(function() {
        console.log('ğŸš€ Backup initialization for parameters panel...');
        const parametersPanel = document.getElementById('parameters-panel');
        if (parametersPanel) {
          parametersPanel.style.display = 'block';
          console.log('âœ… Parameters panel found via backup method');
          updateParametersPanel();
        } else {
          console.log('âŒ Parameters panel still not found via backup method');
          console.log('ğŸ” DOM state:', document.readyState);
          console.log('ğŸ” All elements with IDs:', Array.from(document.querySelectorAll('[id]')).map(el => el.id));
        }
      }, 2000);
      
      startInitialization();
      
      // Test function for insights refresh with detailed logging
      window.testInsightsRefresh = async function() {
        console.log('ğŸ” Test Insights Refresh Started');
        
        try {
          // Check if required functions exist
          console.log('âœ“ window.displayAIInsights exists:', typeof window.displayAIInsights);
          console.log('âœ“ window.getCurrentConversationFolder exists:', typeof window.getCurrentConversationFolder);
          console.log('âœ“ window.loadConversationsConfig exists:', typeof window.loadConversationsConfig);
          
          // Try to get current folder
          const currentFolder = window.getCurrentConversationFolder ? window.getCurrentConversationFolder() : null;
          console.log('ğŸ“ Current folder:', currentFolder);
          
          // Try to load config
          if (window.loadConversationsConfig) {
            console.log('ğŸ”„ Loading conversations config...');
            await window.loadConversationsConfig();
            console.log('âœ“ Config loaded');
            
            // Refresh insights with updated speaker names if available
            if (typeof window.refreshInsightsWithSpeakerNames === 'function') {
              setTimeout(() => {
                window.refreshInsightsWithSpeakerNames();
              }, 200);
            }
          }
          
          // Check if insights exist in config
          if (window.conversationsConfig) {
            const hasInsights = window.conversationsConfig.conversations && 
                               window.conversationsConfig.conversations[currentFolder] &&
                               window.conversationsConfig.conversations[currentFolder].metadata &&
                               window.conversationsConfig.conversations[currentFolder].metadata.ai_insights;
            console.log('ğŸ¤– AI insights available:', hasInsights);
            
            if (hasInsights) {
              const insights = window.conversationsConfig.conversations[currentFolder].metadata.ai_insights;
              console.log('ğŸ“Š Insights keys:', Object.keys(insights));
            }
          } else {
            console.log('âŒ conversationsConfig not available');
          }
          
          // Try to display insights
          if (window.displayAIInsights) {
            console.log('ğŸ¯ Calling displayAIInsights...');
            await window.displayAIInsights();
            console.log('âœ… displayAIInsights completed');
          } else {
            console.log('âŒ displayAIInsights function not available');
          }
          
          // Update the content container to show status
          const container = document.getElementById('insight-content-dynamic');
          if (container && !container.innerHTML.includes('ğŸ¤–')) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;"><p>ğŸ”„ ×¨×¢× ×•×Ÿ ×‘×•×¦×¢ - ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ×¤×¨×˜×™× × ×•×¡×¤×™×</p><p>×× ××™×Ÿ ×ª×•×‘× ×•×ª, ×•×“× ×©× ×•×¦×¨×• ×ª×•×‘× ×•×ª AI ×¢×‘×•×¨ ×”×©×™×—×” ×”× ×•×›×—×™×ª</p></div>';
          }
          
        } catch (error) {
          console.error('âŒ Error in testInsightsRefresh:', error);
          const container = document.getElementById('insight-content-dynamic');
          if (container) {
            container.innerHTML = `<div style="padding: 20px; text-align: center; color: #e74c3c;"><p>âŒ ×©×’×™××” ×‘×¨×¢× ×•×Ÿ ×”×ª×•×‘× ×•×ª</p><p>${error.message}</p></div>`;
          }
        }
      }
      
      // Auto-load AI insights function
      window.simpleInsightsRefresh = function() {
        const container = document.getElementById('insight-content-dynamic');
        if (container) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;"><p>ğŸ”„ ×˜×•×¢×Ÿ ×ª×•×‘× ×•×ª AI...</p></div>';
        }
        
        // Extract conversation folder from URL
        const urlParams = new URLSearchParams(window.location.search);
        const conversationFolder = urlParams.get('folder') || 'convo1';
        
        // First try to load from localStorage (offline mode)
        const cachedInsights = localStorage.getItem(`insights_${conversationFolder}`);
        if (cachedInsights) {
          try {
            const insights = JSON.parse(cachedInsights);
            window.displayInsightsUI(insights, conversationFolder, container);
            return;
          } catch (e) {
            console.log('Failed to parse cached insights, fetching fresh data');
          }
        }
        
        // Try to load insights directly from API - try multiple ports
        async function tryFetchInsights() {
          const ports = ['8000', '8001', window.location.port || '8000'];
          
          for (const port of ports) {
            try {
              const response = await fetch(`http://localhost:${port}/config/conversations_config.json`);
              if (response.ok) {
                return await response.json();
              }
            } catch (e) {
              // Silent fallback to next port
            }
          }
          throw new Error('Could not fetch from any port');
        }
        
        tryFetchInsights()
          .then(data => {
            if (data.conversations && data.conversations[conversationFolder] && 
                data.conversations[conversationFolder].metadata && 
                data.conversations[conversationFolder].metadata.ai_insights) {
              
              const insights = data.conversations[conversationFolder].metadata.ai_insights;
              window.displayInsightsUI(insights, conversationFolder, container);
            } else {
              // Show the new insights template instead of the old message
              container.innerHTML = `
                <div class="insights-template-container">
                  <!-- Insights Tabs -->
                  <div class="insights-tabs-nav" style="display: flex; border-bottom: 1px solid #e9ecef; margin-bottom: 15px;">
                    <div class="insights-tab active" data-insights-tab="communication" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid #667eea; background: #f8f9ff; color: #667eea; font-weight: 500; border-radius: 0;">
                      ×ª×§×©×•×¨×ª
                    </div>
                    <div class="insights-tab" data-insights-tab="emotions" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                      ×¨×’×©×•×ª
                    </div>
                    <div class="insights-tab" data-insights-tab="key-insights" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                      ×ª×•×‘× ×•×ª
                    </div>
                    <div class="insights-tab" data-insights-tab="quality" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                      ××™×›×•×ª
                    </div>
                  </div>

                  <!-- Tab Contents -->
                  <div class="insights-tab-contents">
                    <!-- Communication Tab Content -->
                    <div class="insights-tab-content active" id="communication-tab" style="background: #f8f9ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 0;">
                      <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #667eea; font-size: 16px;">×ª×§×©×•×¨×ª</h4>
                      </div>
                      <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                        <p>× ×™×ª×•×— ×“×¤×•×¡×™ ×ª×§×©×•×¨×ª ×™×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                      </div>
                    </div>

                    <!-- Emotions Tab Content -->
                    <div class="insights-tab-content" id="emotions-tab" style="display: none; background: #fff5f5; border-right: 4px solid #e74c3c; padding: 15px; border-radius: 0;">
                      <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #e74c3c; font-size: 16px;">×¨×’×©×•×ª</h4>
                      </div>
                      <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                        <p>× ×™×ª×•×— ×¨×’×©×™ ×©×œ ×”×©×™×—×” ×™×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                      </div>
                    </div>

                    <!-- Key Insights Tab Content -->
                    <div class="insights-tab-content" id="key-insights-tab" style="display: none; background: #f0f8ff; border-right: 4px solid #2196f3; padding: 15px; border-radius: 0;">
                      <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #2196f3; font-size: 16px;">×ª×•×‘× ×•×ª</h4>
                      </div>
                      <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                        <p>×ª×•×‘× ×•×ª ××”×©×™×—×” ×™×•×¦×’×• ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                      </div>
                    </div>

                    <!-- Quality Tab Content -->
                    <div class="insights-tab-content" id="quality-tab" style="display: none; background: #f3f8fe; border-right: 4px solid #3498db; padding: 15px; border-radius: 0;">
                      <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #3498db; font-size: 16px;">×”×¢×¨×›×ª ××™×›×•×ª</h4>
                      </div>
                      <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                        <p>×”×¢×¨×›×ª ××™×›×•×ª ×”×©×™×—×” ×ª×•×¦×’ ×›××Ÿ ×œ××—×¨ × ×™×ª×•×— AI</p>
                      </div>
                    </div>
                  </div>


                </div>
              `;
            }
          })
          .catch(error => {
            // On error, still show the template but with error status
            container.innerHTML = `
              <div class="insights-template-container">
                <div style="text-align: center; padding: 20px; background: #fff5f5; border: 1px solid #ffcccc; margin-bottom: 15px; border-radius: 0;">
                  <p style="color: #e74c3c; font-weight: 500; margin: 0 0 10px 0;">×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª</p>
                  <p style="color: #6c757d; font-size: 13px; margin: 0;">×ª×•×‘× ×•×ª ×™×¢×•×‘×“×• ×× ×ª×•× ×™ ×”×©×™×—×”</p>
                </div>

              </div>
            `;
          });
            }
      
      // Display insights UI function - Updated to use new template
      window.displayInsightsUI = function(insights, conversationFolder, container) {
        // Store insights locally for offline access
        localStorage.setItem(`insights_${conversationFolder}`, JSON.stringify(insights));
        
        // Always use the new template structure with tabs
        container.innerHTML = `
          <div class="insights-template-container">
            <!-- Insights Tabs -->
            <div class="insights-tabs-nav" style="display: flex; border-bottom: 1px solid #e9ecef; margin-bottom: 15px;">
              <div class="insights-tab active" data-insights-tab="communication" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid #667eea; background: #f8f9ff; color: #667eea; font-weight: 500; border-radius: 0;">
                ×ª×§×©×•×¨×ª
              </div>
              <div class="insights-tab" data-insights-tab="emotions" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                ×¨×’×©×•×ª
              </div>
              <div class="insights-tab" data-insights-tab="key-insights" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                ×ª×•×‘× ×•×ª
              </div>
              <div class="insights-tab" data-insights-tab="quality" style="flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; background: #f8f9fa; color: #6c757d; font-weight: 500; border-radius: 0;">
                ××™×›×•×ª
              </div>
            </div>

            <!-- Tab Contents -->
            <div class="insights-tab-contents">
              <!-- Communication Tab Content -->
              <div class="insights-tab-content active" id="communication-tab" style="background: #f8f9ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 0;">
                <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                  <h4 style="margin: 0; color: #667eea; font-size: 16px;">×ª×§×©×•×¨×ª</h4>
                </div>
                <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                  <div style="margin-bottom: 10px;"><strong>×“×¤×•×¡×™ ×ª×§×©×•×¨×ª:</strong></div>
                  ${insights.communication_patterns ? Object.entries(insights.communication_patterns).map(([speaker, pattern]) => 
                    `<div style="margin-bottom: 8px; padding: 8px; background: rgba(155, 89, 182, 0.1); border-radius: 0; border-right: 3px solid #9b59b6;">
                      <strong>${speaker}:</strong> ${pattern}
                    </div>`
                  ).join('') : '<p>×œ× ×–××™×Ÿ</p>'}
                </div>
              </div>

              <!-- Emotions Tab Content -->
              <div class="insights-tab-content" id="emotions-tab" style="display: none; background: #fff5f5; border-right: 4px solid #e74c3c; padding: 15px; border-radius: 0;">
                <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                  <h4 style="margin: 0; color: #e74c3c; font-size: 16px;">×¨×’×©×•×ª</h4>
                </div>
                <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                  ${insights.emotional_insights ? `
                    <div style="margin-bottom: 10px;"><strong>×ª×•×‘× ×•×ª ×¨×’×©×™×•×ª:</strong></div>
                    <div style="padding: 10px; background: rgba(208, 136, 0, 0.1); border-radius: 0; line-height: 1.5; border-right: 3px solid #D08800;">
                      ${insights.emotional_insights}
                    </div>
                  ` : ''}
                  ${insights.overall_assessment ? `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(208, 136, 0, 0.1); border-radius: 0; border-right: 3px solid #D08800;">
                      <strong>×”×¢×¨×›×” ×›×œ×œ×™×ª:</strong> ${insights.overall_assessment}
                    </div>
                  ` : ''}
                </div>
              </div>

              <!-- Key Insights Tab Content -->
              <div class="insights-tab-content" id="key-insights-tab" style="display: none; background: #f0f8ff; border-right: 4px solid #2196f3; padding: 15px; border-radius: 0;">
                <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                  <h4 style="margin: 0; color: #2196f3; font-size: 16px;">×ª×•×‘× ×•×ª</h4>
                </div>
                <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                  ${insights.strengths && insights.strengths.length > 0 ? `
                    <div style="margin-bottom: 15px;"><strong>×—×•×–×§×•×ª ××–×•×”×•×ª:</strong></div>
                    ${insights.strengths.map(strength => 
                      `<div style="margin-bottom: 6px; padding: 6px; background: rgba(26, 188, 156, 0.1); border-radius: 0; border-right: 3px solid #1abc9c;">${strength}</div>`
                    ).join('')}
                  ` : ''}
                  
                  ${insights.improvement_recommendations && insights.improvement_recommendations.length > 0 ? `
                    <div style="margin: 15px 0 10px 0;"><strong>×”××œ×¦×•×ª ×œ×©×™×¤×•×¨:</strong></div>
                    ${insights.improvement_recommendations.map(rec => 
                      `<div style="margin-bottom: 6px; padding: 6px; background: rgba(26, 188, 156, 0.1); border-radius: 0; border-right: 3px solid #1abc9c;">${rec}</div>`
                    ).join('')}
                  ` : ''}
                </div>
              </div>

              <!-- Quality Tab Content -->
              <div class="insights-tab-content" id="quality-tab" style="display: none; background: #f3f8fe; border-right: 4px solid #3498db; padding: 15px; border-radius: 0;">
                <div class="section-header" style="display: flex; align-items: center; margin-bottom: 10px;">
                  <h4 style="margin: 0; color: #3498db; font-size: 16px;">×”×¢×¨×›×ª ××™×›×•×ª</h4>
                </div>
                <div class="section-content" style="color: #6c757d; font-size: 14px; line-height: 1.4;">
                  ${insights.relationship_quality ? `
                    <div style="margin-bottom: 10px;"><strong>××™×›×•×ª ×™×—×¡×™×:</strong></div>
                    <div style="padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 0; line-height: 1.5; border-right: 3px solid #3498db;">
                      ${insights.relationship_quality}
                    </div>
                  ` : ''}
                  ${insights.communication_style ? `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 0; border-right: 3px solid #3498db;">
                      <strong>×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª:</strong> ${insights.communication_style}
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>


          </div>
        `;
        
        // Initialize tab switching after content is set
        setTimeout(() => {
          window.initInsightsTabSwitching();
        }, 100);
      }
      
      // Helper function to create insight cards
      function createInsightCard(category, content, color, speaker = '') {
        const card = document.createElement('div');
        card.style.cssText = 'background: transparent; border: 1px solid #BFC4C0; border-radius: 0; padding: 15px; margin-bottom: 12px; position: relative; direction: rtl; text-align: right;';
        
        // Color indicator line on the right (RTL)
        const indicator = document.createElement('div');
        indicator.style.cssText = `position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background: ${color};`;
        card.appendChild(indicator);
        
        // Category header
        const header = document.createElement('div');
        header.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px; padding-right: 12px;';
        
        const categoryDot = document.createElement('div');
        categoryDot.style.cssText = `width: 8px; height: 8px; border-radius: 50%; background: ${color}; margin-left: 8px; flex-shrink: 0;`;
        
        const categoryTitle = document.createElement('div');
        categoryTitle.style.cssText = 'font-size: 14px; font-weight: normal; color: #666; font-family: "Miriam Libre", sans-serif;';
        categoryTitle.textContent = speaker ? `${category} Â· ${speaker}` : category;
        
        header.appendChild(categoryTitle);
        header.appendChild(categoryDot);
        card.appendChild(header);
        
        // Content
        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = 'font-size: 14px; line-height: 1.5; color: #2c3e50; padding-right: 12px; font-family: "Miriam Libre", sans-serif; font-weight: normal;';
        contentDiv.textContent = content;
        
        card.appendChild(contentDiv);
        
        return card;
      }
      

      
      // Auto-load insights when insights tab becomes active  
       function autoLoadInsights() {
         const insightsContent = document.getElementById('insights-content');
         
         if (insightsContent && insightsContent.classList.contains('active')) {
           console.log('ğŸ“± Insights tab is active, auto-loading insights...');
           if (window.simpleInsightsRefresh) {
             window.simpleInsightsRefresh();
           }
         }
       }
       
       // Run auto-load after page loads
       setTimeout(autoLoadInsights, 1500);
      
              // Sidebar tab switching - From chat journal interface
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
          tab.addEventListener('click', function() {
            // Remove active class from all tabs
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show corresponding content
            const targetTab = this.getAttribute('data-tab');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
              targetContent.classList.add('active');
            }
            
            // Load AI content when switching to summary or insights tabs
            if (typeof window.handleTabSwitch === 'function') {
              window.handleTabSwitch(targetTab);
            }
            
                         // Auto-load insights when insights tab is clicked
             if (targetTab === 'insights-content') {
               console.log('ğŸ”„ Insights tab clicked, auto-loading...');
               setTimeout(() => {
                 if (window.simpleInsightsRefresh) {
                   window.simpleInsightsRefresh();
                 }
               }, 200);
             }
          });
        });

        // Category button switching with dynamic content - From chat journal interface
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Get the category and update content
            const category = this.getAttribute('data-category');
            updateInsightContent(category);
          });
        });
      
      // Function to update insight content based on category
      function updateInsightContent(category) {
        const contentContainer = document.getElementById('insight-content-dynamic');
        if (!contentContainer) return;
        
        let content = '';
        
        switch(category) {
          case 'grouping':
            content = `
              <div class="insight-section">
                <div class="insight-indicator blue"></div>
                <div class="insight-title">×§×™×‘×•×¥ × ×•×©××™×</div>
                <div class="insight-content">
                  ×”×©×™×—×” ××ª××§×“×ª ×‘× ×•×©××™ ××©×¤×—×” ×•×ª×›× ×•×Ÿ ×¢×ª×™×“×™. ×–×•×”×• ×“×¤×•×¡×™ ×“×™×‘×•×¨ ×”××¦×‘×™×¢×™× ×¢×œ ×—×©×™×‘×•×ª ×”×§×©×¨×™× ×”××™×©×™×™×
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator green"></div>
                <div class="insight-title">×–×™×”×•×™ ×“×¤×•×¡×™×</div>
                <div class="insight-content">
                  × ××¦××• ×“×¤×•×¡×™ ×ª×§×©×•×¨×ª ×—×•×–×¨×™× ×”×§×©×•×¨×™× ×œ×§×‘×œ×ª ×”×—×œ×˜×•×ª ××©×•×ª×¤×•×ª ×•×ª×›× ×•×Ÿ ×œ×˜×•×•×— ××¨×•×š
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator purple"></div>
                <div class="insight-title">×§×˜×’×•×¨×™×–×¦×™×”</div>
                <div class="insight-content">
                  ×”×©×™×—×” × ×›×œ×œ×ª ×‘×§×˜×’×•×¨×™×™×ª "×“×™×•× ×™× ××©×¤×—×ª×™×™×" ×¢× ×“×’×© ×¢×œ ×©×™×ª×•×£ ×¤×¢×•×œ×” ×•×‘× ×™×™×ª ×§×•× ×¡× ×–×•×¡
                </div>
              </div>
            `;
            break;
            
          case 'recommendation':
            content = `
              <div class="insight-section">
                <div class="insight-indicator blue"></div>
                <div class="insight-title">×”××œ×¦×•×ª ×ª×§×©×•×¨×ª</div>
                <div class="insight-content">
                  ××•××œ×¥ ×œ×”×•×¡×™×£ ×™×•×ª×¨ ×©××œ×•×ª ×¤×ª×•×—×•×ª ×›×“×™ ×œ×¢×•×“×“ ×“×™×•×Ÿ ××¢××™×§ ×™×•×ª×¨ ×•×œ×—×©×•×£ × ×§×•×“×•×ª ××‘×˜ × ×•×¡×¤×•×ª
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator green"></div>
                <div class="insight-title">×©×™×¤×•×¨ ×“×™× ××™×§×”</div>
                <div class="insight-content">
                  ×›×“××™ ×œ×”××˜ ××ª ×§×¦×‘ ×”×©×™×—×” ×•×œ×ª×ª ××§×•× ×œ×¨×’×¢×™ ×©×§×˜ ×”×××¤×©×¨×™× ×¢×™×‘×•×“ ×•×”×ª×‘×•× × ×•×ª ×¢×œ ×”× ×××¨
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator purple"></div>
                <div class="insight-title">×¦×¢×“×™× ×”×‘××™×</div>
                <div class="insight-content">
                  ××•××œ×¥ ×œ×§×™×™× ××¢×§×‘ ×œ×ª×•×¦××•×ª ×”×©×™×—×” ×•×œ×•×•×“× ×™×™×©×•× ×”×”×—×œ×˜×•×ª ×©×”×ª×§×‘×œ×• ×‘×“×™×•×Ÿ
                </div>
              </div>
            `;
            break;
            
          case 'emotion':
            content = `
              <div class="insight-section">
                <div class="insight-indicator blue"></div>
                <div class="insight-title">××¤×ª ×¨×’×©×•×ª</div>
                <div class="insight-content">
                  ×–×•×”×• ×¨×’×©×•×ª ×—×™×•×‘×™×™× ×©×œ ×—××œ×” ×•××›×¤×ª×™×•×ª, ×œ×¦×“ ××ª×— ×§×œ ×”×§×©×•×¨ ×œ××™-×•×“××•×ª ×œ×’×‘×™ ×”×¢×ª×™×“
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator green"></div>
                <div class="insight-title">×¢×•×¦××ª ×¨×’×©×™×ª</div>
                <div class="insight-content">
                  ×”×©×™×—×” ××ª××¤×™×™× ×ª ×‘×¨××ª ×¨×’×© ×‘×™× ×•× ×™×ª ×¢× ×©×™××™× ×¨×’×©×™×™× ×‘×¢×ª ×“×™×•×Ÿ ×‘× ×•×©××™× ××™×©×™×™×
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator purple"></div>
                <div class="insight-title">××™×–×•×Ÿ ×¨×’×©×™</div>
                <div class="insight-content">
                  × ××¦× ××™×–×•×Ÿ ×˜×•×‘ ×‘×™×Ÿ ×¨×’×©×•×ª ×—×™×•×‘×™×™× ×œ×©×œ×™×œ×™×™×, ×”××¢×™×“ ×¢×œ ×“×™×•×Ÿ ×‘×¨×™× ×•×‘×•× ×”
                </div>
              </div>
            `;
            break;
            
          case 'engaging':
          default:
            content = `
              <div class="insight-section">
                <div class="insight-indicator blue"></div>
                <div class="insight-title">×“×™×¨×•×’ ×”×‘×™×˜×—×•×Ÿ ×©×œ×™</div>
                <div class="insight-content">
                  ×× ×™ × ×•×˜×” ×œ×§×‘×œ ××ª ×¢×¦××™ ×‘×¦×•×¨×ª ×”×™×‘×˜×™× ×•××•×¤×˜×™××™×•×ª, ×—×™×” ×©×•×•×” ×œ×¦×•×¨×š ××–×¨×—×™×” ×˜×•×‘×” ×‘×™×•×ª×¨ ×‘×©×™×¨×•×ª
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator green"></div>
                <div class="insight-title">×“×™×¨×•×’ ×”×‘×™×˜×—×•×Ÿ ×©×œ×™</div>
                <div class="insight-content">
                  ×× ×™ ××©×ª×ª×£ ×‘×¤×¢×™×œ×•×ª ×‘×©×™×—×•×ª ×•×ª×•×¨××™× ×œ×“×™×•×Ÿ, ×‘×“×¨×š ×œ×”××©×™×š ×œ×˜××•×¨ ×¢×œ ×“×‘×¨×™ ×¢××“×•×ª×™×”× ×–×”
                </div>
              </div>
              
              <div class="insight-section">
                <div class="insight-indicator purple"></div>
                <div class="insight-title">×”××¦×‘ ×•×”×–×“×× ×•×™×•×ª</div>
                <div class="insight-content">
                  ×‘×©×™×—×•×ª ××™×©×™×•×ª ×× ×™ ×™×›×•×œ ×œ×—×–×•×¨ ×©×”×Ÿ. ×‘×¢×“×Ÿ ×œ×”×¢×‘×™×¨ ××ª ×”×›×™×•×•×Ÿ ×”×“× ×’× ×œ×˜×•×•×ª×™ ×§×•×•×¦×•×ª
                </div>
              </div>
            `;
            break;
        }
        
        contentContainer.innerHTML = content;
      }
      
      // Handle URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      
      // Check if this is a simplified preview
      if (urlParams.get('simplified') === 'true') {
        // Don't initialize full p5.js for simplified preview
        console.log('Simplified preview mode - skipping full initialization');
        
        // Just show a simple static preview
        const container = document.getElementById('visualization-canvas-container');
        if (container) {
          container.innerHTML = `
            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f7f9f3;">
              <canvas id="simple-preview-canvas" style="width: 100%; height: 100%;"></canvas>
            </div>
          `;
          
          // Create a simple static visualization
          setTimeout(() => {
            const canvas = document.getElementById('simple-preview-canvas');
            if (canvas) {
              const ctx = canvas.getContext('2d');
              const rect = canvas.getBoundingClientRect();
              canvas.width = rect.width;
              canvas.height = rect.height;
              
              // Draw simple blobs
              ctx.fillStyle = '#f7f9f3';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              
              // Draw two simple circles as blobs (using stroke instead of fill)
              const centerY = canvas.height / 2;
              const blob1X = canvas.width * 0.3;
              const blob2X = canvas.width * 0.7;
              const blobRadius = Math.min(canvas.width, canvas.height) * 0.15;
              
              ctx.strokeStyle = '#cccccc';
              ctx.lineWidth = 2;
              
              // Blob 1
              ctx.beginPath();
              ctx.arc(blob1X, centerY, blobRadius, 0, Math.PI * 2);
              ctx.stroke();
              
              // Blob 2
              ctx.beginPath();
              ctx.arc(blob2X, centerY, blobRadius * 0.8, 0, Math.PI * 2);
              ctx.stroke();
              
              // Add some text
              ctx.fillStyle = '#666';
              ctx.font = '12px Arial';
              ctx.textAlign = 'center';
              ctx.fillText('×ª×¦×•×’×” ××§×“×™××”', canvas.width / 2, canvas.height - 20);
            }
          }, 100);
        }
        
        return; // Don't continue with full initialization
      }
      
      // Normal initialization continues here
      
      // Notify parent window that visualization is ready (for control panel)
      if (urlParams.get('controlPanel') === 'true' && window.parent !== window) {
        setTimeout(() => {
          window.parent.postMessage({
            type: 'visualizationReady',
            message: 'Visualization iframe loaded'
          }, '*');
        }, 1000);
      }
      
      // Handle focus file mode
      if (urlParams.get('focusFile') === 'true') {
        const focusedFile = urlParams.get('file');
        const shouldLoop = urlParams.get('loop') === 'true';
        
        // Set loop mode
        window.isLoopMode = shouldLoop;
        
        // Store focused file for sketch to use
        window.focusedMP3File = focusedFile;
        
        console.log('Focus file mode enabled:', {
          file: focusedFile,
          loop: shouldLoop
        });
      }

      // Change "×ª×•×‘× ×•×ª ××¤×ª×—" to "×ª×•×‘× ×•×ª" in main tab titles
      document.addEventListener('DOMContentLoaded', function() {
        // Change all instances of "×ª×•×‘× ×•×ª ××¤×ª×—" to "×ª×•×‘× ×•×ª"
        function replaceText() {
          const allElements = document.querySelectorAll('*');
          allElements.forEach(function(element) {
            if (element.childNodes.length === 1 && element.childNodes[0].nodeType === Node.TEXT_NODE) {
              if (element.textContent.includes('×ª×•×‘× ×•×ª ××¤×ª×—')) {
                element.textContent = element.textContent.replace('×ª×•×‘× ×•×ª ××¤×ª×—', '×ª×•×‘× ×•×ª');
              }
            }
          });
        }
        
        // Run immediately and also after a short delay to catch dynamic content
        replaceText();
        setTimeout(replaceText, 100);
        setTimeout(replaceText, 500);
      });
    });
      </script>
  </body>
</html>